/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { AkitaUpdateIdKeyError, assertEntityExists, assertEntityState } from './error';
import { entityExists, isFunction, isPlainObject, resetActive } from './utils';
var CRUD = /** @class */ (function () {
    function CRUD() {
    }
    /**
     * @template S, E
     * @param {?} state
     * @param {?} entities
     * @param {?} entityClass
     * @param {?} idKey
     * @return {?}
     */
    CRUD.prototype._set = /**
     * @template S, E
     * @param {?} state
     * @param {?} entities
     * @param {?} entityClass
     * @param {?} idKey
     * @return {?}
     */
    function (state, entities, entityClass, idKey) {
        /** @type {?} */
        var ids;
        /** @type {?} */
        var normalized;
        if ((/** @type {?} */ (entities)).ids && (/** @type {?} */ (entities)).entities) {
            ids = (/** @type {?} */ (entities)).ids;
            normalized = (/** @type {?} */ (entities)).entities;
        }
        else {
            /** @type {?} */
            var isArray = Array.isArray(entities);
            normalized = entities;
            if (isArray) {
                normalized = /** @type {?} */ (this.keyBy(/** @type {?} */ (entities), entityClass, idKey));
            }
            else {
                assertEntityState(entities);
            }
            ids = isArray ? (/** @type {?} */ (entities)).map(function (entity) { return entity[idKey]; }) : Object.keys(/** @type {?} */ (normalized)).map(function (id) { return entities[id][idKey]; });
        }
        /** @type {?} */
        var newState = tslib_1.__assign({}, (/** @type {?} */ (state)), { entities: normalized, ids: ids, loading: false });
        if (resetActive(newState)) {
            newState.active = null;
        }
        return newState;
    };
    /**
     * @template T
     * @param {?} state
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    CRUD.prototype._replaceEntity = /**
     * @template T
     * @param {?} state
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    function (state, id, entity) {
        var _a;
        return tslib_1.__assign({}, (/** @type {?} */ (state)), { entities: tslib_1.__assign({}, state.entities, (_a = {}, _a[id] = entity, _a)) });
    };
    /**
     * @template S, E
     * @param {?} state
     * @param {?} entities
     * @param {?} idKey
     * @return {?}
     */
    CRUD.prototype._add = /**
     * @template S, E
     * @param {?} state
     * @param {?} entities
     * @param {?} idKey
     * @return {?}
     */
    function (state, entities, idKey) {
        /** @type {?} */
        var addedEntities = {};
        /** @type {?} */
        var addedIds = [];
        for (var i = 0; i < entities.length; i++) {
            /** @type {?} */
            var entity = entities[i];
            /** @type {?} */
            var entityId = entity[idKey];
            if (!entityExists(entityId, state.entities)) {
                addedEntities[entityId] = entity;
                addedIds.push(entityId);
            }
        }
        return tslib_1.__assign({}, (/** @type {?} */ (state)), { entities: tslib_1.__assign({}, state.entities, addedEntities), ids: tslib_1.__spread(state.ids, addedIds) });
    };
    /**
     * @template T
     * @param {?} state
     * @param {?} ids
     * @param {?} newStateOrFn
     * @param {?} idKey
     * @return {?}
     */
    CRUD.prototype._update = /**
     * @template T
     * @param {?} state
     * @param {?} ids
     * @param {?} newStateOrFn
     * @param {?} idKey
     * @return {?}
     */
    function (state, ids, newStateOrFn, idKey) {
        /** @type {?} */
        var updatedEntities = {};
        /** @type {?} */
        var isUpdatingIdKey = false;
        /** @type {?} */
        var idToUpdate;
        for (var i = 0; i < ids.length; i++) {
            /** @type {?} */
            var id = ids[i];
            idToUpdate = id;
            assertEntityExists(id, state.entities);
            /** @type {?} */
            var oldEntity = state.entities[id];
            /** @type {?} */
            var newState = isFunction(newStateOrFn) ? newStateOrFn(oldEntity) : newStateOrFn;
            if (newState.hasOwnProperty(idKey) && newState[idKey] !== oldEntity[idKey]) {
                if (ids.length > 1) {
                    throw new AkitaUpdateIdKeyError();
                }
                isUpdatingIdKey = true;
                idToUpdate = newState[idKey];
            }
            /** @type {?} */
            var newEntity = void 0;
            /** @type {?} */
            var merged = tslib_1.__assign({}, oldEntity, newState);
            if (isPlainObject(oldEntity)) {
                newEntity = merged;
            }
            else {
                newEntity = new oldEntity.constructor(merged);
            }
            updatedEntities[idToUpdate] = newEntity;
        }
        /** @type {?} */
        var updatedIds = state.ids;
        /** @type {?} */
        var stateEntities = state.entities;
        if (isUpdatingIdKey) {
            var _a = tslib_1.__read(ids, 1), id_1 = _a[0];
            var _b = state.entities, _c = id_1, deletedEntity = _b[_c], rest = tslib_1.__rest(_b, [typeof _c === "symbol" ? _c : _c + ""]);
            stateEntities = rest;
            updatedIds = state.ids.map(function (current) { return (current === id_1 ? idToUpdate : current); });
        }
        return tslib_1.__assign({}, (/** @type {?} */ (state)), { entities: tslib_1.__assign({}, stateEntities, updatedEntities), ids: updatedIds });
    };
    /**
     * @template T
     * @param {?} state
     * @param {?} ids
     * @return {?}
     */
    CRUD.prototype._remove = /**
     * @template T
     * @param {?} state
     * @param {?} ids
     * @return {?}
     */
    function (state, ids) {
        if (!ids)
            return this._removeAll(state);
        /** @type {?} */
        var removed = ids.reduce(function (acc, id) {
            var _a = id, entity = acc[_a], rest = tslib_1.__rest(acc, [typeof _a === "symbol" ? _a : _a + ""]);
            return rest;
        }, state.entities);
        /** @type {?} */
        var newState = tslib_1.__assign({}, (/** @type {?} */ (state)), { entities: removed, ids: state.ids.filter(function (current) { return ids.indexOf(current) === -1; }) });
        if (resetActive(newState)) {
            newState.active = null;
        }
        return newState;
    };
    /**
     * @template T
     * @param {?} state
     * @return {?}
     */
    CRUD.prototype._removeAll = /**
     * @template T
     * @param {?} state
     * @return {?}
     */
    function (state) {
        /** @type {?} */
        var newState = tslib_1.__assign({}, (/** @type {?} */ (state)), { entities: {}, ids: [], active: null });
        return newState;
    };
    /**
     * @param {?} entities
     * @param {?=} entityClass
     * @param {?=} id
     * @return {?}
     */
    CRUD.prototype.keyBy = /**
     * @param {?} entities
     * @param {?=} entityClass
     * @param {?=} id
     * @return {?}
     */
    function (entities, entityClass, id) {
        if (id === void 0) { id = 'id'; }
        /** @type {?} */
        var acc = {};
        for (var i = 0, len = entities.length; i < len; i++) {
            /** @type {?} */
            var entity = entities[i];
            acc[entity[id]] = entityClass ? new entityClass(entity) : entity;
        }
        return acc;
    };
    return CRUD;
}());
export { CRUD };
/** @type {?} */
export var _crud = new CRUD();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J1ZC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkYXRvcmFtYS9ha2l0YS8iLCJzb3VyY2VzIjpbInNyYy9pbnRlcm5hbC9jcnVkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLHFCQUFxQixFQUFFLGtCQUFrQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFL0UsSUFBQTs7Ozs7Ozs7Ozs7SUFDRSxtQkFBSTs7Ozs7Ozs7SUFBSixVQUFXLEtBQVEsRUFBRSxRQUF3QyxFQUFFLFdBQXVCLEVBQUUsS0FBSzs7UUFDM0YsSUFBSSxHQUFHLENBQWE7O1FBQXBCLElBQVMsVUFBVSxDQUFDO1FBRXBCLElBQUksbUJBQUMsUUFBdUIsRUFBQyxDQUFDLEdBQUcsSUFBSSxtQkFBQyxRQUF1QixFQUFDLENBQUMsUUFBUSxFQUFFO1lBQ3ZFLEdBQUcsR0FBRyxtQkFBQyxRQUF1QixFQUFDLENBQUMsR0FBRyxDQUFDO1lBQ3BDLFVBQVUsR0FBRyxtQkFBQyxRQUF1QixFQUFDLENBQUMsUUFBUSxDQUFDO1NBQ2pEO2FBQU07O1lBQ0wsSUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN4QyxVQUFVLEdBQUcsUUFBUSxDQUFDO1lBRXRCLElBQUksT0FBTyxFQUFFO2dCQUNYLFVBQVUscUJBQUcsSUFBSSxDQUFDLEtBQUssbUJBQUMsUUFBZSxHQUFFLFdBQVcsRUFBRSxLQUFLLENBQVEsQ0FBQSxDQUFDO2FBQ3JFO2lCQUFNO2dCQUNMLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzdCO1lBRUQsR0FBRyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsbUJBQUMsUUFBZSxFQUFDLENBQUMsR0FBRyxDQUFDLFVBQUEsTUFBTSxJQUFJLE9BQUEsTUFB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QUMsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7U0FDbEU7UUFFRCxPQUFPLEdBQUcsQ0FBQzs7ZUF4S2Y7SUEwS0MsQ0FBQTtBQXRLRCxnQkFzS0M7O0FBRUQsV0FBYSxLQUFLLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVudGl0aWVzLCBFbnRpdHlTdGF0ZSwgSGFzaE1hcCwgSUQsIE5ld2FibGUgfSBmcm9tICcuLi9hcGkvdHlwZXMnO1xuaW1wb3J0IHsgQWtpdGFVcGRhdGVJZEtleUVycm9yLCBhc3NlcnRFbnRpdHlFeGlzdHMsIGFzc2VydEVudGl0eVN0YXRlIH0gZnJvbSAnLi9lcnJvcic7XG5pbXBvcnQgeyBlbnRpdHlFeGlzdHMsIGlzRnVuY3Rpb24sIGlzUGxhaW5PYmplY3QsIHJlc2V0QWN0aXZlIH0gZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCBjbGFzcyBDUlVEIHtcbiAgX3NldDxTLCBFPihzdGF0ZTogUywgZW50aXRpZXM6IEVbXSB8IEhhc2hNYXA8RT4gfCBFbnRpdGllczxFPiwgZW50aXR5Q2xhc3M6IE5ld2FibGU8RT4sIGlkS2V5KTogUyB7XG4gICAgbGV0IGlkcywgbm9ybWFsaXplZDtcblxuICAgIGlmICgoZW50aXRpZXMgYXMgRW50aXRpZXM8RT4pLmlkcyAmJiAoZW50aXRpZXMgYXMgRW50aXRpZXM8RT4pLmVudGl0aWVzKSB7XG4gICAgICBpZHMgPSAoZW50aXRpZXMgYXMgRW50aXRpZXM8RT4pLmlkcztcbiAgICAgIG5vcm1hbGl6ZWQgPSAoZW50aXRpZXMgYXMgRW50aXRpZXM8RT4pLmVudGl0aWVzO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBpc0FycmF5ID0gQXJyYXkuaXNBcnJheShlbnRpdGllcyk7XG4gICAgICBub3JtYWxpemVkID0gZW50aXRpZXM7XG5cbiAgICAgIGlmIChpc0FycmF5KSB7XG4gICAgICAgIG5vcm1hbGl6ZWQgPSB0aGlzLmtleUJ5KGVudGl0aWVzIGFzIEVbXSwgZW50aXR5Q2xhc3MsIGlkS2V5KSBhcyBFW107XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhc3NlcnRFbnRpdHlTdGF0ZShlbnRpdGllcyk7XG4gICAgICB9XG5cbiAgICAgIGlkcyA9IGlzQXJyYXkgPyAoZW50aXRpZXMgYXMgRVtdKS5tYXAoZW50aXR5ID0+IGVudGl0eVtpZEtleV0pIDogT2JqZWN0LmtleXMobm9ybWFsaXplZCBhcyBIYXNoTWFwPEU+KS5tYXAoaWQgPT4gZW50aXRpZXNbaWRdW2lkS2V5XSk7XG4gICAgfVxuXG4gICAgY29uc3QgbmV3U3RhdGUgPSB7XG4gICAgICAuLi4oc3RhdGUgYXMgYW55KSxcbiAgICAgIGVudGl0aWVzOiBub3JtYWxpemVkLFxuICAgICAgaWRzLFxuICAgICAgbG9hZGluZzogZmFsc2VcbiAgICB9O1xuXG4gICAgaWYgKHJlc2V0QWN0aXZlKG5ld1N0YXRlKSkge1xuICAgICAgbmV3U3RhdGUuYWN0aXZlID0gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3U3RhdGU7XG4gIH1cblxuICBfcmVwbGFjZUVudGl0eTxUIGV4dGVuZHMgRW50aXR5U3RhdGU+KHN0YXRlOiBULCBpZDogSUQsIGVudGl0eSk6IFQge1xuICAgIHJldHVybiB7XG4gICAgICAuLi4oc3RhdGUgYXMgYW55KSxcbiAgICAgIGVudGl0aWVzOiB7XG4gICAgICAgIC4uLnN0YXRlLmVudGl0aWVzLFxuICAgICAgICBbaWRdOiBlbnRpdHlcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgX2FkZDxTIGV4dGVuZHMgRW50aXR5U3RhdGUsIEU+KHN0YXRlOiBTLCBlbnRpdGllczogRVtdLCBpZEtleSk6IFMge1xuICAgIGxldCBhZGRlZEVudGl0aWVzID0ge307XG4gICAgbGV0IGFkZGVkSWRzID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudGl0aWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBlbnRpdHkgPSBlbnRpdGllc1tpXTtcbiAgICAgIGNvbnN0IGVudGl0eUlkID0gZW50aXR5W2lkS2V5XTtcblxuICAgICAgaWYgKCFlbnRpdHlFeGlzdHMoZW50aXR5SWQsIHN0YXRlLmVudGl0aWVzKSkge1xuICAgICAgICBhZGRlZEVudGl0aWVzW2VudGl0eUlkXSA9IGVudGl0eTtcbiAgICAgICAgYWRkZWRJZHMucHVzaChlbnRpdHlJZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLihzdGF0ZSBhcyBhbnkpLFxuICAgICAgZW50aXRpZXM6IHtcbiAgICAgICAgLi4uc3RhdGUuZW50aXRpZXMsXG4gICAgICAgIC4uLmFkZGVkRW50aXRpZXNcbiAgICAgIH0sXG4gICAgICBpZHM6IFsuLi5zdGF0ZS5pZHMsIC4uLmFkZGVkSWRzXVxuICAgIH07XG4gIH1cblxuICBfdXBkYXRlPFQgZXh0ZW5kcyBFbnRpdHlTdGF0ZT4oc3RhdGU6IFQsIGlkczogSURbXSwgbmV3U3RhdGVPckZuOiBvYmplY3QgfCAoKGU6IFJlYWRvbmx5PGFueT4pID0+IG9iamVjdCksIGlkS2V5OiBzdHJpbmcpOiBUIHtcbiAgICBjb25zdCB1cGRhdGVkRW50aXRpZXMgPSB7fTtcblxuICAgIGxldCBpc1VwZGF0aW5nSWRLZXkgPSBmYWxzZTtcbiAgICBsZXQgaWRUb1VwZGF0ZTogSUQ7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlkcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaWQgPSBpZHNbaV07XG4gICAgICBpZFRvVXBkYXRlID0gaWQ7XG4gICAgICBhc3NlcnRFbnRpdHlFeGlzdHMoaWQsIHN0YXRlLmVudGl0aWVzKTtcblxuICAgICAgY29uc3Qgb2xkRW50aXR5ID0gc3RhdGUuZW50aXRpZXNbaWRdO1xuICAgICAgY29uc3QgbmV3U3RhdGUgPSBpc0Z1bmN0aW9uKG5ld1N0YXRlT3JGbikgPyBuZXdTdGF0ZU9yRm4ob2xkRW50aXR5KSA6IG5ld1N0YXRlT3JGbjtcblxuICAgICAgaWYgKG5ld1N0YXRlLmhhc093blByb3BlcnR5KGlkS2V5KSAmJiBuZXdTdGF0ZVtpZEtleV0gIT09IG9sZEVudGl0eVtpZEtleV0pIHtcbiAgICAgICAgaWYgKGlkcy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEFraXRhVXBkYXRlSWRLZXlFcnJvcigpO1xuICAgICAgICB9XG4gICAgICAgIGlzVXBkYXRpbmdJZEtleSA9IHRydWU7XG4gICAgICAgIGlkVG9VcGRhdGUgPSBuZXdTdGF0ZVtpZEtleV07XG4gICAgICB9XG5cbiAgICAgIGxldCBuZXdFbnRpdHk7XG5cbiAgICAgIGNvbnN0IG1lcmdlZCA9IHtcbiAgICAgICAgLi4ub2xkRW50aXR5LFxuICAgICAgICAuLi5uZXdTdGF0ZVxuICAgICAgfTtcblxuICAgICAgaWYgKGlzUGxhaW5PYmplY3Qob2xkRW50aXR5KSkge1xuICAgICAgICBuZXdFbnRpdHkgPSBtZXJnZWQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXdFbnRpdHkgPSBuZXcgb2xkRW50aXR5LmNvbnN0cnVjdG9yKG1lcmdlZCk7XG4gICAgICB9XG5cbiAgICAgIHVwZGF0ZWRFbnRpdGllc1tpZFRvVXBkYXRlXSA9IG5ld0VudGl0eTtcbiAgICB9XG5cbiAgICBsZXQgdXBkYXRlZElkcyA9IHN0YXRlLmlkcztcbiAgICBsZXQgc3RhdGVFbnRpdGllcyA9IHN0YXRlLmVudGl0aWVzO1xuICAgIGlmIChpc1VwZGF0aW5nSWRLZXkpIHtcbiAgICAgIGNvbnN0IFtpZF0gPSBpZHM7XG4gICAgICBjb25zdCB7IFtpZF06IGRlbGV0ZWRFbnRpdHksIC4uLnJlc3QgfSA9IHN0YXRlLmVudGl0aWVzO1xuICAgICAgc3RhdGVFbnRpdGllcyA9IHJlc3Q7XG4gICAgICB1cGRhdGVkSWRzID0gc3RhdGUuaWRzLm1hcChjdXJyZW50ID0+IChjdXJyZW50ID09PSBpZCA/IGlkVG9VcGRhdGUgOiBjdXJyZW50KSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLihzdGF0ZSBhcyBhbnkpLFxuICAgICAgZW50aXRpZXM6IHtcbiAgICAgICAgLi4uc3RhdGVFbnRpdGllcyxcbiAgICAgICAgLi4udXBkYXRlZEVudGl0aWVzXG4gICAgICB9LFxuICAgICAgaWRzOiB1cGRhdGVkSWRzXG4gICAgfTtcbiAgfVxuXG4gIF9yZW1vdmU8VCBleHRlbmRzIEVudGl0eVN0YXRlPihzdGF0ZTogVCwgaWRzOiBJRFtdIHwgbnVsbCk6IFQge1xuICAgIGlmICghaWRzKSByZXR1cm4gdGhpcy5fcmVtb3ZlQWxsKHN0YXRlKTtcblxuICAgIGNvbnN0IHJlbW92ZWQgPSBpZHMucmVkdWNlKChhY2MsIGlkKSA9PiB7XG4gICAgICBjb25zdCB7IFtpZF06IGVudGl0eSwgLi4ucmVzdCB9ID0gYWNjO1xuICAgICAgcmV0dXJuIHJlc3Q7XG4gICAgfSwgc3RhdGUuZW50aXRpZXMpO1xuICAgIGNvbnN0IG5ld1N0YXRlID0ge1xuICAgICAgLi4uKHN0YXRlIGFzIGFueSksXG4gICAgICBlbnRpdGllczogcmVtb3ZlZCxcbiAgICAgIGlkczogc3RhdGUuaWRzLmZpbHRlcihjdXJyZW50ID0+IGlkcy5pbmRleE9mKGN1cnJlbnQpID09PSAtMSlcbiAgICB9O1xuXG4gICAgaWYgKHJlc2V0QWN0aXZlKG5ld1N0YXRlKSkge1xuICAgICAgbmV3U3RhdGUuYWN0aXZlID0gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3U3RhdGU7XG4gIH1cblxuICBwcml2YXRlIF9yZW1vdmVBbGw8VCBleHRlbmRzIEVudGl0eVN0YXRlPihzdGF0ZTogVCk6IFQge1xuICAgIGNvbnN0IG5ld1N0YXRlID0ge1xuICAgICAgLi4uKHN0YXRlIGFzIGFueSksXG4gICAgICBlbnRpdGllczoge30sXG4gICAgICBpZHM6IFtdLFxuICAgICAgYWN0aXZlOiBudWxsXG4gICAgfTtcblxuICAgIHJldHVybiBuZXdTdGF0ZTtcbiAgfVxuXG4gIHByaXZhdGUga2V5QnkoZW50aXRpZXM6IGFueVtdLCBlbnRpdHlDbGFzcz86IE5ld2FibGU8YW55PiwgaWQgPSAnaWQnKSB7XG4gICAgY29uc3QgYWNjID0ge307XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gZW50aXRpZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgIGNvbnN0IGVudGl0eSA9IGVudGl0aWVzW2ldO1xuICAgICAgYWNjW2VudGl0eVtpZF1dID0gZW50aXR5Q2xhc3MgPyBuZXcgZW50aXR5Q2xhc3MoZW50aXR5KSA6IGVudGl0eTtcbiAgICB9XG5cbiAgICByZXR1cm4gYWNjO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBfY3J1ZCA9IG5ldyBDUlVEKCk7XG4iXX0=