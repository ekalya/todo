/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { combineLatest } from 'rxjs';
import { auditTime, map, switchMap, withLatestFrom } from 'rxjs/operators';
import { compareValues } from '../internal/sort';
import { entityExists, isFunction, isUndefined, toBoolean } from '../internal/utils';
import { memoizeOne } from './memoize';
import { Query } from './query';
/**
 * @record
 * @template E
 */
export function SelectOptions() { }
function SelectOptions_tsickle_Closure_declarations() {
    /** @type {?|undefined} */
    SelectOptions.prototype.asObject;
    /** @type {?|undefined} */
    SelectOptions.prototype.filterBy;
    /** @type {?|undefined} */
    SelectOptions.prototype.limitTo;
}
// unsupported: template constraints.
/**
 *  An abstraction for querying the entities from the store
 * @template S, E
 */
var 
// unsupported: template constraints.
/**
 *  An abstraction for querying the entities from the store
 * @template S, E
 */
QueryEntity = /** @class */ (function (_super) {
    tslib_1.__extends(QueryEntity, _super);
    function QueryEntity(store) {
        var _this = _super.call(this, store) || this;
        _this.__store__ = store;
        return _this;
    }
    /**
     * @param {?=} options
     * @return {?}
     */
    QueryEntity.prototype.selectAll = /**
     * @param {?=} options
     * @return {?}
     */
    function (options) {
        var _this = this;
        if (options === void 0) { options = {
            asObject: false
        }; }
        /** @type {?} */
        var selectState$ = this.select(function (state) { return state; });
        /** @type {?} */
        var selectEntities$ = this.select(function (state) { return state.entities; });
        options.sortBy = options.sortBy || (this.config && (/** @type {?} */ (this.config.sortBy)));
        options.sortByOrder = options.sortByOrder || (this.config && this.config.sortByOrder);
        return selectEntities$.pipe(withLatestFrom(selectState$, function (entities, state) {
            var ids = state.ids;
            if (options.asObject) {
                return toMap(ids, entities, options);
            }
            else {
                if (!options.filterBy && !options.sortBy) {
                    if (!_this.memoized) {
                        _this.memoized = memoizeOne(toArray);
                    }
                    return _this.memoized(state, options);
                }
                return toArray(state, options);
            }
        }));
    };
    /**
     * @param {?=} options
     * @return {?}
     */
    QueryEntity.prototype.getAll = /**
     * @param {?=} options
     * @return {?}
     */
    function (options) {
        if (options === void 0) { options = { asObject: false, filterBy: undefined, limitTo: undefined }; }
        /** @type {?} */
        var state = this.getSnapshot();
        if (options.asObject) {
            return toMap(state.ids, state.entities, options, true);
        }
        return toArray(state, options);
    };
    /**
     * Select multiple entities from the store.
     *
     * @example
     * this.store.selectMany([1,2]);
     */
    /**
     * Select multiple entities from the store.
     *
     * \@example
     * this.store.selectMany([1,2]);
     * @param {?} ids
     * @param {?=} options
     * @return {?}
     */
    QueryEntity.prototype.selectMany = /**
     * Select multiple entities from the store.
     *
     * \@example
     * this.store.selectMany([1,2]);
     * @param {?} ids
     * @param {?=} options
     * @return {?}
     */
    function (ids, options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var filterUndefined = isUndefined(options.filterUndefined) ? true : options.filterUndefined;
        /** @type {?} */
        var entities = ids.map(function (id) { return _this.selectEntity(id); });
        return combineLatest(entities).pipe(map(function (entities) {
            return filterUndefined ? entities.filter(function (val) { return !isUndefined(val); }) : entities;
        }), auditTime(0));
    };
    /**
     * @template R
     * @param {?} id
     * @param {?=} project
     * @return {?}
     */
    QueryEntity.prototype.selectEntity = /**
     * @template R
     * @param {?} id
     * @param {?=} project
     * @return {?}
     */
    function (id, project) {
        var _this = this;
        if (!project) {
            return this._byId(id);
        }
        return this.select(function (state) {
            if (_this.hasEntity(id)) {
                return project(_this.getEntity(id));
            }
            return undefined;
        });
    };
    /**
     * Get an entity by id
     *
     * @example
     * this.store.getEntity(1);
     */
    /**
     * Get an entity by id
     *
     * \@example
     * this.store.getEntity(1);
     * @param {?} id
     * @return {?}
     */
    QueryEntity.prototype.getEntity = /**
     * Get an entity by id
     *
     * \@example
     * this.store.getEntity(1);
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return this.getSnapshot().entities[id];
    };
    /**
     * Select the active entity's id.
     */
    /**
     * Select the active entity's id.
     * @return {?}
     */
    QueryEntity.prototype.selectActiveId = /**
     * Select the active entity's id.
     * @return {?}
     */
    function () {
        return this.select(function (state) { return (/** @type {?} */ (state)).active; });
    };
    /**
     * Get the active id
     */
    /**
     * Get the active id
     * @return {?}
     */
    QueryEntity.prototype.getActiveId = /**
     * Get the active id
     * @return {?}
     */
    function () {
        return (/** @type {?} */ (this.getSnapshot())).active;
    };
    /**
     * @template R
     * @param {?=} project
     * @return {?}
     */
    QueryEntity.prototype.selectActive = /**
     * @template R
     * @param {?=} project
     * @return {?}
     */
    function (project) {
        var _this = this;
        return this.selectActiveId().pipe(switchMap(function (activeId) { return _this.selectEntity(activeId, project); }));
    };
    /**
     * Get the active entity.
     */
    /**
     * Get the active entity.
     * @return {?}
     */
    QueryEntity.prototype.getActive = /**
     * Get the active entity.
     * @return {?}
     */
    function () {
        /** @type {?} */
        var activeId = this.getActiveId();
        return toBoolean(activeId) ? this.getEntity(activeId) : undefined;
    };
    /**
     * Select the store's entity collection length.
     */
    /**
     * Select the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    QueryEntity.prototype.selectCount = /**
     * Select the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    function (predicate) {
        if (isFunction(predicate)) {
            return this.selectAll({
                filterBy: predicate
            }).pipe(map(function (entities) { return entities.length; }));
        }
        return this.select(function (store) { return store.ids.length; });
    };
    /**
     * Get the store's entity collection length.
     */
    /**
     * Get the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    QueryEntity.prototype.getCount = /**
     * Get the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    function (predicate) {
        if (isFunction(predicate)) {
            return this.getAll().filter(predicate).length;
        }
        return this.getSnapshot().ids.length;
    };
    /**
     * @param {?} projectOrId
     * @return {?}
     */
    QueryEntity.prototype.hasEntity = /**
     * @param {?} projectOrId
     * @return {?}
     */
    function (projectOrId) {
        if (isFunction(projectOrId)) {
            return this.getAll().some(projectOrId);
        }
        return projectOrId in this.store.entities;
    };
    /**
     * @return {?}
     */
    QueryEntity.prototype.isEmpty = /**
     * @return {?}
     */
    function () {
        return this.getSnapshot().ids.length === 0;
    };
    /**
     * @param {?} id
     * @return {?}
     */
    QueryEntity.prototype._byId = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        var _this = this;
        return this.select(function (state) { return _this.getEntity(id); });
    };
    /**
     * @return {?}
     */
    QueryEntity.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.memoized = null;
    };
    return QueryEntity;
}(Query));
// unsupported: template constraints.
/**
 *  An abstraction for querying the entities from the store
 * @template S, E
 */
export { QueryEntity };
function QueryEntity_tsickle_Closure_declarations() {
    /** @type {?} */
    QueryEntity.prototype.store;
    /** @type {?} */
    QueryEntity.prototype.memoized;
    /**
     * Use only for internal plugins like Pagination - don't use this property *
     * @type {?}
     */
    QueryEntity.prototype.__store__;
}
/**
 * @template E, S
 * @param {?} state
 * @param {?} options
 * @return {?}
 */
function toArray(state, options) {
    /** @type {?} */
    var arr = [];
    var ids = state.ids, entities = state.entities;
    var filterBy = options.filterBy, limitTo = options.limitTo, sortBy = options.sortBy, sortByOrder = options.sortByOrder;
    for (var i = 0; i < ids.length; i++) {
        /** @type {?} */
        var id = ids[i];
        if (!entityExists(id, entities)) {
            continue;
        }
        if (!filterBy) {
            arr.push(entities[id]);
            continue;
        }
        if (filterBy(entities[id])) {
            arr.push(entities[id]);
        }
    }
    if (sortBy) {
        /** @type {?} */
        var _sortBy_1 = isFunction(sortBy) ? sortBy : compareValues(sortBy, sortByOrder);
        arr = arr.sort(function (a, b) { return _sortBy_1(a, b, state); });
    }
    /** @type {?} */
    var length = Math.min(limitTo || arr.length, arr.length);
    return length === arr.length ? arr : arr.slice(0, length);
}
/**
 * @template E
 * @param {?} ids
 * @param {?} entities
 * @param {?} options
 * @param {?=} get
 * @return {?}
 */
function toMap(ids, entities, options, get) {
    if (get === void 0) { get = false; }
    /** @type {?} */
    var map = {};
    var filterBy = options.filterBy, limitTo = options.limitTo;
    if (get && !filterBy && !limitTo) {
        return entities;
    }
    /** @type {?} */
    var length = Math.min(limitTo || ids.length, ids.length);
    if (filterBy && isUndefined(limitTo) === false) {
        /** @type {?} */
        var count = 0;
        for (var i = 0, length_1 = ids.length; i < length_1; i++) {
            if (count === limitTo)
                break;
            /** @type {?} */
            var id = ids[i];
            if (!entityExists(id, entities)) {
                continue;
            }
            if (filterBy(entities[id])) {
                map[id] = entities[id];
                count++;
            }
        }
    }
    else {
        for (var i = 0; i < length; i++) {
            /** @type {?} */
            var id = ids[i];
            if (!entityExists(id, entities)) {
                continue;
            }
            if (!filterBy) {
                map[id] = entities[id];
                continue;
            }
            if (toBoolean(filterBy(entities[id]))) {
                map[id] = entities[id];
            }
        }
    }
    return map;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktZW50aXR5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL2FwaS9xdWVyeS1lbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsYUFBYSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUzRSxPQUFPLEVBQUUsYUFBYSxFQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXJGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdkMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWFoQzs7Ozs7O0FBQUE7SUFBMkQsdUNBQVE7SUFPakUscUJBQVksS0FBd0I7UUFBcEMsWUFDRSxrQkFBTSxLQUFLLENBQUMsU0FFYjtRQURDLEtBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDOztLQUN4Qjs7Ozs7SUFjRCwrQkFBUzs7OztJQUFULFVBQ0UsT0FFQztRQUhILGlCQTRCQztRQTNCQyx3QkFBQSxFQUFBO1lBQ0UsUUFBUSxFQUFFLEtBQUs7U0FDaEI7O1FBRUQsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUssRUFBTCxDQUFLLENBQUMsQ0FBQzs7UUFDakQsSUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUssQ0FBQyxRQUFRLEVBQWQsQ0FBYyxDQUFDLENBQUM7UUFFN0QsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFB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QUNsQixJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUMsRUFBRTtnQkFDL0IsU0FBUzthQUNWO1lBQ0QsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUU7Z0JBQzFCLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3ZCLEtBQUssRUFBRSxDQUFDO2FBQ1Q7U0FDRjtLQUNGO1NBQU07UUFDTCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFOztZQUMvQixJQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFbEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLEVBQUUsUUFBUSxDQUFDLEVBQUU7Z0JBQy9CLFNBQVM7YUFDVjtZQUVELElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2IsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDdkIsU0FBUzthQUNWO1lBRUQsSUFBSSxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3JDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDeEI7U0FDRjtLQUNGO0lBRUQsT0FBTyxHQUFHLENBQUM7Q0FDWiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGF1ZGl0VGltZSwgbWFwLCBzd2l0Y2hNYXAsIHdpdGhMYXRlc3RGcm9tIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBjb21wYXJlVmFsdWVzLCBPcmRlciB9IGZyb20gJy4uL2ludGVybmFsL3NvcnQnO1xuaW1wb3J0IHsgZW50aXR5RXhpc3RzLCBpc0Z1bmN0aW9uLCBpc1VuZGVmaW5lZCwgdG9Cb29sZWFuIH0gZnJvbSAnLi4vaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHsgRW50aXR5U3RvcmUgfSBmcm9tICcuL2VudGl0eS1zdG9yZSc7XG5pbXBvcnQgeyBtZW1vaXplT25lIH0gZnJvbSAnLi9tZW1vaXplJztcbmltcG9ydCB7IFF1ZXJ5IH0gZnJvbSAnLi9xdWVyeSc7XG5pbXBvcnQgeyBTb3J0QnksIFNvcnRCeU9wdGlvbnMgfSBmcm9tICcuL3F1ZXJ5LWNvbmZpZyc7XG5pbXBvcnQgeyBBY3RpdmVTdGF0ZSwgRW50aXR5U3RhdGUsIEhhc2hNYXAsIElEIH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VsZWN0T3B0aW9uczxFPiBleHRlbmRzIFNvcnRCeU9wdGlvbnM8RT4ge1xuICBhc09iamVjdD86IGJvb2xlYW47XG4gIGZpbHRlckJ5PzogKChlbnRpdHk6IEUpID0+IGJvb2xlYW4pIHwgdW5kZWZpbmVkO1xuICBsaW1pdFRvPzogbnVtYmVyO1xufVxuXG4vKipcbiAqICBBbiBhYnN0cmFjdGlvbiBmb3IgcXVlcnlpbmcgdGhlIGVudGl0aWVzIGZyb20gdGhlIHN0b3JlXG4gKi9cbmV4cG9ydCBjbGFzcyBRdWVyeUVudGl0eTxTIGV4dGVuZHMgRW50aXR5U3RhdGUsIEU+IGV4dGVuZHMgUXVlcnk8Uz4ge1xuICBwcm90ZWN0ZWQgc3RvcmU6IEVudGl0eVN0b3JlPFMsIEU+O1xuICBwcml2YXRlIG1lbW9pemVkO1xuXG4gIC8qKiBVc2Ugb25seSBmb3IgaW50ZXJuYWwgcGx1Z2lucyBsaWtlIFBhZ2luYXRpb24gLSBkb24ndCB1c2UgdGhpcyBwcm9wZXJ0eSAqKi9cbiAgX19zdG9yZV9fO1xuXG4gIGNvbnN0cnVjdG9yKHN0b3JlOiBFbnRpdHlTdG9yZTxTLCBFPikge1xuICAgIHN1cGVyKHN0b3JlKTtcbiAgICB0aGlzLl9fc3RvcmVfXyA9IHN0b3JlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCB0aGUgZW50aXJlIHN0b3JlJ3MgZW50aXR5IGNvbGxlY3Rpb24uXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuc2VsZWN0QWxsKCk7XG4gICAqL1xuICBzZWxlY3RBbGwob3B0aW9uczogeyBhc09iamVjdDogdHJ1ZTsgZmlsdGVyQnk/OiBTZWxlY3RPcHRpb25zPEU+WydmaWx0ZXJCeSddOyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiB1bmRlZmluZWQ7IHNvcnRCeU9yZGVyPzogdW5kZWZpbmVkIH0pOiBPYnNlcnZhYmxlPEhhc2hNYXA8RT4+O1xuICBzZWxlY3RBbGwob3B0aW9uczogeyBmaWx0ZXJCeTogU2VsZWN0T3B0aW9uczxFPlsnZmlsdGVyQnknXTsgbGltaXRUbz86IG51bWJlcjsgc29ydEJ5PzogU29ydEJ5PEU+OyBzb3J0QnlPcmRlcj86IE9yZGVyIH0pOiBPYnNlcnZhYmxlPEVbXT47XG4gIHNlbGVjdEFsbChvcHRpb25zOiB7IGFzT2JqZWN0OiB0cnVlOyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiB1bmRlZmluZWQ7IHNvcnRCeU9yZGVyPzogdW5kZWZpbmVkIH0pOiBPYnNlcnZhYmxlPEhhc2hNYXA8RT4+O1xuICBzZWxlY3RBbGwob3B0aW9uczogeyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiBTb3J0Qnk8RT47IHNvcnRCeU9yZGVyPzogT3JkZXIgfSk6IE9ic2VydmFibGU8RVtdPjtcbiAgc2VsZWN0QWxsKG9wdGlvbnM6IHsgYXNPYmplY3Q6IGZhbHNlOyBmaWx0ZXJCeT86IFNlbGVjdE9wdGlvbnM8RT5bJ2ZpbHRlckJ5J107IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IFNvcnRCeTxFPjsgc29ydEJ5T3JkZXI/OiBPcmRlciB9KTogT2JzZXJ2YWJsZTxFW10+O1xuICBzZWxlY3RBbGwoKTogT2JzZXJ2YWJsZTxFW10+O1xuICBzZWxlY3RBbGwoXG4gICAgb3B0aW9uczogU2VsZWN0T3B0aW9uczxFPiA9IHtcbiAgICAgIGFzT2JqZWN0OiBmYWxzZVxuICAgIH1cbiAgKTogT2JzZXJ2YWJsZTxFW10gfCBIYXNoTWFwPEU+PiB7XG4gICAgY29uc3Qgc2VsZWN0U3RhdGUkID0gdGhpcy5zZWxlY3Qoc3RhdGUgPT4gc3RhdGUpO1xuICAgIGNvbnN0IHNlbGVjdEVudGl0aWVzJCA9IHRoaXMuc2VsZWN0KHN0YXRlID0+IHN0YXRlLmVudGl0aWVzKTtcblxuICAgIG9wdGlvbnMuc29ydEJ5ID0gb3B0aW9ucy5zb3J0QnkgfHwgKHRoaXMuY29uZmlnICYmICh0aGlzLmNvbmZpZy5zb3J0QnkgYXMgU29ydEJ5PEU+KSk7XG4gICAgb3B0aW9ucy5zb3J0QnlPcmRlciA9IG9wdGlvbnMuc29ydEJ5T3JkZXIgfHwgKHRoaXMuY29uZmlnICYmIHRoaXMuY29uZmlnLnNvcnRCeU9yZGVyKTtcblxuICAgIHJldHVybiBzZWxlY3RFbnRpdGllcyQucGlwZShcbiAgICAgIHdpdGhMYXRlc3RGcm9tKHNlbGVjdFN0YXRlJCwgKGVudGl0aWVzOiBIYXNoTWFwPEU+LCBzdGF0ZTogUykgPT4ge1xuICAgICAgICBjb25zdCB7IGlkcyB9ID0gc3RhdGU7XG4gICAgICAgIGlmIChvcHRpb25zLmFzT2JqZWN0KSB7XG4gICAgICAgICAgcmV0dXJuIHRvTWFwKGlkcywgZW50aXRpZXMsIG9wdGlvbnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICghb3B0aW9ucy5maWx0ZXJCeSAmJiAhb3B0aW9ucy5zb3J0QnkpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5tZW1vaXplZCkge1xuICAgICAgICAgICAgICB0aGlzLm1lbW9pemVkID0gbWVtb2l6ZU9uZSh0b0FycmF5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1lbW9pemVkKHN0YXRlLCBvcHRpb25zKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gdG9BcnJheShzdGF0ZSwgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGVudGlyZSBzdG9yZSdzIGVudGl0eSBjb2xsZWN0aW9uLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLmdldEFsbCgpO1xuICAgKi9cbiAgZ2V0QWxsKG9wdGlvbnM6IHsgYXNPYmplY3Q6IHRydWU7IGZpbHRlckJ5PzogU2VsZWN0T3B0aW9uczxFPlsnZmlsdGVyQnknXTsgbGltaXRUbz86IG51bWJlciB9KTogSGFzaE1hcDxFPjtcbiAgZ2V0QWxsKG9wdGlvbnM6IHsgZmlsdGVyQnk6IFNlbGVjdE9wdGlvbnM8RT5bJ2ZpbHRlckJ5J107IGxpbWl0VG8/OiBudW1iZXIgfSk6IEVbXTtcbiAgZ2V0QWxsKG9wdGlvbnM6IHsgYXNPYmplY3Q6IHRydWU7IGxpbWl0VG8/OiBudW1iZXIgfSk6IEhhc2hNYXA8RT47XG4gIGdldEFsbChvcHRpb25zOiB7IGxpbWl0VG8/OiBudW1iZXIgfSk6IEVbXTtcbiAgZ2V0QWxsKG9wdGlvbnM6IHsgYXNPYmplY3Q6IGZhbHNlOyBmaWx0ZXJCeT86IFNlbGVjdE9wdGlvbnM8RT5bJ2ZpbHRlckJ5J107IGxpbWl0VG8/OiBudW1iZXIgfSk6IEVbXTtcbiAgZ2V0QWxsKCk6IEVbXTtcbiAgZ2V0QWxsKG9wdGlvbnM6IFNlbGVjdE9wdGlvbnM8RT4gPSB7IGFzT2JqZWN0OiBmYWxzZSwgZmlsdGVyQnk6IHVuZGVmaW5lZCwgbGltaXRUbzogdW5kZWZpbmVkIH0pOiBFW10gfCBIYXNoTWFwPEU+IHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0U25hcHNob3QoKTtcblxuICAgIGlmIChvcHRpb25zLmFzT2JqZWN0KSB7XG4gICAgICByZXR1cm4gdG9NYXAoc3RhdGUuaWRzLCBzdGF0ZS5lbnRpdGllcywgb3B0aW9ucywgdHJ1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRvQXJyYXkoc3RhdGUsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCBtdWx0aXBsZSBlbnRpdGllcyBmcm9tIHRoZSBzdG9yZS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5zZWxlY3RNYW55KFsxLDJdKTtcbiAgICovXG4gIHNlbGVjdE1hbnkoaWRzOiBJRFtdLCBvcHRpb25zOiB7IGZpbHRlclVuZGVmaW5lZD86IGJvb2xlYW4gfSA9IHt9KTogT2JzZXJ2YWJsZTxFW10+IHtcbiAgICBjb25zdCBmaWx0ZXJVbmRlZmluZWQgPSBpc1VuZGVmaW5lZChvcHRpb25zLmZpbHRlclVuZGVmaW5lZCkgPyB0cnVlIDogb3B0aW9ucy5maWx0ZXJVbmRlZmluZWQ7XG4gICAgY29uc3QgZW50aXRpZXMgPSBpZHMubWFwKGlkID0+IHRoaXMuc2VsZWN0RW50aXR5KGlkKSk7XG5cbiAgICByZXR1cm4gY29tYmluZUxhdGVzdChlbnRpdGllcykucGlwZShcbiAgICAgIG1hcChlbnRpdGllcyA9PiB7XG4gICAgICAgIHJldHVybiBmaWx0ZXJVbmRlZmluZWQgPyBlbnRpdGllcy5maWx0ZXIodmFsID0+ICFpc1VuZGVmaW5lZCh2YWwpKSA6IGVudGl0aWVzO1xuICAgICAgfSksXG4gICAgICBhdWRpdFRpbWUoMClcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCBhbiBlbnRpdHkgb3IgYSBzbGljZSBvZiBhbiBlbnRpdHkuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMucGFnZXNTdG9yZS5zZWxlY3RFbnRpdHkoMSlcbiAgICogdGhpcy5wYWdlc1N0b3JlLnNlbGVjdEVudGl0eSgxLCBlbnRpdHkgPT4gZW50aXR5LmNvbmZpZy5kYXRlKVxuICAgKlxuICAgKi9cbiAgc2VsZWN0RW50aXR5PFI+KGlkOiBJRCk6IE9ic2VydmFibGU8RT47XG4gIHNlbGVjdEVudGl0eTxSPihpZDogSUQsIHByb2plY3Q6IChlbnRpdHk6IEUpID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzZWxlY3RFbnRpdHk8Uj4oaWQ6IElELCBwcm9qZWN0PzogKGVudGl0eTogRSkgPT4gUik6IE9ic2VydmFibGU8UiB8IEU+IHtcbiAgICBpZiAoIXByb2plY3QpIHtcbiAgICAgIHJldHVybiB0aGlzLl9ieUlkKGlkKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zZWxlY3Qoc3RhdGUgPT4ge1xuICAgICAgaWYgKHRoaXMuaGFzRW50aXR5KGlkKSkge1xuICAgICAgICByZXR1cm4gcHJvamVjdCh0aGlzLmdldEVudGl0eShpZCkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbiBlbnRpdHkgYnkgaWRcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5nZXRFbnRpdHkoMSk7XG4gICAqL1xuICBnZXRFbnRpdHkoaWQ6IElEKTogRSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U25hcHNob3QoKS5lbnRpdGllc1tpZF07XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IHRoZSBhY3RpdmUgZW50aXR5J3MgaWQuXG4gICAqL1xuICBzZWxlY3RBY3RpdmVJZCgpOiBPYnNlcnZhYmxlPElEPiB7XG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0KHN0YXRlID0+IChzdGF0ZSBhcyBTICYgQWN0aXZlU3RhdGUpLmFjdGl2ZSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBhY3RpdmUgaWRcbiAgICovXG4gIGdldEFjdGl2ZUlkKCk6IElEIHtcbiAgICByZXR1cm4gKHRoaXMuZ2V0U25hcHNob3QoKSBhcyBTICYgQWN0aXZlU3RhdGUpLmFjdGl2ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWxlY3QgdGhlIGFjdGl2ZSBlbnRpdHkuXG4gICAqL1xuICBzZWxlY3RBY3RpdmU8Uj4oKTogT2JzZXJ2YWJsZTxFPjtcbiAgc2VsZWN0QWN0aXZlPFI+KHByb2plY3Q6IChlbnRpdHk6IEUpID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzZWxlY3RBY3RpdmU8Uj4ocHJvamVjdD86IChlbnRpdHk6IEUpID0+IFIpOiBPYnNlcnZhYmxlPFIgfCBFPiB7XG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0QWN0aXZlSWQoKS5waXBlKHN3aXRjaE1hcChhY3RpdmVJZCA9PiB0aGlzLnNlbGVjdEVudGl0eShhY3RpdmVJZCwgcHJvamVjdCkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGFjdGl2ZSBlbnRpdHkuXG4gICAqL1xuICBnZXRBY3RpdmUoKTogRSB7XG4gICAgY29uc3QgYWN0aXZlSWQ6IElEID0gdGhpcy5nZXRBY3RpdmVJZCgpO1xuICAgIHJldHVybiB0b0Jvb2xlYW4oYWN0aXZlSWQpID8gdGhpcy5nZXRFbnRpdHkoYWN0aXZlSWQpIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCB0aGUgc3RvcmUncyBlbnRpdHkgY29sbGVjdGlvbiBsZW5ndGguXG4gICAqL1xuICBzZWxlY3RDb3VudChwcmVkaWNhdGU/OiAoZW50aXR5OiBFKSA9PiBib29sZWFuKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICBpZiAoaXNGdW5jdGlvbihwcmVkaWNhdGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5zZWxlY3RBbGwoe1xuICAgICAgICBmaWx0ZXJCeTogcHJlZGljYXRlXG4gICAgICB9KS5waXBlKG1hcChlbnRpdGllcyA9PiBlbnRpdGllcy5sZW5ndGgpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zZWxlY3Qoc3RvcmUgPT4gc3RvcmUuaWRzLmxlbmd0aCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBzdG9yZSdzIGVudGl0eSBjb2xsZWN0aW9uIGxlbmd0aC5cbiAgICovXG4gIGdldENvdW50KHByZWRpY2F0ZT86IChlbnRpdHk6IEUpID0+IGJvb2xlYW4pOiBudW1iZXIge1xuICAgIGlmIChpc0Z1bmN0aW9uKHByZWRpY2F0ZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldEFsbCgpLmZpbHRlcihwcmVkaWNhdGUpLmxlbmd0aDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0U25hcHNob3QoKS5pZHMubGVuZ3RoO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgd2hldGhlciBlbnRpdHkgZXhpc3RzLlxuICAgKi9cbiAgaGFzRW50aXR5KGlkOiBJRCk6IGJvb2xlYW47XG4gIGhhc0VudGl0eShwcm9qZWN0OiAoZW50aXR5OiBFKSA9PiBib29sZWFuKTogYm9vbGVhbjtcbiAgaGFzRW50aXR5KHByb2plY3RPcklkOiBhbnkpOiBib29sZWFuIHtcbiAgICBpZiAoaXNGdW5jdGlvbihwcm9qZWN0T3JJZCkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldEFsbCgpLnNvbWUocHJvamVjdE9ySWQpO1xuICAgIH1cbiAgICByZXR1cm4gcHJvamVjdE9ySWQgaW4gdGhpcy5zdG9yZS5lbnRpdGllcztcbiAgfVxuXG4gIGlzRW1wdHkoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0U25hcHNob3QoKS5pZHMubGVuZ3RoID09PSAwO1xuICB9XG5cbiAgcHJpdmF0ZSBfYnlJZChpZDogSUQpOiBPYnNlcnZhYmxlPEU+IHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3Qoc3RhdGUgPT4gdGhpcy5nZXRFbnRpdHkoaWQpKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMubWVtb2l6ZWQgPSBudWxsO1xuICB9XG59XG5cbmZ1bmN0aW9uIHRvQXJyYXk8RSwgUyBleHRlbmRzIEVudGl0eVN0YXRlPihzdGF0ZTogUywgb3B0aW9uczogU2VsZWN0T3B0aW9uczxFPik6IEVbXSB7XG4gIGxldCBhcnIgPSBbXTtcbiAgY29uc3QgeyBpZHMsIGVudGl0aWVzIH0gPSBzdGF0ZTtcbiAgY29uc3QgeyBmaWx0ZXJCeSwgbGltaXRUbywgc29ydEJ5LCBzb3J0QnlPcmRlciB9ID0gb3B0aW9ucztcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGlkcy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGlkID0gaWRzW2ldO1xuXG4gICAgaWYgKCFlbnRpdHlFeGlzdHMoaWQsIGVudGl0aWVzKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKCFmaWx0ZXJCeSkge1xuICAgICAgYXJyLnB1c2goZW50aXRpZXNbaWRdKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmIChmaWx0ZXJCeShlbnRpdGllc1tpZF0pKSB7XG4gICAgICBhcnIucHVzaChlbnRpdGllc1tpZF0pO1xuICAgIH1cbiAgfVxuXG4gIGlmIChzb3J0QnkpIHtcbiAgICBsZXQgX3NvcnRCeTogYW55ID0gaXNGdW5jdGlvbihzb3J0QnkpID8gc29ydEJ5IDogY29tcGFyZVZhbHVlcyhzb3J0QnksIHNvcnRCeU9yZGVyKTtcbiAgICBhcnIgPSBhcnIuc29ydCgoYSwgYikgPT4gX3NvcnRCeShhLCBiLCBzdGF0ZSkpO1xuICB9XG4gIGNvbnN0IGxlbmd0aCA9IE1hdGgubWluKGxpbWl0VG8gfHwgYXJyLmxlbmd0aCwgYXJyLmxlbmd0aCk7XG5cbiAgcmV0dXJuIGxlbmd0aCA9PT0gYXJyLmxlbmd0aCA/IGFyciA6IGFyci5zbGljZSgwLCBsZW5ndGgpO1xufVxuXG5mdW5jdGlvbiB0b01hcDxFPihpZHM6IElEW10sIGVudGl0aWVzOiBIYXNoTWFwPEU+LCBvcHRpb25zOiBTZWxlY3RPcHRpb25zPEU+LCBnZXQgPSBmYWxzZSk6IEhhc2hNYXA8RT4ge1xuICBjb25zdCBtYXAgPSB7fTtcbiAgY29uc3QgeyBmaWx0ZXJCeSwgbGltaXRUbyB9ID0gb3B0aW9ucztcblxuICBpZiAoZ2V0ICYmICFmaWx0ZXJCeSAmJiAhbGltaXRUbykge1xuICAgIHJldHVybiBlbnRpdGllcztcbiAgfVxuXG4gIGNvbnN0IGxlbmd0aCA9IE1hdGgubWluKGxpbWl0VG8gfHwgaWRzLmxlbmd0aCwgaWRzLmxlbmd0aCk7XG5cbiAgaWYgKGZpbHRlckJ5ICYmIGlzVW5kZWZpbmVkKGxpbWl0VG8pID09PSBmYWxzZSkge1xuICAgIGxldCBjb3VudCA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbmd0aCA9IGlkcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGNvdW50ID09PSBsaW1pdFRvKSBicmVhaztcbiAgICAgIGNvbnN0IGlkID0gaWRzW2ldO1xuICAgICAgaWYgKCFlbnRpdHlFeGlzdHMoaWQsIGVudGl0aWVzKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGlmIChmaWx0ZXJCeShlbnRpdGllc1tpZF0pKSB7XG4gICAgICAgIG1hcFtpZF0gPSBlbnRpdGllc1tpZF07XG4gICAgICAgIGNvdW50Kys7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGlkID0gaWRzW2ldO1xuXG4gICAgICBpZiAoIWVudGl0eUV4aXN0cyhpZCwgZW50aXRpZXMpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWZpbHRlckJ5KSB7XG4gICAgICAgIG1hcFtpZF0gPSBlbnRpdGllc1tpZF07XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAodG9Cb29sZWFuKGZpbHRlckJ5KGVudGl0aWVzW2lkXSkpKSB7XG4gICAgICAgIG1hcFtpZF0gPSBlbnRpdGllc1tpZF07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1hcDtcbn1cbiJdfQ==