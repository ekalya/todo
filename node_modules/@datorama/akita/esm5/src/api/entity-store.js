/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { _crud } from '../internal/crud';
import { AkitaImmutabilityError, assertActive } from '../internal/error';
import { __globalState } from '../internal/global-state';
import { coerceArray, entityExists, isFunction, toBoolean } from '../internal/utils';
import { isDev, Store } from './store';
// unsupported: template constraints.
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S, E
 */
var 
// unsupported: template constraints.
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S, E
 */
EntityStore = /** @class */ (function (_super) {
    tslib_1.__extends(EntityStore, _super);
    /**
     *
     * Initiate the store with the state
     */
    function EntityStore(initialState, options) {
        if (initialState === void 0) { initialState = {}; }
        if (options === void 0) { options = {}; }
        var _this = _super.call(this, tslib_1.__assign({}, getInitialEntitiesState(), initialState)) || this;
        _this.options = options;
        return _this;
    }
    Object.defineProperty(EntityStore.prototype, "entities", {
        get: /**
         * @return {?}
         */
        function () {
            return this._value().entities;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityStore.prototype, "idKey", {
        get: /**
         * @return {?}
         */
        function () {
            /** *
             * backward compatibility
              @type {?} */
            var newIdKey = this.config && this.config.idKey;
            if (!newIdKey) {
                return this.options.idKey || 'id';
            }
            return newIdKey;
        },
        enumerable: true,
        configurable: true
    });
    /**
     *
     * Replace current collection with provided collection
     *
     * @example
     * this.store.set([Entity, Entity]);
     * this.store.set({1: Entity, 2: Entity});
     * this.store.set([{id: 1}, {id: 2}], { entityClass: Product });
     *
     */
    /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     * this.store.set([Entity, Entity]);
     * this.store.set({1: Entity, 2: Entity});
     * this.store.set([{id: 1}, {id: 2}], { entityClass: Product });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    EntityStore.prototype.set = /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     * this.store.set([Entity, Entity]);
     * this.store.set({1: Entity, 2: Entity});
     * this.store.set([{id: 1}, {id: 2}], { entityClass: Product });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    function (entities, options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        isDev() && __globalState.setAction({ type: 'Set Entities' });
        this.setState(function (state) { return _crud._set(state, entities, options.entityClass, _this.idKey); });
        this.setDirty();
    };
    /**
     * Create or replace an entity in the store.
     *
     * @example
     * this.store.createOrReplace(3, Entity);
     *
     */
    /**
     * Create or replace an entity in the store.
     *
     * \@example
     * this.store.createOrReplace(3, Entity);
     *
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    EntityStore.prototype.createOrReplace = /**
     * Create or replace an entity in the store.
     *
     * \@example
     * this.store.createOrReplace(3, Entity);
     *
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    function (id, entity) {
        if (!entityExists(id, this._value().entities)) {
            if (!entity[this.idKey]) {
                entity[this.idKey] = id;
            }
            return this.add(entity);
        }
        isDev() && __globalState.setAction({ type: 'Upsert Entity', entityId: [id] });
        this.setState(function (state) { return _crud._replaceEntity(state, id, entity); });
    };
    /**
     * Add an entity or entities to the store.
     *
     * @example
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity);
     */
    /**
     * Add an entity or entities to the store.
     *
     * \@example
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity);
     * @param {?} entities
     * @return {?}
     */
    EntityStore.prototype.add = /**
     * Add an entity or entities to the store.
     *
     * \@example
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity);
     * @param {?} entities
     * @return {?}
     */
    function (entities) {
        var _this = this;
        /** @type {?} */
        var toArray = coerceArray(entities);
        if (toArray.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Add Entity' });
        this.setState(function (state) { return _crud._add(state, toArray, _this.idKey); });
    };
    /**
     * @param {?} idsOrFn
     * @param {?=} newStateOrFn
     * @return {?}
     */
    EntityStore.prototype.update = /**
     * @param {?} idsOrFn
     * @param {?=} newStateOrFn
     * @return {?}
     */
    function (idsOrFn, newStateOrFn) {
        var _this = this;
        /** @type {?} */
        var ids = [];
        /** @type {?} */
        var storeIds = this._value().ids;
        if (isFunction(idsOrFn)) {
            for (var i = 0, len = storeIds.length; i < len; i++) {
                /** @type {?} */
                var id = storeIds[i];
                /** @type {?} */
                var entity = this._value().entities[id];
                if (entity && (/** @type {?} */ (idsOrFn))(entity)) {
                    ids.push(id);
                }
            }
        }
        else {
            ids = toBoolean(idsOrFn) ? coerceArray(idsOrFn) : storeIds;
        }
        if (ids.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Update Entity', entityId: ids });
        this.setState(function (state) {
            return _crud._update(state, ids, newStateOrFn, _this.idKey);
        });
    };
    /**
     * An alias to update all.
     */
    /**
     * An alias to update all.
     * @param {?} state
     * @return {?}
     */
    EntityStore.prototype.updateAll = /**
     * An alias to update all.
     * @param {?} state
     * @return {?}
     */
    function (state) {
        if (this._value().ids.length === 0)
            return;
        this.update(null, state);
    };
    /**
     * Update the root state (data which is external to the entities).
     *
     * @example
     * this.store.updateRoot({
     *   metadata: 'new metadata
     * });
     *
     *  this.store.updateRoot(state => {
     *    return {
     *      metadata: {
     *        ...state.metadata,
     *        key: 'new value'
     *      }
     *    }
     *  });
     */
    /**
     * Update the root state (data which is external to the entities).
     *
     * \@example
     * this.store.updateRoot({
     *   metadata: 'new metadata
     * });
     *
     *  this.store.updateRoot(state => {
     *    return {
     *      metadata: {
     *        ...state.metadata,
     *        key: 'new value'
     *      }
     *    }
     *  });
     * @param {?} newStateFn
     * @param {?=} action
     * @return {?}
     */
    EntityStore.prototype.updateRoot = /**
     * Update the root state (data which is external to the entities).
     *
     * \@example
     * this.store.updateRoot({
     *   metadata: 'new metadata
     * });
     *
     *  this.store.updateRoot(state => {
     *    return {
     *      metadata: {
     *        ...state.metadata,
     *        key: 'new value'
     *      }
     *    }
     *  });
     * @param {?} newStateFn
     * @param {?=} action
     * @return {?}
     */
    function (newStateFn, action) {
        /** @type {?} */
        var newState = isFunction(newStateFn) ? newStateFn(this._value()) : newStateFn;
        if (newState === this._value()) {
            throw new AkitaImmutabilityError(this.storeName);
        }
        isDev() && __globalState.setAction(action || { type: 'Update Root' });
        this.setState(function (state) {
            return tslib_1.__assign({}, (/** @type {?} */ (state)), (/** @type {?} */ (newState)));
        });
    };
    /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    EntityStore.prototype.remove = /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    function (idsOrFn) {
        /** @type {?} */
        var storeIds = this._value().ids;
        if (storeIds.length === 0)
            return;
        /** @type {?} */
        var idPassed = toBoolean(idsOrFn);
        if (!idPassed)
            this.setPristine();
        /** @type {?} */
        var ids = [];
        if (isFunction(idsOrFn)) {
            for (var i = 0, len = storeIds.length; i < len; i++) {
                /** @type {?} */
                var id = storeIds[i];
                /** @type {?} */
                var entity = this._value().entities[id];
                if (entity && idsOrFn(entity)) {
                    ids.push(id);
                }
            }
        }
        else {
            ids = idPassed ? coerceArray(idsOrFn) : null;
        }
        if (ids && ids.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Remove Entity', entityId: ids });
        this.setState(function (state) {
            return _crud._remove(state, ids);
        });
    };
    /**
     *
     * Update the active entity.
     *
     * @example
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     */
    /**
     *
     * Update the active entity.
     *
     * \@example
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateFn
     * @return {?}
     */
    EntityStore.prototype.updateActive = /**
     *
     * Update the active entity.
     *
     * \@example
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateFn
     * @return {?}
     */
    function (newStateFn) {
        var _this = this;
        assertActive(this._value());
        isDev() && __globalState.setAction({ type: 'Update Active Entity', entityId: this._value()["active"] });
        this.setState(function (state) {
            /** @type {?} */
            var activeId = state["active"];
            /** @type {?} */
            var newState = isFunction(newStateFn) ? newStateFn(state.entities[activeId]) : newStateFn;
            if (newState === state) {
                throw new AkitaImmutabilityError(_this.storeName);
            }
            return _crud._update(state, [activeId], newState, _this.idKey);
        });
    };
    /**
     * Set the given entity as active.
     */
    /**
     * Set the given entity as active.
     * @param {?} id
     * @return {?}
     */
    EntityStore.prototype.setActive = /**
     * Set the given entity as active.
     * @param {?} id
     * @return {?}
     */
    function (id) {
        if (id === this._value()["active"])
            return;
        isDev() && __globalState.setAction({ type: 'Set Active Entity', entityId: id });
        this.setState(function (state) {
            return tslib_1.__assign({}, (/** @type {?} */ (state)), { active: id });
        });
    };
    return EntityStore;
}(Store));
// unsupported: template constraints.
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S, E
 */
export { EntityStore };
function EntityStore_tsickle_Closure_declarations() {
    /** @type {?} */
    EntityStore.prototype.options;
}
/** @type {?} */
export var getInitialEntitiesState = function () {
    return (/** @type {?} */ ({
        entities: {},
        ids: [],
        loading: true,
        error: null
    }));
};
/** @type {?} */
export var getInitialActiveState = function () {
    return (/** @type {?} */ ({
        active: null
    }));
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LXN0b3JlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL2FwaS9lbnRpdHktc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDekMsT0FBTyxFQUFFLHNCQUFzQixFQUFFLFlBQVksRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3pFLE9BQU8sRUFBVSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDckYsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7Ozs7Ozs7QUFPdkM7Ozs7Ozs7QUFBQTtJQUE4RCx1Q0FBUTtJQUNwRTs7O09BR0c7SUFDSCxxQkFBWSxZQUFpQixFQUFVLE9BQWdDO1FBQTNELDZCQUFBLEVBQUEsaUJBQWlCOzhDQUEwQztRQUF2RSxZQUNFLHVDQUFXLHVCQUF1QixFQUFFLEVBQUssWUFBWSxFQUFHLFNBQ3pEO1FBRnNDLGFBQU8sR0FBUCxPQUFPLENBQXlCOztLQUV0RTtJQUVELHNCQUFJLGlDQUFROzs7O1FBQVo7WUFDRSxPQUFPLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUM7U0FDL0I7OztPQUFBO0lBRUQsc0JBQUksOEJBQUs7Ozs7UUFBVDs7OztZQUVFLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFDbEQsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDYixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQzthQUNuQztZQUNELE9BQU8sUUFBUSxDQUFDO1NBQ2pCOzs7T0FBQTtJQUVEOzs7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LENBQUMsQ0FBQztTQUMvRCxDQUFDLENBQUM7S0FDSjtJQUVEOztPQUVHOzs7Ozs7SUFDSCwrQkFBUzs7Ozs7SUFBVCxVQUFVLEVBQU07UUFDZCxJQUFJLEVBQUUsS0FBSyxJQUFJLENBQUMsTUFBTSxFQUFFLFVBQU87WUFBRSxPQUFPO1FBQ3hDLEtBQUssRUFBRSxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsbUJBQW1CLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDaEYsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFBLEtBQUs7WUFDakIsNEJBQ0ssbUJBQUMsS0FBWSxFQUFDLElBQ2pCLE1BQU0sRUFBRSxFQUFFLElBQ1Y7U0FDSCxDQUFDLENBQUM7S0FDSjtzQkE1UUg7RUFXOEQsS0FBSyxFQWtRbEUsQ0FBQTs7Ozs7OztBQWxRRCx1QkFrUUM7Ozs7OztBQUVELFdBQWEsdUJBQXVCLEdBQUc7SUFDckMsT0FBQSxtQkFBQztRQUNDLFFBQVEsRUFBRSxFQUFFO1FBQ1osR0FBRyxFQUFFLEVBQUU7UUFDUCxPQUFPLEVBQUUsSUFBSTtRQUNiLEtBQUssRUFBRSxJQUFJO0tBQ0csRUFBQztBQUxqQixDQUtpQixDQUFDOztBQUVwQixXQUFhLHFCQUFxQixHQUFHO0lBQ25DLE9BQUEsbUJBQUM7UUFDQyxNQUFNLEVBQUUsSUFBSTtLQUNFLEVBQUM7QUFGakIsQ0FFaUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IF9jcnVkIH0gZnJvbSAnLi4vaW50ZXJuYWwvY3J1ZCc7XG5pbXBvcnQgeyBBa2l0YUltbXV0YWJpbGl0eUVycm9yLCBhc3NlcnRBY3RpdmUgfSBmcm9tICcuLi9pbnRlcm5hbC9lcnJvcic7XG5pbXBvcnQgeyBBY3Rpb24sIF9fZ2xvYmFsU3RhdGUgfSBmcm9tICcuLi9pbnRlcm5hbC9nbG9iYWwtc3RhdGUnO1xuaW1wb3J0IHsgY29lcmNlQXJyYXksIGVudGl0eUV4aXN0cywgaXNGdW5jdGlvbiwgdG9Cb29sZWFuIH0gZnJvbSAnLi4vaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHsgaXNEZXYsIFN0b3JlIH0gZnJvbSAnLi9zdG9yZSc7XG5pbXBvcnQgeyBBY3RpdmVTdGF0ZSwgRW50aXRpZXMsIEVudGl0eVN0YXRlLCBIYXNoTWFwLCBJRCwgTmV3YWJsZSB9IGZyb20gJy4vdHlwZXMnO1xuXG4vKipcbiAqIFRoZSBSb290IFN0b3JlIHRoYXQgZXZlcnkgc3ViIHN0b3JlIG5lZWRzIHRvIGluaGVyaXQgYW5kXG4gKiBpbnZva2UgYHN1cGVyYCB3aXRoIHRoZSBpbml0aWFsIHN0YXRlLlxuICovXG5leHBvcnQgY2xhc3MgRW50aXR5U3RvcmU8UyBleHRlbmRzIEVudGl0eVN0YXRlPEU+LCBFPiBleHRlbmRzIFN0b3JlPFM+IHtcbiAgLyoqXG4gICAqXG4gICAqIEluaXRpYXRlIHRoZSBzdG9yZSB3aXRoIHRoZSBzdGF0ZVxuICAgKi9cbiAgY29uc3RydWN0b3IoaW5pdGlhbFN0YXRlID0ge30sIHByaXZhdGUgb3B0aW9uczogeyBpZEtleT86IHN0cmluZyB9ID0ge30pIHtcbiAgICBzdXBlcih7IC4uLmdldEluaXRpYWxFbnRpdGllc1N0YXRlKCksIC4uLmluaXRpYWxTdGF0ZSB9KTtcbiAgfVxuXG4gIGdldCBlbnRpdGllcygpIHtcbiAgICByZXR1cm4gdGhpcy5fdmFsdWUoKS5lbnRpdGllcztcbiAgfVxuXG4gIGdldCBpZEtleSgpIHtcbiAgICAvKiogYmFja3dhcmQgY29tcGF0aWJpbGl0eSAqL1xuICAgIGNvbnN0IG5ld0lkS2V5ID0gdGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcuaWRLZXk7XG4gICAgaWYgKCFuZXdJZEtleSkge1xuICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5pZEtleSB8fCAnaWQnO1xuICAgIH1cbiAgICByZXR1cm4gbmV3SWRLZXk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogUmVwbGFjZSBjdXJyZW50IGNvbGxlY3Rpb24gd2l0aCBwcm92aWRlZCBjb2xsZWN0aW9uXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuc2V0KFtFbnRpdHksIEVudGl0eV0pO1xuICAgKiB0aGlzLnN0b3JlLnNldCh7MTogRW50aXR5LCAyOiBFbnRpdHl9KTtcbiAgICogdGhpcy5zdG9yZS5zZXQoW3tpZDogMX0sIHtpZDogMn1dLCB7IGVudGl0eUNsYXNzOiBQcm9kdWN0IH0pO1xuICAgKlxuICAgKi9cbiAgc2V0KGVudGl0aWVzOiBFW10gfCBIYXNoTWFwPEU+IHwgRW50aXRpZXM8RT4sIG9wdGlvbnM6IHsgZW50aXR5Q2xhc3M/OiBOZXdhYmxlPEU+IH0gPSB7fSkge1xuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnU2V0IEVudGl0aWVzJyB9KTtcbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IF9jcnVkLl9zZXQoc3RhdGUsIGVudGl0aWVzLCBvcHRpb25zLmVudGl0eUNsYXNzLCB0aGlzLmlkS2V5KSk7XG4gICAgdGhpcy5zZXREaXJ0eSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBvciByZXBsYWNlIGFuIGVudGl0eSBpbiB0aGUgc3RvcmUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuY3JlYXRlT3JSZXBsYWNlKDMsIEVudGl0eSk7XG4gICAqXG4gICAqL1xuICBjcmVhdGVPclJlcGxhY2UoaWQ6IElELCBlbnRpdHk6IEUpIHtcbiAgICBpZiAoIWVudGl0eUV4aXN0cyhpZCwgdGhpcy5fdmFsdWUoKS5lbnRpdGllcykpIHtcbiAgICAgIGlmICghZW50aXR5W3RoaXMuaWRLZXldKSB7XG4gICAgICAgIGVudGl0eVt0aGlzLmlkS2V5XSA9IGlkO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMuYWRkKGVudGl0eSk7XG4gICAgfVxuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnVXBzZXJ0IEVudGl0eScsIGVudGl0eUlkOiBbaWRdIH0pO1xuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4gX2NydWQuX3JlcGxhY2VFbnRpdHkoc3RhdGUsIGlkLCBlbnRpdHkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYW4gZW50aXR5IG9yIGVudGl0aWVzIHRvIHRoZSBzdG9yZS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5hZGQoW0VudGl0eSwgRW50aXR5XSk7XG4gICAqIHRoaXMuc3RvcmUuYWRkKEVudGl0eSk7XG4gICAqL1xuICBhZGQoZW50aXRpZXM6IEVbXSB8IEUpIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoZW50aXRpZXMpO1xuICAgIGlmICh0b0FycmF5Lmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnQWRkIEVudGl0eScgfSk7XG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiBfY3J1ZC5fYWRkPFMsIEU+KHN0YXRlLCB0b0FycmF5LCB0aGlzLmlkS2V5KSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogVXBkYXRlIGFuIGVudGl0eSBvciBlbnRpdGllcyBpbiB0aGUgc3RvcmUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlKDMsIHtcbiAgICogICBuYW1lOiAnTmV3IE5hbWUnXG4gICAqIH0pO1xuICAgKlxuICAgKiAgdGhpcy5zdG9yZS51cGRhdGUoMywgZW50aXR5ID0+IHtcbiAgICogICAgcmV0dXJuIHtcbiAgICogICAgICBjb25maWc6IHtcbiAgICogICAgICAgIC4uLmVudGl0eS5maWx0ZXIsXG4gICAqICAgICAgICBkYXRlXG4gICAqICAgICAgfVxuICAgKiAgICB9XG4gICAqICB9KTtcbiAgICpcbiAgICogdGhpcy5zdG9yZS51cGRhdGUoWzEsMiwzXSwge1xuICAgKiAgIG5hbWU6ICdOZXcgTmFtZSdcbiAgICogfSk7XG4gICAqXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlKGUgPT4gZS5uYW1lID09PSAndmFsdWUnLCB7XG4gICAqICAgbmFtZTogJ05ldyBOYW1lJ1xuICAgKiB9KTtcbiAgICpcbiAgICogdGhpcy5zdG9yZS51cGRhdGUobnVsbCwge1xuICAgKiAgIG5hbWU6ICdOZXcgTmFtZSdcbiAgICogfSk7XG4gICAqXG4gICAqL1xuICB1cGRhdGUoaWQ6IElEIHwgSURbXSB8IG51bGwsIG5ld1N0YXRlRm46ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gUGFydGlhbDxFPikpO1xuICB1cGRhdGUoaWQ6IElEIHwgSURbXSB8IG51bGwsIG5ld1N0YXRlOiBQYXJ0aWFsPEU+KTtcbiAgdXBkYXRlKGlkOiBJRCB8IElEW10gfCBudWxsLCBuZXdTdGF0ZTogUGFydGlhbDxTPik7XG4gIHVwZGF0ZShuZXdTdGF0ZTogKHN0YXRlOiBSZWFkb25seTxTPikgPT4gUGFydGlhbDxTPik7XG4gIHVwZGF0ZShwcmVkaWNhdGU6ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gYm9vbGVhbiksIG5ld1N0YXRlRm46ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gUGFydGlhbDxFPikpO1xuICB1cGRhdGUocHJlZGljYXRlOiAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IGJvb2xlYW4pLCBuZXdTdGF0ZTogUGFydGlhbDxFPik7XG4gIHVwZGF0ZShwcmVkaWNhdGU6ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gYm9vbGVhbiksIG5ld1N0YXRlOiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKG5ld1N0YXRlOiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKFxuICAgIGlkc09yRm46IElEIHwgSURbXSB8IG51bGwgfCBQYXJ0aWFsPFM+IHwgKChzdGF0ZTogUmVhZG9ubHk8Uz4pID0+IFBhcnRpYWw8Uz4pIHwgKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBib29sZWFuKSxcbiAgICBuZXdTdGF0ZU9yRm4/OiAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IFBhcnRpYWw8RT4pIHwgUGFydGlhbDxFPiB8IFBhcnRpYWw8Uz5cbiAgKSB7XG4gICAgbGV0IGlkczogSURbXSA9IFtdO1xuICAgIGNvbnN0IHN0b3JlSWRzID0gdGhpcy5fdmFsdWUoKS5pZHM7XG5cbiAgICBpZiAoaXNGdW5jdGlvbihpZHNPckZuKSkge1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHN0b3JlSWRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGlkID0gc3RvcmVJZHNbaV07XG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuX3ZhbHVlKCkuZW50aXRpZXNbaWRdO1xuICAgICAgICBpZiAoZW50aXR5ICYmIChpZHNPckZuIGFzIEZ1bmN0aW9uKShlbnRpdHkpKSB7XG4gICAgICAgICAgaWRzLnB1c2goaWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlkcyA9IHRvQm9vbGVhbihpZHNPckZuKSA/IGNvZXJjZUFycmF5KGlkc09yRm4pIDogc3RvcmVJZHM7XG4gICAgfVxuXG4gICAgaWYgKGlkcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1VwZGF0ZSBFbnRpdHknLCBlbnRpdHlJZDogaWRzIH0pO1xuXG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICByZXR1cm4gX2NydWQuX3VwZGF0ZShzdGF0ZSwgaWRzLCBuZXdTdGF0ZU9yRm4sIHRoaXMuaWRLZXkpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEFuIGFsaWFzIHRvIHVwZGF0ZSBhbGwuXG4gICAqL1xuICB1cGRhdGVBbGwoc3RhdGU6IFBhcnRpYWw8RT4pIHtcbiAgICBpZiAodGhpcy5fdmFsdWUoKS5pZHMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgdGhpcy51cGRhdGUobnVsbCwgc3RhdGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB0aGUgcm9vdCBzdGF0ZSAoZGF0YSB3aGljaCBpcyBleHRlcm5hbCB0byB0aGUgZW50aXRpZXMpLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZVJvb3Qoe1xuICAgKiAgIG1ldGFkYXRhOiAnbmV3IG1ldGFkYXRhXG4gICAqIH0pO1xuICAgKlxuICAgKiAgdGhpcy5zdG9yZS51cGRhdGVSb290KHN0YXRlID0+IHtcbiAgICogICAgcmV0dXJuIHtcbiAgICogICAgICBtZXRhZGF0YToge1xuICAgKiAgICAgICAgLi4uc3RhdGUubWV0YWRhdGEsXG4gICAqICAgICAgICBrZXk6ICduZXcgdmFsdWUnXG4gICAqICAgICAgfVxuICAgKiAgICB9XG4gICAqICB9KTtcbiAgICovXG4gIHVwZGF0ZVJvb3QobmV3U3RhdGVGbjogKChzdGF0ZTogUmVhZG9ubHk8Uz4pID0+IFBhcnRpYWw8Uz4pIHwgUGFydGlhbDxTPiwgYWN0aW9uPzogQWN0aW9uKSB7XG4gICAgY29uc3QgbmV3U3RhdGUgPSBpc0Z1bmN0aW9uKG5ld1N0YXRlRm4pID8gbmV3U3RhdGVGbih0aGlzLl92YWx1ZSgpKSA6IG5ld1N0YXRlRm47XG5cbiAgICBpZiAobmV3U3RhdGUgPT09IHRoaXMuX3ZhbHVlKCkpIHtcbiAgICAgIHRocm93IG5ldyBBa2l0YUltbXV0YWJpbGl0eUVycm9yKHRoaXMuc3RvcmVOYW1lKTtcbiAgICB9XG5cbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKGFjdGlvbiB8fCB7IHR5cGU6ICdVcGRhdGUgUm9vdCcgfSk7XG5cbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLihzdGF0ZSBhcyBhbnkpLFxuICAgICAgICAuLi4obmV3U3RhdGUgYXMgYW55KVxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBSZW1vdmUgb25lIG9yIG1vcmUgZW50aXRpZXMgZnJvbSB0aGUgc3RvcmU6XG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKDUpO1xuICAgKiB0aGlzLnN0b3JlLnJlbW92ZShbMSwyLDNdKTtcbiAgICogdGhpcy5zdG9yZS5yZW1vdmUoZW50aXR5ID0+IGVudGl0eS5pZCA9PT0gMSk7XG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKCk7XG4gICAqL1xuICByZW1vdmUoaWQ/OiBJRCB8IElEW10pO1xuICByZW1vdmUocHJlZGljYXRlOiAoZW50aXR5OiBSZWFkb25seTxFPikgPT4gYm9vbGVhbik7XG4gIHJlbW92ZShpZHNPckZuPzogSUQgfCBJRFtdIHwgKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBib29sZWFuKSkge1xuICAgIGNvbnN0IHN0b3JlSWRzID0gdGhpcy5fdmFsdWUoKS5pZHM7XG5cbiAgICBpZiAoc3RvcmVJZHMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgY29uc3QgaWRQYXNzZWQgPSB0b0Jvb2xlYW4oaWRzT3JGbik7XG4gICAgaWYgKCFpZFBhc3NlZCkgdGhpcy5zZXRQcmlzdGluZSgpO1xuXG4gICAgbGV0IGlkczogSURbXSA9IFtdO1xuICAgIGlmIChpc0Z1bmN0aW9uKGlkc09yRm4pKSB7XG4gICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc3RvcmVJZHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgY29uc3QgaWQgPSBzdG9yZUlkc1tpXTtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5fdmFsdWUoKS5lbnRpdGllc1tpZF07XG4gICAgICAgIGlmIChlbnRpdHkgJiYgaWRzT3JGbihlbnRpdHkpKSB7XG4gICAgICAgICAgaWRzLnB1c2goaWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlkcyA9IGlkUGFzc2VkID8gY29lcmNlQXJyYXkoaWRzT3JGbikgOiBudWxsO1xuICAgIH1cblxuICAgIGlmIChpZHMgJiYgaWRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnUmVtb3ZlIEVudGl0eScsIGVudGl0eUlkOiBpZHMgfSk7XG5cbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIHJldHVybiBfY3J1ZC5fcmVtb3ZlKHN0YXRlLCBpZHMpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwZGF0ZSB0aGUgYWN0aXZlIGVudGl0eS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS51cGRhdGVBY3RpdmUoYWN0aXZlID0+IHtcbiAgICogICByZXR1cm4ge1xuICAgKiAgICAgY29uZmlnOiB7XG4gICAqICAgICAgLi5hY3RpdmUuY29uZmlnLFxuICAgKiAgICAgIGRhdGVcbiAgICogICAgIH1cbiAgICogICB9XG4gICAqIH0pXG4gICAqL1xuICB1cGRhdGVBY3RpdmUobmV3U3RhdGVGbjogKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBQYXJ0aWFsPEU+KSB8IFBhcnRpYWw8RT4pIHtcbiAgICBhc3NlcnRBY3RpdmUodGhpcy5fdmFsdWUoKSk7XG4gICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdVcGRhdGUgQWN0aXZlIEVudGl0eScsIGVudGl0eUlkOiB0aGlzLl92YWx1ZSgpLmFjdGl2ZSB9KTtcbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIGNvbnN0IGFjdGl2ZUlkID0gc3RhdGUuYWN0aXZlO1xuICAgICAgY29uc3QgbmV3U3RhdGUgPSBpc0Z1bmN0aW9uKG5ld1N0YXRlRm4pID8gbmV3U3RhdGVGbihzdGF0ZS5lbnRpdGllc1thY3RpdmVJZF0pIDogbmV3U3RhdGVGbjtcbiAgICAgIGlmIChuZXdTdGF0ZSA9PT0gc3RhdGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFraXRhSW1tdXRhYmlsaXR5RXJyb3IodGhpcy5zdG9yZU5hbWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIF9jcnVkLl91cGRhdGUoc3RhdGUsIFthY3RpdmVJZF0sIG5ld1N0YXRlLCB0aGlzLmlkS2V5KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGdpdmVuIGVudGl0eSBhcyBhY3RpdmUuXG4gICAqL1xuICBzZXRBY3RpdmUoaWQ6IElEKSB7XG4gICAgaWYgKGlkID09PSB0aGlzLl92YWx1ZSgpLmFjdGl2ZSkgcmV0dXJuO1xuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnU2V0IEFjdGl2ZSBFbnRpdHknLCBlbnRpdHlJZDogaWQgfSk7XG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi4oc3RhdGUgYXMgYW55KSxcbiAgICAgICAgYWN0aXZlOiBpZFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgZ2V0SW5pdGlhbEVudGl0aWVzU3RhdGUgPSAoKSA9PlxuICAoe1xuICAgIGVudGl0aWVzOiB7fSxcbiAgICBpZHM6IFtdLFxuICAgIGxvYWRpbmc6IHRydWUsXG4gICAgZXJyb3I6IG51bGxcbiAgfSBhcyBFbnRpdHlTdGF0ZSk7XG5cbmV4cG9ydCBjb25zdCBnZXRJbml0aWFsQWN0aXZlU3RhdGUgPSAoKSA9PlxuICAoe1xuICAgIGFjdGl2ZTogbnVsbFxuICB9IGFzIEFjdGl2ZVN0YXRlKTtcbiJdfQ==