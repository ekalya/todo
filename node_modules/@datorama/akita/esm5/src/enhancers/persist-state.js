/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { AkitaError } from '../internal/error';
import { __stores__, rootDispatcher } from '../api/store';
import { skip } from 'rxjs/operators';
import { getValue, setValue } from '../internal/utils';
import { __globalState } from '../internal/global-state';
/** @type {?} */
var notBs = typeof localStorage === 'undefined';
/**
 * @record
 */
export function PersistStateParams() { }
function PersistStateParams_tsickle_Closure_declarations() {
    /**
     * The storage key
     * @type {?}
     */
    PersistStateParams.prototype.key;
    /**
     * Storage strategy to use. This defaults to LocalStorage but you can pass SessionStorage or anything that implements the StorageEngine API.
     * @type {?}
     */
    PersistStateParams.prototype.storage;
    /**
     * Custom deserializer. Defaults to JSON.parse
     * @type {?}
     */
    PersistStateParams.prototype.deserialize;
    /**
     * Custom serializer, defaults to JSON.stringify
     * @type {?}
     */
    PersistStateParams.prototype.serialize;
    /**
     * By default the whole state is saved to storage, use this param to include only the stores you need.
     * Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.include;
    /**
     *  By default the whole state is saved to storage, use this param to exclude stores that you don't need.
     *  Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.exclude;
}
/**
 * @param {?=} params
 * @return {?}
 */
export function persistState(params) {
    if (notBs)
        return;
    /** @type {?} */
    var defaults = {
        key: 'AkitaStores',
        storage: localStorage,
        deserialize: JSON.parse,
        serialize: JSON.stringify,
        include: [],
        exclude: []
    };
    var _a = Object.assign({}, defaults, params), storage = _a.storage, deserialize = _a.deserialize, serialize = _a.serialize, include = _a.include, exclude = _a.exclude, key = _a.key;
    /** @type {?} */
    var hasInclude = include.length > 0;
    /** @type {?} */
    var hasExclude = exclude.length > 0;
    if (hasInclude && hasExclude) {
        throw new AkitaError("You can't use both include and exclude");
    }
    /** @type {?} */
    var storageState = deserialize(storage.getItem(key) || '{}');
    /** @type {?} */
    var stores = {};
    /** @type {?} */
    var acc = {};
    /**
     * @return {?}
     */
    function save() {
        storage.setItem(key, serialize(Object.assign({}, storageState, acc)));
    }
    /**
     * @param {?} storeName
     * @param {?} path
     * @return {?}
     */
    function subscribe(storeName, path) {
        stores[storeName] = __stores__[storeName]
            ._select(function (state) { return getValue(state, path); })
            .pipe(skip(1))
            .subscribe(function (data) {
            acc[storeName] = data;
            save();
        });
    }
    /**
     * @param {?} storeName
     * @param {?} store
     * @param {?} path
     * @return {?}
     */
    function setInitial(storeName, store, path) {
        if (storageState[storeName]) {
            __globalState.setAction({ type: '@PersistState' });
            store.setState(function (state) {
                return setValue(state, path, storageState[storeName]);
            });
            if (store.setDirty) {
                store.setDirty();
            }
        }
    }
    /** @type {?} */
    var subscription = rootDispatcher.subscribe(function (action) {
        if (action.type === 0 /* NEW_STORE */) {
            /** @type {?} */
            var currentStoreName_1 = action.payload["store"].storeName;
            if (hasExclude && exclude.indexOf(currentStoreName_1) > -1 === true) {
                return;
            }
            if (hasInclude) {
                /** @type {?} */
                var path = include.find(function (name) { return name.indexOf(currentStoreName_1) > -1; });
                if (!path) {
                    return;
                }
                else {
                    currentStoreName_1 = path.split('.')[0];
                    setInitial(currentStoreName_1, action.payload["store"], path);
                    subscribe(currentStoreName_1, path);
                }
            }
            else {
                setInitial(currentStoreName_1, action.payload["store"], currentStoreName_1);
                subscribe(currentStoreName_1, currentStoreName_1);
            }
        }
    });
    return {
        destroy: /**
         * @return {?}
         */
        function () {
            subscription.unsubscribe();
            for (var i = 0, keys = Object.keys(stores); i < keys.length; i++) {
                /** @type {?} */
                var storeName = keys[i];
                stores[storeName].unsubscribe();
            }
            stores = {};
        },
        clear: /**
         * @return {?}
         */
        function () {
            storage.clear();
        },
        clearStore: /**
         * @param {?} storeName
         * @return {?}
         */
        function (storeName) {
            /** @type {?} */
            var storageState = deserialize(storage.getItem(key) || '{}');
            if (storageState[storeName]) {
                delete storageState[storeName];
                storage.setItem(key, serialize(storageState));
            }
        }
    };
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc2lzdC1zdGF0ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkYXRvcmFtYS9ha2l0YS8iLCJzb3VyY2VzIjpbInNyYy9lbmhhbmNlcnMvcGVyc2lzdC1zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxVQUFVLEVBQVcsY0FBYyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0QyxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7QUFFekQsSUFBTSxLQUFLLEdBQUcsT0FBTyxZQUFZLEtBQUssV0FBVyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBdUJsRCxNQUFNLHVCQUF1QixNQUFvQztJQUMvRCxJQUFJLEtBQUs7UUFBRSxPQUFPOztJQUVsQixJQUFNLFFBQVEsR0FBdUI7UUFDbkMsR0FBRyxFQUFFLGFBQWE7UUFDbEIsT0FBTyxFQUFFLFlBQVk7UUFDckIsV0FBVyxFQUFFLElBQUksQ0FBQyxLQUFLO1FBQ3ZCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztRQUN6QixPQUFPLEVBQUUsRUFBRTtRQUNYLE9BQU8sRUFBRSxFQUFFO0tBQ1osQ0FBQztJQUNGLDhDQUFRLG9CQUFPLEVBQUUsNEJBQVcsRUFBRSx3QkFBUyxFQUFFLG9CQUFPLEVBQUUsb0JBQU8sRUFBRSxZQUFHLENBQXlDOztJQUV2RyxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQzs7SUFDdEMsSUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFFdEMsSUFBSSxVQUFVLElBQUks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LEVBQUUsQ0FBQztZQUMzQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTs7Z0JBQ2hFLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDMUIsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO2FBQ2pDO1lBQ0QsTUFBTSxHQUFHLEVBQUUsQ0FBQztTQUNiO1FBQ0QsS0FBSzs7OztZQUNILE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNqQjtRQUNELFVBQVU7Ozs7a0JBQUMsU0FBaUI7O1lBQzFCLElBQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDO1lBRS9ELElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUMzQixPQUFPLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDL0IsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7YUFDL0M7U0FDRjtLQUNGLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFraXRhRXJyb3IgfSBmcm9tICcuLi9pbnRlcm5hbC9lcnJvcic7XG5pbXBvcnQgeyBfX3N0b3Jlc19fLCBBY3Rpb25zLCByb290RGlzcGF0Y2hlciB9IGZyb20gJy4uL2FwaS9zdG9yZSc7XG5pbXBvcnQgeyBza2lwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgZ2V0VmFsdWUsIHNldFZhbHVlIH0gZnJvbSAnLi4vaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHsgX19nbG9iYWxTdGF0ZSB9IGZyb20gJy4uL2ludGVybmFsL2dsb2JhbC1zdGF0ZSc7XG5cbmNvbnN0IG5vdEJzID0gdHlwZW9mIGxvY2FsU3RvcmFnZSA9PT0gJ3VuZGVmaW5lZCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGVyc2lzdFN0YXRlUGFyYW1zIHtcbiAgLyoqIFRoZSBzdG9yYWdlIGtleSAqL1xuICBrZXk6IHN0cmluZztcbiAgLyoqIFN0b3JhZ2Ugc3RyYXRlZ3kgdG8gdXNlLiBUaGlzIGRlZmF1bHRzIHRvIExvY2FsU3RvcmFnZSBidXQgeW91IGNhbiBwYXNzIFNlc3Npb25TdG9yYWdlIG9yIGFueXRoaW5nIHRoYXQgaW1wbGVtZW50cyB0aGUgU3RvcmFnZUVuZ2luZSBBUEkuICovXG4gIHN0b3JhZ2U6IFN0b3JhZ2U7XG4gIC8qKiBDdXN0b20gZGVzZXJpYWxpemVyLiBEZWZhdWx0cyB0byBKU09OLnBhcnNlICovXG4gIGRlc2VyaWFsaXplOiBGdW5jdGlvbjtcbiAgLyoqIEN1c3RvbSBzZXJpYWxpemVyLCBkZWZhdWx0cyB0byBKU09OLnN0cmluZ2lmeSAqL1xuICBzZXJpYWxpemU6IEZ1bmN0aW9uO1xuICAvKipcbiAgICogQnkgZGVmYXVsdCB0aGUgd2hvbGUgc3RhdGUgaXMgc2F2ZWQgdG8gc3RvcmFnZSwgdXNlIHRoaXMgcGFyYW0gdG8gaW5jbHVkZSBvbmx5IHRoZSBzdG9yZXMgeW91IG5lZWQuXG4gICAqIFBheSBhdHRlbnRpb24gdGhhdCB5b3UgY2FuJ3QgdXNlIGJvdGggaW5jbHVkZSBhbmQgZXhjbHVkZVxuICAgKi9cbiAgaW5jbHVkZTogc3RyaW5nW107XG4gIC8qKlxuICAgKiAgQnkgZGVmYXVsdCB0aGUgd2hvbGUgc3RhdGUgaXMgc2F2ZWQgdG8gc3RvcmFnZSwgdXNlIHRoaXMgcGFyYW0gdG8gZXhjbHVkZSBzdG9yZXMgdGhhdCB5b3UgZG9uJ3QgbmVlZC5cbiAgICogIFBheSBhdHRlbnRpb24gdGhhdCB5b3UgY2FuJ3QgdXNlIGJvdGggaW5jbHVkZSBhbmQgZXhjbHVkZVxuICAgKi9cbiAgZXhjbHVkZTogc3RyaW5nW107XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZXJzaXN0U3RhdGUocGFyYW1zPzogUGFydGlhbDxQZXJzaXN0U3RhdGVQYXJhbXM+KSB7XG4gIGlmIChub3RCcykgcmV0dXJuO1xuXG4gIGNvbnN0IGRlZmF1bHRzOiBQZXJzaXN0U3RhdGVQYXJhbXMgPSB7XG4gICAga2V5OiAnQWtpdGFTdG9yZXMnLFxuICAgIHN0b3JhZ2U6IGxvY2FsU3RvcmFnZSxcbiAgICBkZXNlcmlhbGl6ZTogSlNPTi5wYXJzZSxcbiAgICBzZXJpYWxpemU6IEpTT04uc3RyaW5naWZ5LFxuICAgIGluY2x1ZGU6IFtdLFxuICAgIGV4Y2x1ZGU6IFtdXG4gIH07XG4gIGNvbnN0IHsgc3RvcmFnZSwgZGVzZXJpYWxpemUsIHNlcmlhbGl6ZSwgaW5jbHVkZSwgZXhjbHVkZSwga2V5IH0gPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0cywgcGFyYW1zKTtcblxuICBjb25zdCBoYXNJbmNsdWRlID0gaW5jbHVkZS5sZW5ndGggPiAwO1xuICBjb25zdCBoYXNFeGNsdWRlID0gZXhjbHVkZS5sZW5ndGggPiAwO1xuXG4gIGlmIChoYXNJbmNsdWRlICYmIGhhc0V4Y2x1ZGUpIHtcbiAgICB0aHJvdyBuZXcgQWtpdGFFcnJvcihcIllvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXCIpO1xuICB9XG5cbiAgY29uc3Qgc3RvcmFnZVN0YXRlID0gZGVzZXJpYWxpemUoc3RvcmFnZS5nZXRJdGVtKGtleSkgfHwgJ3t9Jyk7XG5cbiAgbGV0IHN0b3JlcyA9IHt9O1xuICBsZXQgYWNjID0ge307XG5cbiAgZnVuY3Rpb24gc2F2ZSgpIHtcbiAgICBzdG9yYWdlLnNldEl0ZW0oa2V5LCBzZXJpYWxpemUoT2JqZWN0LmFzc2lnbih7fSwgc3RvcmFnZVN0YXRlLCBhY2MpKSk7XG4gIH1cblxuICBmdW5jdGlvbiBzdWJzY3JpYmUoc3RvcmVOYW1lLCBwYXRoKSB7XG4gICAgc3RvcmVzW3N0b3JlTmFtZV0gPSBfX3N0b3Jlc19fW3N0b3JlTmFtZV1cbiAgICAgIC5fc2VsZWN0KHN0YXRlID0+IGdldFZhbHVlKHN0YXRlLCBwYXRoKSlcbiAgICAgIC5waXBlKHNraXAoMSkpXG4gICAgICAuc3Vic2NyaWJlKGRhdGEgPT4ge1xuICAgICAgICBhY2Nbc3RvcmVOYW1lXSA9IGRhdGE7XG4gICAgICAgIHNhdmUoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gc2V0SW5pdGlhbChzdG9yZU5hbWUsIHN0b3JlLCBwYXRoKSB7XG4gICAgaWYgKHN0b3JhZ2VTdGF0ZVtzdG9yZU5hbWVdKSB7XG4gICAgICBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdAUGVyc2lzdFN0YXRlJyB9KTtcbiAgICAgIHN0b3JlLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgICAgcmV0dXJuIHNldFZhbHVlKHN0YXRlLCBwYXRoLCBzdG9yYWdlU3RhdGVbc3RvcmVOYW1lXSk7XG4gICAgICB9KTtcbiAgICAgIGlmIChzdG9yZS5zZXREaXJ0eSkge1xuICAgICAgICBzdG9yZS5zZXREaXJ0eSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHJvb3REaXNwYXRjaGVyLnN1YnNjcmliZShhY3Rpb24gPT4ge1xuICAgIGlmIChhY3Rpb24udHlwZSA9PT0gQWN0aW9ucy5ORVdfU1RPUkUpIHtcbiAgICAgIGxldCBjdXJyZW50U3RvcmVOYW1lID0gYWN0aW9uLnBheWxvYWQuc3RvcmUuc3RvcmVOYW1lO1xuXG4gICAgICBpZiAoaGFzRXhjbHVkZSAmJiBleGNsdWRlLmluZGV4T2YoY3VycmVudFN0b3JlTmFtZSkgPiAtMSA9PT0gdHJ1ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChoYXNJbmNsdWRlKSB7XG4gICAgICAgIGNvbnN0IHBhdGggPSBpbmNsdWRlLmZpbmQobmFtZSA9PiBuYW1lLmluZGV4T2YoY3VycmVudFN0b3JlTmFtZSkgPiAtMSk7XG4gICAgICAgIGlmICghcGF0aCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjdXJyZW50U3RvcmVOYW1lID0gcGF0aC5zcGxpdCgnLicpWzBdO1xuICAgICAgICAgIHNldEluaXRpYWwoY3VycmVudFN0b3JlTmFtZSwgYWN0aW9uLnBheWxvYWQuc3RvcmUsIHBhdGgpO1xuICAgICAgICAgIHN1YnNjcmliZShjdXJyZW50U3RvcmVOYW1lLCBwYXRoKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2V0SW5pdGlhbChjdXJyZW50U3RvcmVOYW1lLCBhY3Rpb24ucGF5bG9hZC5zdG9yZSwgY3VycmVudFN0b3JlTmFtZSk7XG4gICAgICAgIHN1YnNjcmliZShjdXJyZW50U3RvcmVOYW1lLCBjdXJyZW50U3RvcmVOYW1lKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiB7XG4gICAgZGVzdHJveSgpIHtcbiAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGtleXMgPSBPYmplY3Qua2V5cyhzdG9yZXMpOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBzdG9yZU5hbWUgPSBrZXlzW2ldO1xuICAgICAgICBzdG9yZXNbc3RvcmVOYW1lXS51bnN1YnNjcmliZSgpO1xuICAgICAgfVxuICAgICAgc3RvcmVzID0ge307XG4gICAgfSxcbiAgICBjbGVhcigpIHtcbiAgICAgIHN0b3JhZ2UuY2xlYXIoKTtcbiAgICB9LFxuICAgIGNsZWFyU3RvcmUoc3RvcmVOYW1lOiBzdHJpbmcpIHtcbiAgICAgIGNvbnN0IHN0b3JhZ2VTdGF0ZSA9IGRlc2VyaWFsaXplKHN0b3JhZ2UuZ2V0SXRlbShrZXkpIHx8ICd7fScpO1xuXG4gICAgICBpZiAoc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV0pIHtcbiAgICAgICAgZGVsZXRlIHN0b3JhZ2VTdGF0ZVtzdG9yZU5hbWVdO1xuICAgICAgICBzdG9yYWdlLnNldEl0ZW0oa2V5LCBzZXJpYWxpemUoc3RvcmFnZVN0YXRlKSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xufVxuIl19