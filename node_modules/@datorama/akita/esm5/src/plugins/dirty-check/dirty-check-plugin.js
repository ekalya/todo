/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { AkitaPlugin } from '../plugin';
import { QueryEntity } from '../../api/query-entity';
import { BehaviorSubject, merge } from 'rxjs';
import { distinctUntilChanged, map, skip } from 'rxjs/operators';
import { coerceArray, isFunction, isUndefined, toBoolean } from '../../internal/utils';
import { __globalState } from '../../internal/global-state';
/** @type {?} */
export var dirtyCheckDefaultParams = {
    comparator: function (head, current) { return JSON.stringify(head) !== JSON.stringify(current); }
};
/**
 * @template Entity, StoreState
 */
var /**
 * @template Entity, StoreState
 */
DirtyCheckPlugin = /** @class */ (function (_super) {
    tslib_1.__extends(DirtyCheckPlugin, _super);
    function DirtyCheckPlugin(query, params, _entityId) {
        var _this = _super.call(this, query) || this;
        _this.query = query;
        _this.params = params;
        _this._entityId = _entityId;
        _this.dirty = new BehaviorSubject(false);
        _this.active = false;
        _this.isDirty$ = _this.dirty.asObservable().pipe(distinctUntilChanged());
        _this.params = tslib_1.__assign({}, dirtyCheckDefaultParams, params);
        if (_this.params.watchProperty) {
            /** @type {?} */
            var watchProp = _this.params.watchProperty;
            watchProp = coerceArray(watchProp);
            if (watchProp.includes('entities') && !watchProp.includes('ids') && query instanceof QueryEntity) {
                watchProp.push('ids');
            }
            _this.params.watchProperty = watchProp;
        }
        return _this;
    }
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.getHead = /**
     * @return {?}
     */
    function () {
        return this.head;
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.activate = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.head = this._getHead();
        /** *
         * if we are tracking specific properties select only the relevant ones
          @type {?} */
        var source = this.params.watchProperty
            ? (/** @type {?} */ (this.params.watchProperty)).map(function (prop) { return _this.query.select(function (state) { return state[prop]; }).pipe(map(function (val) { return ({ val: val, __akitaKey: prop }); })); })
            : [this.selectSource(this._entityId)];
        this.subscription = merge.apply(void 0, tslib_1.__spread(source)).pipe(skip(1))
            .subscribe(function (currentState) {
            if (isUndefined(_this.head))
                return;
            /** *
             * __akitaKey is used to determine if we are tracking a specific property or a store change
              @type {?} */
            var head = currentState.__akitaKey ? _this.head[/** @type {?} */ (currentState.__akitaKey)] : _this.head;
            /** @type {?} */
            var compareTo = currentState.__akitaKey ? currentState.val : currentState;
            /** @type {?} */
            var isChange = _this.params.comparator(head, compareTo);
            _this.updateDirtiness(isChange);
        });
    };
    /**
     * @param {?=} params
     * @return {?}
     */
    DirtyCheckPlugin.prototype.reset = /**
     * @param {?=} params
     * @return {?}
     */
    function (params) {
        if (params === void 0) { params = {}; }
        /** @type {?} */
        var currentValue = this.head;
        if (isFunction(params.updateFn)) {
            if (this.isEntityBased(this._entityId)) {
                currentValue = params.updateFn(this.head, (/** @type {?} */ (this.getQuery())).getEntity(this._entityId));
            }
            else {
                currentValue = params.updateFn(this.head, (/** @type {?} */ (this.getQuery())).getSnapshot());
            }
        }
        /** *
         * If we are watching specific props compare them, if not compare the entire store
          @type {?} */
        var update = this.params.watchProperty ? this.compareProp(currentValue) : this._getHead() !== currentValue;
        if (update) {
            __globalState.setCustomAction({ type: "@DirtyCheck - Revert" });
            this.updateStore(currentValue, this._entityId);
        }
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.setHead = /**
     * @return {?}
     */
    function () {
        if (!this.active) {
            this.activate();
            this.active = true;
        }
        else {
            this.head = this._getHead();
        }
        this.updateDirtiness(false);
        return this;
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.isDirty = /**
     * @return {?}
     */
    function () {
        return toBoolean(this.dirty.value);
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.hasHead = /**
     * @return {?}
     */
    function () {
        return toBoolean(this.getHead());
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.destroy = /**
     * @return {?}
     */
    function () {
        this.head = null;
        this.subscription && this.subscription.unsubscribe();
    };
    /**
     * @param {?} isDirty
     * @return {?}
     */
    DirtyCheckPlugin.prototype.updateDirtiness = /**
     * @param {?} isDirty
     * @return {?}
     */
    function (isDirty) {
        this.dirty.next(isDirty);
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype._getHead = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var head = /** @type {?} */ (this.getSource(this._entityId));
        if (this.params.watchProperty) {
            head = (/** @type {?} */ (this.params.watchProperty)).reduce(function (_head, prop) {
                _head[prop] = (/** @type {?} */ (head))[prop];
                return _head;
            }, /** @type {?} */ ({}));
        }
        return head;
    };
    /**
     * @param {?} currentState
     * @return {?}
     */
    DirtyCheckPlugin.prototype.compareProp = /**
     * @param {?} currentState
     * @return {?}
     */
    function (currentState) {
        /** @type {?} */
        var propKeys = Object.keys(currentState);
        /** @type {?} */
        var head = this._getHead();
        return propKeys.some(function (propKey) { return currentState[propKey] !== head[propKey]; });
    };
    return DirtyCheckPlugin;
}(AkitaPlugin));
/**
 * @template Entity, StoreState
 */
export { DirtyCheckPlugin };
function DirtyCheckPlugin_tsickle_Closure_declarations() {
    /** @type {?} */
    DirtyCheckPlugin.prototype.head;
    /** @type {?} */
    DirtyCheckPlugin.prototype.dirty;
    /** @type {?} */
    DirtyCheckPlugin.prototype.subscription;
    /** @type {?} */
    DirtyCheckPlugin.prototype.active;
    /** @type {?} */
    DirtyCheckPlugin.prototype.isDirty$;
    /** @type {?} */
    DirtyCheckPlugin.prototype.query;
    /** @type {?} */
    DirtyCheckPlugin.prototype.params;
    /** @type {?} */
    DirtyCheckPlugin.prototype._entityId;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlydHktY2hlY2stcGx1Z2luLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BsdWdpbnMvZGlydHktY2hlY2svZGlydHktY2hlY2stcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFdBQVcsRUFBVyxNQUFNLFdBQVcsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDckQsT0FBTyxFQUFjLGVBQWUsRUFBZ0IsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakUsT0FBTyxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXZGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQzs7QUFVNUQsV0FBYSx1QkFBdUIsR0FBRztJQUNyQyxVQUFVLEVBQUUsVUFBQyxJQUFJLEVBQUUsT0FBTyxJQUFLLE9BQUEsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUFoRCxDQUFnRDtDQUNoRixDQUFDOzs7O0FBTUY7OztBQUFBO0lBQXNFLDRDQUErQjtJQVFuRywwQkFBc0IsS0FBa0MsRUFBVSxNQUF5QixFQUFVLFNBQXVCO1FBQTVILFlBQ0Usa0JBQU0sS0FBSyxDQUFDLFNBVWI7UUFYcUIsV0FBSyxHQUFMLEtBQUssQ0FBNkI7UUFBVSxZQUFNLEdBQU4sTUFBTSxDQUFtQjtRQUFVLGVBQVMsR0FBVCxTQUFTLENBQWM7c0JBTjVHLElBQUksZUFBZSxDQUFDLEtBQUssQ0FBQzt1QkFFekIsS0FBSzt5QkFFVSxLQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFB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ZXMgfSBmcm9tICcuLi9wbHVnaW4nO1xuaW1wb3J0IHsgUXVlcnlFbnRpdHkgfSBmcm9tICcuLi8uLi9hcGkvcXVlcnktZW50aXR5JztcbmltcG9ydCB7IE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCwgU3Vic2NyaXB0aW9uLCBtZXJnZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc2tpcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGNvZXJjZUFycmF5LCBpc0Z1bmN0aW9uLCBpc1VuZGVmaW5lZCwgdG9Cb29sZWFuIH0gZnJvbSAnLi4vLi4vaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHsgRW50aXR5UGFyYW0gfSBmcm9tICcuLi9lbnRpdHktY29sbGVjdGlvbi1wbHVnaW4nO1xuaW1wb3J0IHsgX19nbG9iYWxTdGF0ZSB9IGZyb20gJy4uLy4uL2ludGVybmFsL2dsb2JhbC1zdGF0ZSc7XG5pbXBvcnQgeyBRdWVyeSB9IGZyb20gJy4uLy4uL2FwaS9xdWVyeSc7XG5cbmV4cG9ydCB0eXBlIERpcnR5Q2hlY2tDb21wYXJhdG9yPEVudGl0eT4gPSAoaGVhZDogRW50aXR5LCBjdXJyZW50OiBFbnRpdHkpID0+IGJvb2xlYW47XG5cbmV4cG9ydCB0eXBlIERpcnR5Q2hlY2tQYXJhbXM8U3RvcmVTdGF0ZSA9IGFueT4gPSB7XG4gIGNvbXBhcmF0b3I/OiBEaXJ0eUNoZWNrQ29tcGFyYXRvcjxTdG9yZVN0YXRlPjtcbiAgd2F0Y2hQcm9wZXJ0eT86IGtleW9mIFN0b3JlU3RhdGUgfCAoa2V5b2YgU3RvcmVTdGF0ZSlbXTtcbn07XG5cbmV4cG9ydCBjb25zdCBkaXJ0eUNoZWNrRGVmYXVsdFBhcmFtcyA9IHtcbiAgY29tcGFyYXRvcjogKGhlYWQsIGN1cnJlbnQpID0+IEpTT04uc3RyaW5naWZ5KGhlYWQpICE9PSBKU09OLnN0cmluZ2lmeShjdXJyZW50KVxufTtcblxuZXhwb3J0IHR5cGUgRGlydHlDaGVja1Jlc2V0UGFyYW1zPFN0b3JlU3RhdGUgPSBhbnk+ID0ge1xuICB1cGRhdGVGbj86IFN0b3JlU3RhdGUgfCAoKGhlYWQ6IFN0b3JlU3RhdGUsIGN1cnJlbnQ6IFN0b3JlU3RhdGUpID0+IGFueSk7XG59O1xuXG5leHBvcnQgY2xhc3MgRGlydHlDaGVja1BsdWdpbjxFbnRpdHkgPSBhbnksIFN0b3JlU3RhdGUgPSBhbnk+IGV4dGVuZHMgQWtpdGFQbHVnaW48RW50aXR5LCBTdG9yZVN0YXRlPiB7XG4gIHByaXZhdGUgaGVhZDogU3RvcmVTdGF0ZSB8IFBhcnRpYWw8U3RvcmVTdGF0ZT4gfCBFbnRpdHk7XG4gIHByaXZhdGUgZGlydHkgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KGZhbHNlKTtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBhY3RpdmUgPSBmYWxzZTtcblxuICBpc0RpcnR5JDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMuZGlydHkuYXNPYnNlcnZhYmxlKCkucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcXVlcnk6IFF1ZXJpZXM8RW50aXR5LCBTdG9yZVN0YXRlPiwgcHJpdmF0ZSBwYXJhbXM/OiBEaXJ0eUNoZWNrUGFyYW1zLCBwcml2YXRlIF9lbnRpdHlJZD86IEVudGl0eVBhcmFtKSB7XG4gICAgc3VwZXIocXVlcnkpO1xuICAgIHRoaXMucGFyYW1zID0geyAuLi5kaXJ0eUNoZWNrRGVmYXVsdFBhcmFtcywgLi4ucGFyYW1zIH07XG4gICAgaWYgKHRoaXMucGFyYW1zLndhdGNoUHJvcGVydHkpIHtcbiAgICAgIGxldCB3YXRjaFByb3AgPSB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5O1xuICAgICAgd2F0Y2hQcm9wID0gY29lcmNlQXJyYXkod2F0Y2hQcm9wKTtcbiAgICAgIGlmICh3YXRjaFByb3AuaW5jbHVkZXMoJ2VudGl0aWVzJykgJiYgIXdhdGNoUHJvcC5pbmNsdWRlcygnaWRzJykgJiYgcXVlcnkgaW5zdGFuY2VvZiBRdWVyeUVudGl0eSkge1xuICAgICAgICB3YXRjaFByb3AucHVzaCgnaWRzJyk7XG4gICAgICB9XG4gICAgICB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5ID0gd2F0Y2hQcm9wO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRIZWFkKCkge1xuICAgIHJldHVybiB0aGlzLmhlYWQ7XG4gIH1cblxuICBwcml2YXRlIGFjdGl2YXRlKCkge1xuICAgIHRoaXMuaGVhZCA9IHRoaXMuX2dldEhlYWQoKTtcbiAgICAvKiogaWYgd2UgYXJlIHRyYWNraW5nIHNwZWNpZmljIHByb3BlcnRpZXMgc2VsZWN0IG9ubHkgdGhlIHJlbGV2YW50IG9uZXMgKi9cbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5XG4gICAgICA/ICh0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5IGFzIChrZXlvZiBTdG9yZVN0YXRlKVtdKS5tYXAocHJvcCA9PiB0aGlzLnF1ZXJ5LnNlbGVjdChzdGF0ZSA9PiBzdGF0ZVtwcm9wXSkucGlwZShtYXAodmFsID0+ICh7IHZhbCwgX19ha2l0YUtleTogcHJvcCB9KSkpKVxuICAgICAgOiBbdGhpcy5zZWxlY3RTb3VyY2UodGhpcy5fZW50aXR5SWQpXTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IG1lcmdlKC4uLnNvdXJjZSlcbiAgICAgIC5waXBlKHNraXAoMSkpXG4gICAgICAuc3Vic2NyaWJlKChjdXJyZW50U3RhdGU6IGFueSkgPT4ge1xuICAgICAgICBpZiAoaXNVbmRlZmluZWQodGhpcy5oZWFkKSkgcmV0dXJuO1xuICAgICAgICAvKiogX19ha2l0YUtleSBpcyB1c2VkIHRvIGRldGVybWluZSBpZiB3ZSBhcmUgdHJhY2tpbmcgYSBzcGVjaWZpYyBwcm9wZXJ0eSBvciBhIHN0b3JlIGNoYW5nZSAqL1xuICAgICAgICBjb25zdCBoZWFkID0gY3VycmVudFN0YXRlLl9fYWtpdGFLZXkgPyB0aGlzLmhlYWRbY3VycmVudFN0YXRlLl9fYWtpdGFLZXkgYXMgYW55XSA6IHRoaXMuaGVhZDtcbiAgICAgICAgY29uc3QgY29tcGFyZVRvID0gY3VycmVudFN0YXRlLl9fYWtpdGFLZXkgPyBjdXJyZW50U3RhdGUudmFsIDogY3VycmVudFN0YXRlO1xuICAgICAgICBjb25zdCBpc0NoYW5nZSA9IHRoaXMucGFyYW1zLmNvbXBhcmF0b3IoaGVhZCwgY29tcGFyZVRvKTtcblxuICAgICAgICB0aGlzLnVwZGF0ZURpcnRpbmVzcyhpc0NoYW5nZSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHJlc2V0KHBhcmFtczogRGlydHlDaGVja1Jlc2V0UGFyYW1zID0ge30pIHtcbiAgICBsZXQgY3VycmVudFZhbHVlID0gdGhpcy5oZWFkO1xuICAgIGlmIChpc0Z1bmN0aW9uKHBhcmFtcy51cGRhdGVGbikpIHtcbiAgICAgIGlmICh0aGlzLmlzRW50aXR5QmFzZWQodGhpcy5fZW50aXR5SWQpKSB7XG4gICAgICAgIGN1cnJlbnRWYWx1ZSA9IHBhcmFtcy51cGRhdGVGbih0aGlzLmhlYWQsICh0aGlzLmdldFF1ZXJ5KCkgYXMgUXVlcnlFbnRpdHk8U3RvcmVTdGF0ZSwgRW50aXR5PikuZ2V0RW50aXR5KHRoaXMuX2VudGl0eUlkKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjdXJyZW50VmFsdWUgPSBwYXJhbXMudXBkYXRlRm4odGhpcy5oZWFkLCAodGhpcy5nZXRRdWVyeSgpIGFzIFF1ZXJ5PFN0b3JlU3RhdGU+KS5nZXRTbmFwc2hvdCgpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLyoqIElmIHdlIGFyZSB3YXRjaGluZyBzcGVjaWZpYyBwcm9wcyBjb21wYXJlIHRoZW0sIGlmIG5vdCBjb21wYXJlIHRoZSBlbnRpcmUgc3RvcmUgKi9cbiAgICBjb25zdCB1cGRhdGUgPSB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5ID8gdGhpcy5jb21wYXJlUHJvcChjdXJyZW50VmFsdWUpIDogdGhpcy5fZ2V0SGVhZCgpICE9PSBjdXJyZW50VmFsdWU7XG4gICAgaWYgKHVwZGF0ZSkge1xuICAgICAgX19nbG9iYWxTdGF0ZS5zZXRDdXN0b21BY3Rpb24oeyB0eXBlOiBgQERpcnR5Q2hlY2sgLSBSZXZlcnRgIH0pO1xuICAgICAgdGhpcy51cGRhdGVTdG9yZShjdXJyZW50VmFsdWUsIHRoaXMuX2VudGl0eUlkKTtcbiAgICB9XG4gIH1cblxuICBzZXRIZWFkKCkge1xuICAgIGlmICghdGhpcy5hY3RpdmUpIHtcbiAgICAgIHRoaXMuYWN0aXZhdGUoKTtcbiAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5oZWFkID0gdGhpcy5fZ2V0SGVhZCgpO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZURpcnRpbmVzcyhmYWxzZSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBpc0RpcnR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0b0Jvb2xlYW4odGhpcy5kaXJ0eS52YWx1ZSk7XG4gIH1cblxuICBoYXNIZWFkKCkge1xuICAgIHJldHVybiB0b0Jvb2xlYW4odGhpcy5nZXRIZWFkKCkpO1xuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLmhlYWQgPSBudWxsO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uICYmIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZURpcnRpbmVzcyhpc0RpcnR5OiBib29sZWFuKSB7XG4gICAgdGhpcy5kaXJ0eS5uZXh0KGlzRGlydHkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0SGVhZCgpOiBQYXJ0aWFsPFN0b3JlU3RhdGU+IHwgU3RvcmVTdGF0ZSB7XG4gICAgbGV0IGhlYWQ6IFN0b3JlU3RhdGUgfCBQYXJ0aWFsPFN0b3JlU3RhdGU+ID0gdGhpcy5nZXRTb3VyY2UodGhpcy5fZW50aXR5SWQpIGFzIFN0b3JlU3RhdGU7XG4gICAgaWYgKHRoaXMucGFyYW1zLndhdGNoUHJvcGVydHkpIHtcbiAgICAgIGhlYWQgPSAodGhpcy5wYXJhbXMud2F0Y2hQcm9wZXJ0eSBhcyAoa2V5b2YgU3RvcmVTdGF0ZSlbXSkucmVkdWNlKFxuICAgICAgICAoX2hlYWQsIHByb3ApID0+IHtcbiAgICAgICAgICBfaGVhZFtwcm9wXSA9IChoZWFkIGFzIFBhcnRpYWw8U3RvcmVTdGF0ZT4pW3Byb3BdO1xuICAgICAgICAgIHJldHVybiBfaGVhZDtcbiAgICAgICAgfSxcbiAgICAgICAge30gYXMgUGFydGlhbDxTdG9yZVN0YXRlPlxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGhlYWQ7XG4gIH1cblxuICBwcml2YXRlIGNvbXBhcmVQcm9wKGN1cnJlbnRTdGF0ZTogUGFydGlhbDxTdG9yZVN0YXRlPik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHByb3BLZXlzID0gT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKTtcbiAgICBjb25zdCBoZWFkID0gdGhpcy5fZ2V0SGVhZCgpO1xuXG4gICAgcmV0dXJuIHByb3BLZXlzLnNvbWUocHJvcEtleSA9PiBjdXJyZW50U3RhdGVbcHJvcEtleV0gIT09IGhlYWRbcHJvcEtleV0pO1xuICB9XG59XG4iXX0=