/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { coerceArray, isFunction, isUndefined, toBoolean } from '../internal/utils';
var ɵ0 = function (plugin) { return plugin.destroy(); };
/** @type {?} */
var defaultActions = { beforeRemove: ɵ0 };
/**
 * @abstract
 * @template E, P
 */
var /**
 * @abstract
 * @template E, P
 */
EntityCollectionPlugin = /** @class */ (function () {
    function EntityCollectionPlugin(query, entityIds) {
        this.query = query;
        this.entityIds = entityIds;
        this.entities = new Map();
    }
    /**
     * Get the entity plugin instance.
     */
    /**
     * Get the entity plugin instance.
     * @param {?} id
     * @return {?}
     */
    EntityCollectionPlugin.prototype.getEntity = /**
     * Get the entity plugin instance.
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return this.entities.get(id);
    };
    /**
     * Whether the entity plugin exist.
     */
    /**
     * Whether the entity plugin exist.
     * @param {?} id
     * @return {?}
     */
    EntityCollectionPlugin.prototype.hasEntity = /**
     * Whether the entity plugin exist.
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return this.entities.has(id);
    };
    /**
     * Remove the entity plugin instance.
     */
    /**
     * Remove the entity plugin instance.
     * @param {?} id
     * @return {?}
     */
    EntityCollectionPlugin.prototype.removeEntity = /**
     * Remove the entity plugin instance.
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return this.entities.delete(id);
    };
    /**
     * Set the entity plugin instance.
     */
    /**
     * Set the entity plugin instance.
     * @param {?} id
     * @param {?} plugin
     * @return {?}
     */
    EntityCollectionPlugin.prototype.createEntity = /**
     * Set the entity plugin instance.
     * @param {?} id
     * @param {?} plugin
     * @return {?}
     */
    function (id, plugin) {
        return this.entities.set(id, plugin);
    };
    /**
     * If the user passes `entityIds` we take them; otherwise, we take all.
     */
    /**
     * If the user passes `entityIds` we take them; otherwise, we take all.
     * @return {?}
     */
    EntityCollectionPlugin.prototype.getIds = /**
     * If the user passes `entityIds` we take them; otherwise, we take all.
     * @return {?}
     */
    function () {
        return isUndefined(this.entityIds) ? this.query.getSnapshot().ids : coerceArray(this.entityIds);
    };
    /**
     * When you call one of the plugin methods, you can pass id/ids or undefined which means all.
     */
    /**
     * When you call one of the plugin methods, you can pass id/ids or undefined which means all.
     * @param {?=} ids
     * @return {?}
     */
    EntityCollectionPlugin.prototype.resolvedIds = /**
     * When you call one of the plugin methods, you can pass id/ids or undefined which means all.
     * @param {?=} ids
     * @return {?}
     */
    function (ids) {
        return isUndefined(ids) ? this.getIds() : coerceArray(ids);
    };
    /**
     * Call this method when you want to activate the plugin on init or when you need to listen to add/remove of entities dynamically.
     *
     * For example in your plugin you may do the following:
     *
     * this.query.select(state => state.ids).pipe(skip(1)).subscribe(ids => this.activate(ids));
     */
    /**
     * Call this method when you want to activate the plugin on init or when you need to listen to add/remove of entities dynamically.
     *
     * For example in your plugin you may do the following:
     *
     * this.query.select(state => state.ids).pipe(skip(1)).subscribe(ids => this.activate(ids));
     * @param {?} ids
     * @param {?=} actions
     * @return {?}
     */
    EntityCollectionPlugin.prototype.rebase = /**
     * Call this method when you want to activate the plugin on init or when you need to listen to add/remove of entities dynamically.
     *
     * For example in your plugin you may do the following:
     *
     * this.query.select(state => state.ids).pipe(skip(1)).subscribe(ids => this.activate(ids));
     * @param {?} ids
     * @param {?=} actions
     * @return {?}
     */
    function (ids, actions) {
        var _this = this;
        if (actions === void 0) { actions = defaultActions; }
        /**
             *
             * If the user passes `entityIds` & we have new ids check if we need to add/remove instances.
             *
             * This phase will be called only upon update.
             */
        if (toBoolean(ids)) {
            /**
                   * Which means all
                   */
            if (isUndefined(this.entityIds)) {
                for (var i = 0, len = ids.length; i < len; i++) {
                    /** @type {?} */
                    var entityId = ids[i];
                    if (this.hasEntity(entityId) === false) {
                        isFunction(actions.beforeAdd) && actions.beforeAdd(entityId);
                        /** @type {?} */
                        var plugin = this.instantiatePlugin(entityId);
                        this.entities.set(entityId, plugin);
                        isFunction(actions.afterAdd) && actions.afterAdd(plugin);
                    }
                }
                this.entities.forEach(function (plugin, entityId) {
                    if (ids.indexOf(entityId) === -1) {
                        isFunction(actions.beforeRemove) && actions.beforeRemove(plugin);
                        _this.removeEntity(entityId);
                    }
                });
            }
            else {
                /** *
                 * Which means the user passes specific ids
                  @type {?} */
                var _ids = coerceArray(this.entityIds);
                for (var i = 0, len = _ids.length; i < len; i++) {
                    /** @type {?} */
                    var entityId = _ids[i];
                    /** The Entity in current ids and doesn't exist, add it. */
                    if (ids.indexOf(entityId) > -1 && this.hasEntity(entityId) === false) {
                        isFunction(actions.beforeAdd) && actions.beforeAdd(entityId);
                        /** @type {?} */
                        var plugin = this.instantiatePlugin(entityId);
                        this.entities.set(entityId, plugin);
                        isFunction(actions.afterAdd) && actions.afterAdd(plugin);
                    }
                    else {
                        this.entities.forEach(function (plugin, entityId) {
                            /** The Entity not in current ids and exists, remove it. */
                            if (ids.indexOf(entityId) === -1 && _this.hasEntity(entityId) === true) {
                                isFunction(actions.beforeRemove) && actions.beforeRemove(plugin);
                                _this.removeEntity(entityId);
                            }
                        });
                    }
                }
            }
        }
        else {
            /**
                   * Otherwise, start with the provided ids or all.
                   */
            this.getIds().forEach(function (id) {
                if (!_this.hasEntity(id))
                    _this.createEntity(id, _this.instantiatePlugin(id));
            });
        }
    };
    /**
     * Listen for add/remove entities.
     */
    /**
     * Listen for add/remove entities.
     * @return {?}
     */
    EntityCollectionPlugin.prototype.selectIds = /**
     * Listen for add/remove entities.
     * @return {?}
     */
    function () {
        return this.query.select(function (state) { return state.ids; });
    };
    /**
     * Base method for activation, you can override it if you need to.
     */
    /**
     * Base method for activation, you can override it if you need to.
     * @param {?=} ids
     * @return {?}
     */
    EntityCollectionPlugin.prototype.activate = /**
     * Base method for activation, you can override it if you need to.
     * @param {?=} ids
     * @return {?}
     */
    function (ids) {
        this.rebase(ids);
    };
    /**
     * Loop over each id and invoke the plugin method.
     */
    /**
     * Loop over each id and invoke the plugin method.
     * @param {?} ids
     * @param {?} cb
     * @return {?}
     */
    EntityCollectionPlugin.prototype.forEachId = /**
     * Loop over each id and invoke the plugin method.
     * @param {?} ids
     * @param {?} cb
     * @return {?}
     */
    function (ids, cb) {
        /** @type {?} */
        var _ids = this.resolvedIds(ids);
        for (var i = 0, len = _ids.length; i < len; i++) {
            /** @type {?} */
            var id = _ids[i];
            if (this.hasEntity(id)) {
                cb(this.getEntity(id));
            }
        }
    };
    return EntityCollectionPlugin;
}());
/**
 * @abstract
 * @template E, P
 */
export { EntityCollectionPlugin };
function EntityCollectionPlugin_tsickle_Closure_declarations() {
    /** @type {?} */
    EntityCollectionPlugin.prototype.entities;
    /** @type {?} */
    EntityCollectionPlugin.prototype.query;
    /** @type {?} */
    EntityCollectionPlugin.prototype.entityIds;
    /**
     * This method is responsible for plugin instantiation.
     *
     * For example:
     * return new StateHistory(this.query, this.params, id) as P;
     * @abstract
     * @param {?} id
     * @return {?}
     */
    EntityCollectionPlugin.prototype.instantiatePlugin = function (id) { };
    /**
     * This method is responsible for cleaning.
     * @abstract
     * @param {?=} id
     * @return {?}
     */
    EntityCollectionPlugin.prototype.destroy = function (id) { };
}
export { ɵ0 };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LWNvbGxlY3Rpb24tcGx1Z2luLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BsdWdpbnMvZW50aXR5LWNvbGxlY3Rpb24tcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUMsV0FBVyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFDLE1BQU0sbUJBQW1CLENBQUM7U0FjN0IsVUFBQSxNQUFNLElBQUksT0FBQSxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQWhCLENBQWdCOztBQUEvRSxJQUFNLGNBQWMsR0FBa0IsRUFBQyxZQUFZLElBQTRCLEVBQUMsQ0FBQzs7Ozs7QUFFakY7Ozs7QUFBQTtJQUdFLGdDQUFnQyxLQUEwQixFQUFVLFNBQWlDO1FBQXJFLFVBQUssR0FBTCxLQUFLLENBQXFCO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBd0I7d0JBRmhGLElBQUksR0FBRyxFQUFTO0tBRW9FO0lBRXpHOztPQUVHOzs7Ozs7SUFDTywwQ0FBUzs7Ozs7SUFBbkIsVUFBb0IsRUFBTTtRQUN4QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQzlCO0lBRUQ7O09BRUc7Ozs7OztJQUNPLDBDQUFTOzs7OztJQUFuQixVQUFvQixFQUFNO1FBQ3hCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDOUI7SUFFRDs7T0FFRzs7Ozs7O0lBQ08sNkNBQVk7Ozs7O0lBQXRCLFVBQXVCLEVBQU07UUFDM0IsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNqQztJQUVEOztPQUVHOzs7Ozs7O0lBQ08sNkNBQVk7Ozs7OztJQUF0QixVQUF1QixFQUFNLEVBQUUsTUFBUztRQUN0QyxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztLQUN0QztJQUVEOztPQUVHOzs7OztJQUNPLHVDQUFNOzs7O0lBQWhCO1FBQ0UsT0FBTyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUNqRztJQUVEOztPQUVHOzs7Ozs7SUFDTyw0Q0FBVzs7Ozs7SUFBckIsVUFBc0IsR0FBSTtRQUN4QixPQUFPLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDNUQ7SUFFRDs7Ozs7O09BTUc7Ozs7Ozs7Ozs7O0lBQ08sdUNBQU07Ozs7Ozs7Ozs7SUFBaEIsVUFBaUIsR0FBUyxFQUFFLE9BQTBDO1FBQXRFLGlCQTREQztRQTVEMkIsd0JBQUEsRUFBQSx3QkFBMEM7Ozs7Ozs7UUFPcEUsSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUU7Ozs7WUFJbEIsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUMvQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFOztvQkFDOUMsSUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUN4QixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssS0FBSyxFQUFFO3dCQUN0QyxVQUFVLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7O3dCQUM3RCxJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7d0JBQ2hELElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQzt3QkFDcEMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO3FCQUMxRDtpQkFDRjtnQkFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQU0sRUFBRSxRQUFRO29CQUNyQyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7d0JBQ2hDLFVBQVUsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQzt3QkFDakUsS0FBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztxQkFDN0I7aUJBQ0YsQ0FBQyxDQUFDO2FBQ0o7aUJBQU07Ozs7Z0JBSUwsSUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDekMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRTs7b0JBQy9DLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzs7b0JBRXpCLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEtBQUssRUFBRTt3QkFDcEUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxPQUFPLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDOzt3QkFDN0QsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO3dCQUNoRCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7d0JBQ3BDLFVBQVUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztxQkFDMUQ7eUJBQU07d0JBQ0wsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBQyxNQUFNLEVBQUUsUUFBUTs7NEJBRXJDLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxLQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtnQ0FDckUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxPQUFPLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dDQUNqRSxLQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDOzZCQUM3Qjt5QkFDRixDQUFDLENBQUM7cUJBQ0o7aUJBQ0Y7YUFDRjtTQUNGO2FBQU07Ozs7WUFJTCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQUEsRUFBRTtnQkFDdEIsSUFBSSxDQUFDLEtBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO29CQUFFLEtBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO2FBQzNFLENBQUMsQ0FBQztTQUNKO0tBQ0Y7SUFFRDs7T0FFRzs7Ozs7SUFDTywwQ0FBUzs7OztJQUFuQjtRQUNFLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQSxLQUFLLElBQUksT0FBQSxLQUFLLENBQUMsR0FBRyxFQUFULENBQVMsQ0FBQyxDQUFDO0tBQzlDO0lBRUQ7O09BRUc7Ozs7OztJQUNPLHlDQUFROzs7OztJQUFsQixVQUFtQixHQUFVO1FBQzNCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDbEI7SUFlRDs7T0FFRzs7Ozs7OztJQUNPLDBDQUFTOzs7Ozs7SUFBbkIsVUFBb0IsR0FBUSxFQUFFLEVBQXNCOztRQUNsRCxJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRW5DLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7O1lBQy9DLElBQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLEVBQUU7Z0JBQ3RCLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDeEI7U0FDRjtLQUNGO2lDQTNLSDtJQTRLQyxDQUFBOzs7OztBQTVKRCxrQ0E0SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2NvZXJjZUFycmF5LCBpc0Z1bmN0aW9uLCBpc1VuZGVmaW5lZCwgdG9Cb29sZWFufSBmcm9tICcuLi9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQge1F1ZXJ5RW50aXR5fSBmcm9tICcuLi9hcGkvcXVlcnktZW50aXR5JztcbmltcG9ydCB7SUQsIElEU30gZnJvbSAnLi4vYXBpL3R5cGVzJztcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5cbi8qKlxuICogRWFjaCBwbHVnaW4gdGhhdCB3YW50cyB0byBhZGQgc3VwcG9ydCBmb3IgZW50aXRpZXMgc2hvdWxkIGV4dGVuZCB0aGlzIGludGVyZmFjZS5cbiAqL1xuZXhwb3J0IHR5cGUgRW50aXR5UGFyYW0gPSBJRDtcblxuZXhwb3J0IHR5cGUgRW50aXR5Q29sbGVjdGlvblBhcmFtcyA9IElEIHwgSURbXTtcblxuZXhwb3J0IHR5cGUgUmViYXNlQWN0aW9uczxQID0gYW55PiA9IHsgYmVmb3JlUmVtb3ZlPzogRnVuY3Rpb247IGJlZm9yZUFkZD86IEZ1bmN0aW9uOyBhZnRlckFkZD86IChwbHVnaW46IFApID0+IGFueTsgfTtcblxuY29uc3QgZGVmYXVsdEFjdGlvbnM6IFJlYmFzZUFjdGlvbnMgPSB7YmVmb3JlUmVtb3ZlOiBwbHVnaW4gPT4gcGx1Z2luLmRlc3Ryb3koKX07XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFbnRpdHlDb2xsZWN0aW9uUGx1Z2luPEUsIFA+IHtcbiAgcHJvdGVjdGVkIGVudGl0aWVzID0gbmV3IE1hcDxJRCwgUD4oKTtcblxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJvdGVjdGVkIHF1ZXJ5OiBRdWVyeUVudGl0eTxhbnksIEU+LCBwcml2YXRlIGVudGl0eUlkczogRW50aXR5Q29sbGVjdGlvblBhcmFtcykge31cblxuICAvKipcbiAgICogR2V0IHRoZSBlbnRpdHkgcGx1Z2luIGluc3RhbmNlLlxuICAgKi9cbiAgcHJvdGVjdGVkIGdldEVudGl0eShpZDogSUQpOiBQIHtcbiAgICByZXR1cm4gdGhpcy5lbnRpdGllcy5nZXQoaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIGVudGl0eSBwbHVnaW4gZXhpc3QuXG4gICAqL1xuICBwcm90ZWN0ZWQgaGFzRW50aXR5KGlkOiBJRCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmVudGl0aWVzLmhhcyhpZCk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHRoZSBlbnRpdHkgcGx1Z2luIGluc3RhbmNlLlxuICAgKi9cbiAgcHJvdGVjdGVkIHJlbW92ZUVudGl0eShpZDogSUQpIHtcbiAgICByZXR1cm4gdGhpcy5lbnRpdGllcy5kZWxldGUoaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgZW50aXR5IHBsdWdpbiBpbnN0YW5jZS5cbiAgICovXG4gIHByb3RlY3RlZCBjcmVhdGVFbnRpdHkoaWQ6IElELCBwbHVnaW46IFApIHtcbiAgICByZXR1cm4gdGhpcy5lbnRpdGllcy5zZXQoaWQsIHBsdWdpbik7XG4gIH1cblxuICAvKipcbiAgICogSWYgdGhlIHVzZXIgcGFzc2VzIGBlbnRpdHlJZHNgIHdlIHRha2UgdGhlbTsgb3RoZXJ3aXNlLCB3ZSB0YWtlIGFsbC5cbiAgICovXG4gIHByb3RlY3RlZCBnZXRJZHMoKTogSURbXSB7XG4gICAgcmV0dXJuIGlzVW5kZWZpbmVkKHRoaXMuZW50aXR5SWRzKSA/IHRoaXMucXVlcnkuZ2V0U25hcHNob3QoKS5pZHMgOiBjb2VyY2VBcnJheSh0aGlzLmVudGl0eUlkcyk7XG4gIH1cblxuICAvKipcbiAgICogV2hlbiB5b3UgY2FsbCBvbmUgb2YgdGhlIHBsdWdpbiBtZXRob2RzLCB5b3UgY2FuIHBhc3MgaWQvaWRzIG9yIHVuZGVmaW5lZCB3aGljaCBtZWFucyBhbGwuXG4gICAqL1xuICBwcm90ZWN0ZWQgcmVzb2x2ZWRJZHMoaWRzPyk6IElEW10ge1xuICAgIHJldHVybiBpc1VuZGVmaW5lZChpZHMpID8gdGhpcy5nZXRJZHMoKSA6IGNvZXJjZUFycmF5KGlkcyk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsbCB0aGlzIG1ldGhvZCB3aGVuIHlvdSB3YW50IHRvIGFjdGl2YXRlIHRoZSBwbHVnaW4gb24gaW5pdCBvciB3aGVuIHlvdSBuZWVkIHRvIGxpc3RlbiB0byBhZGQvcmVtb3ZlIG9mIGVudGl0aWVzIGR5bmFtaWNhbGx5LlxuICAgKlxuICAgKiBGb3IgZXhhbXBsZSBpbiB5b3VyIHBsdWdpbiB5b3UgbWF5IGRvIHRoZSBmb2xsb3dpbmc6XG4gICAqXG4gICAqIHRoaXMucXVlcnkuc2VsZWN0KHN0YXRlID0+IHN0YXRlLmlkcykucGlwZShza2lwKDEpKS5zdWJzY3JpYmUoaWRzID0+IHRoaXMuYWN0aXZhdGUoaWRzKSk7XG4gICAqL1xuICBwcm90ZWN0ZWQgcmViYXNlKGlkczogSURbXSwgYWN0aW9uczogUmViYXNlQWN0aW9uczxQPiA9IGRlZmF1bHRBY3Rpb25zKSB7XG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBJZiB0aGUgdXNlciBwYXNzZXMgYGVudGl0eUlkc2AgJiB3ZSBoYXZlIG5ldyBpZHMgY2hlY2sgaWYgd2UgbmVlZCB0byBhZGQvcmVtb3ZlIGluc3RhbmNlcy5cbiAgICAgKlxuICAgICAqIFRoaXMgcGhhc2Ugd2lsbCBiZSBjYWxsZWQgb25seSB1cG9uIHVwZGF0ZS5cbiAgICAgKi9cbiAgICBpZiAodG9Cb29sZWFuKGlkcykpIHtcbiAgICAgIC8qKlxuICAgICAgICogV2hpY2ggbWVhbnMgYWxsXG4gICAgICAgKi9cbiAgICAgIGlmIChpc1VuZGVmaW5lZCh0aGlzLmVudGl0eUlkcykpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGlkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgIGNvbnN0IGVudGl0eUlkID0gaWRzW2ldO1xuICAgICAgICAgIGlmICh0aGlzLmhhc0VudGl0eShlbnRpdHlJZCkgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICBpc0Z1bmN0aW9uKGFjdGlvbnMuYmVmb3JlQWRkKSAmJiBhY3Rpb25zLmJlZm9yZUFkZChlbnRpdHlJZCk7XG4gICAgICAgICAgICBjb25zdCBwbHVnaW4gPSB0aGlzLmluc3RhbnRpYXRlUGx1Z2luKGVudGl0eUlkKTtcbiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuc2V0KGVudGl0eUlkLCBwbHVnaW4pO1xuICAgICAgICAgICAgaXNGdW5jdGlvbihhY3Rpb25zLmFmdGVyQWRkKSAmJiBhY3Rpb25zLmFmdGVyQWRkKHBsdWdpbik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5lbnRpdGllcy5mb3JFYWNoKChwbHVnaW4sIGVudGl0eUlkKSA9PiB7XG4gICAgICAgICAgaWYgKGlkcy5pbmRleE9mKGVudGl0eUlkKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIGlzRnVuY3Rpb24oYWN0aW9ucy5iZWZvcmVSZW1vdmUpICYmIGFjdGlvbnMuYmVmb3JlUmVtb3ZlKHBsdWdpbik7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUVudGl0eShlbnRpdHlJZCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBXaGljaCBtZWFucyB0aGUgdXNlciBwYXNzZXMgc3BlY2lmaWMgaWRzXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBfaWRzID0gY29lcmNlQXJyYXkodGhpcy5lbnRpdHlJZHMpO1xuICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gX2lkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgIGNvbnN0IGVudGl0eUlkID0gX2lkc1tpXTtcbiAgICAgICAgICAvKiogVGhlIEVudGl0eSBpbiBjdXJyZW50IGlkcyBhbmQgZG9lc24ndCBleGlzdCwgYWRkIGl0LiAqL1xuICAgICAgICAgIGlmIChpZHMuaW5kZXhPZihlbnRpdHlJZCkgPiAtMSAmJiB0aGlzLmhhc0VudGl0eShlbnRpdHlJZCkgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICBpc0Z1bmN0aW9uKGFjdGlvbnMuYmVmb3JlQWRkKSAmJiBhY3Rpb25zLmJlZm9yZUFkZChlbnRpdHlJZCk7XG4gICAgICAgICAgICBjb25zdCBwbHVnaW4gPSB0aGlzLmluc3RhbnRpYXRlUGx1Z2luKGVudGl0eUlkKTtcbiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuc2V0KGVudGl0eUlkLCBwbHVnaW4pO1xuICAgICAgICAgICAgaXNGdW5jdGlvbihhY3Rpb25zLmFmdGVyQWRkKSAmJiBhY3Rpb25zLmFmdGVyQWRkKHBsdWdpbik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZW50aXRpZXMuZm9yRWFjaCgocGx1Z2luLCBlbnRpdHlJZCkgPT4ge1xuICAgICAgICAgICAgICAvKiogVGhlIEVudGl0eSBub3QgaW4gY3VycmVudCBpZHMgYW5kIGV4aXN0cywgcmVtb3ZlIGl0LiAqL1xuICAgICAgICAgICAgICBpZiAoaWRzLmluZGV4T2YoZW50aXR5SWQpID09PSAtMSAmJiB0aGlzLmhhc0VudGl0eShlbnRpdHlJZCkgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGFjdGlvbnMuYmVmb3JlUmVtb3ZlKSAmJiBhY3Rpb25zLmJlZm9yZVJlbW92ZShwbHVnaW4pO1xuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlRW50aXR5KGVudGl0eUlkKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8qKlxuICAgICAgICogT3RoZXJ3aXNlLCBzdGFydCB3aXRoIHRoZSBwcm92aWRlZCBpZHMgb3IgYWxsLlxuICAgICAgICovXG4gICAgICB0aGlzLmdldElkcygpLmZvckVhY2goaWQgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuaGFzRW50aXR5KGlkKSkgdGhpcy5jcmVhdGVFbnRpdHkoaWQsIHRoaXMuaW5zdGFudGlhdGVQbHVnaW4oaWQpKVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExpc3RlbiBmb3IgYWRkL3JlbW92ZSBlbnRpdGllcy5cbiAgICovXG4gIHByb3RlY3RlZCBzZWxlY3RJZHMoKTogT2JzZXJ2YWJsZTxJRFtdPiB7XG4gICAgcmV0dXJuIHRoaXMucXVlcnkuc2VsZWN0KHN0YXRlID0+IHN0YXRlLmlkcyk7XG4gIH1cblxuICAvKipcbiAgICogQmFzZSBtZXRob2QgZm9yIGFjdGl2YXRpb24sIHlvdSBjYW4gb3ZlcnJpZGUgaXQgaWYgeW91IG5lZWQgdG8uXG4gICAqL1xuICBwcm90ZWN0ZWQgYWN0aXZhdGUoaWRzPzogSURbXSkge1xuICAgIHRoaXMucmViYXNlKGlkcyk7XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgaXMgcmVzcG9uc2libGUgZm9yIHBsdWdpbiBpbnN0YW50aWF0aW9uLlxuICAgKlxuICAgKiBGb3IgZXhhbXBsZTpcbiAgICogcmV0dXJuIG5ldyBTdGF0ZUhpc3RvcnkodGhpcy5xdWVyeSwgdGhpcy5wYXJhbXMsIGlkKSBhcyBQO1xuICAgKi9cbiAgcHJvdGVjdGVkIGFic3RyYWN0IGluc3RhbnRpYXRlUGx1Z2luKGlkOiBJRCk6IFA7XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIGlzIHJlc3BvbnNpYmxlIGZvciBjbGVhbmluZy5cbiAgICovXG4gIHB1YmxpYyBhYnN0cmFjdCBkZXN0cm95KGlkPzogSUQpO1xuXG4gIC8qKlxuICAgKiBMb29wIG92ZXIgZWFjaCBpZCBhbmQgaW52b2tlIHRoZSBwbHVnaW4gbWV0aG9kLlxuICAgKi9cbiAgcHJvdGVjdGVkIGZvckVhY2hJZChpZHM6IElEUywgY2I6IChlbnRpdHk6IFApID0+IGFueSkge1xuICAgIGNvbnN0IF9pZHMgPSB0aGlzLnJlc29sdmVkSWRzKGlkcyk7XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gX2lkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgY29uc3QgaWQgPSBfaWRzW2ldO1xuICAgICAgaWYgKHRoaXMuaGFzRW50aXR5KGlkKSkge1xuICAgICAgICBjYih0aGlzLmdldEVudGl0eShpZCkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19