/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { pairwise } from 'rxjs/operators';
import { __globalState } from '../../internal/global-state';
import { toBoolean } from '../../internal/utils';
import { AkitaPlugin } from '../plugin';
/**
 * @record
 */
export function StateHistoryParams() { }
function StateHistoryParams_tsickle_Closure_declarations() {
    /** @type {?|undefined} */
    StateHistoryParams.prototype.maxAge;
}
/**
 * @template E, S
 */
var /**
 * @template E, S
 */
StateHistoryPlugin = /** @class */ (function (_super) {
    tslib_1.__extends(StateHistoryPlugin, _super);
    function StateHistoryPlugin(query, params, _entityId) {
        if (params === void 0) { params = {}; }
        var _this = _super.call(this, query) || this;
        _this.query = query;
        _this.params = params;
        _this._entityId = _entityId;
        /**
         * Allow skipping an update from outside
         */
        _this.skip = false;
        _this.history = {
            past: [],
            present: null,
            future: []
        };
        /**
         * Skip the update when redo/undo
         */
        _this.skipUpdate = false;
        params.maxAge = toBoolean(params.maxAge) ? params.maxAge : 10;
        _this.activate();
        return _this;
    }
    Object.defineProperty(StateHistoryPlugin.prototype, "hasPast", {
        get: /**
         * @return {?}
         */
        function () {
            return this.history.past.length > 0;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StateHistoryPlugin.prototype, "hasFuture", {
        get: /**
         * @return {?}
         */
        function () {
            return this.history.future.length > 0;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    StateHistoryPlugin.prototype.activate = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.history.present = this.getSource(this._entityId);
        this.subscription = this.selectSource(this._entityId)
            .pipe(pairwise())
            .subscribe(function (_a) {
            var _b = tslib_1.__read(_a, 2), past = _b[0], present = _b[1];
            if (_this.skip) {
                _this.skip = false;
                return;
            }
            if (!_this.skipUpdate) {
                if (_this.history.past.length === _this.params.maxAge) {
                    _this.history.past = _this.history.past.slice(1);
                }
                _this.history.past = tslib_1.__spread(_this.history.past, [past]);
                _this.history.present = present;
            }
        });
    };
    /**
     * @return {?}
     */
    StateHistoryPlugin.prototype.undo = /**
     * @return {?}
     */
    function () {
        if (this.history.past.length > 0) {
            var _a = this.history, past = _a.past, present = _a.present, future = _a.future;
            /** @type {?} */
            var previous = past[past.length - 1];
            /** @type {?} */
            var newPast = past.slice(0, past.length - 1);
            this.history.past = newPast;
            this.history.present = previous;
            this.history.future = tslib_1.__spread([present], this.history.future);
            this.update();
        }
    };
    /**
     * @return {?}
     */
    StateHistoryPlugin.prototype.redo = /**
     * @return {?}
     */
    function () {
        if (this.history.future.length > 0) {
            var _a = this.history, past = _a.past, present = _a.present, future = _a.future;
            /** @type {?} */
            var next = this.history.future[0];
            /** @type {?} */
            var newFuture = this.history.future.slice(1);
            this.history.past = tslib_1.__spread(past, [present]);
            this.history.present = next;
            this.history.future = newFuture;
            this.update('Redo');
        }
    };
    /**
     * @param {?} index
     * @return {?}
     */
    StateHistoryPlugin.prototype.jumpToPast = /**
     * @param {?} index
     * @return {?}
     */
    function (index) {
        if (index < 0 || index >= this.history.past.length)
            return;
        var _a = this.history, past = _a.past, future = _a.future;
        /** *
         *
         * const past = [1, 2, 3, 4, 5];
         *
         * newPast = past.slice(0, 2) = [1, 2];
         * present = past[index] = 3;
         * [...past.slice(2 + 1), ...future] = [4, 5];
         *
          @type {?} */
        var newPast = past.slice(0, index);
        /** @type {?} */
        var newFuture = tslib_1.__spread(past.slice(index + 1), future);
        /** @type {?} */
        var newPresent = past[index];
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update();
    };
    /**
     * @param {?} index
     * @return {?}
     */
    StateHistoryPlugin.prototype.jumpToFuture = /**
     * @param {?} index
     * @return {?}
     */
    function (index) {
        if (index < 0 || index >= this.history.future.length)
            return;
        var _a = this.history, past = _a.past, future = _a.future;
        /** @type {?} */
        var newPast = tslib_1.__spread(past, future.slice(0, index));
        /** @type {?} */
        var newPresent = future[index];
        /** @type {?} */
        var newFuture = future.slice(index + 1);
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update('Redo');
    };
    /**
     * @return {?}
     */
    StateHistoryPlugin.prototype.clear = /**
     * @return {?}
     */
    function () {
        this.history = {
            past: [],
            present: null,
            future: []
        };
    };
    /**
     * @param {?=} clearHistory
     * @return {?}
     */
    StateHistoryPlugin.prototype.destroy = /**
     * @param {?=} clearHistory
     * @return {?}
     */
    function (clearHistory) {
        if (clearHistory === void 0) { clearHistory = false; }
        if (clearHistory) {
            this.clear();
        }
        this.subscription.unsubscribe();
    };
    /**
     * @return {?}
     */
    StateHistoryPlugin.prototype.ignoreNext = /**
     * @return {?}
     */
    function () {
        this.skip = true;
    };
    /**
     * @param {?=} action
     * @return {?}
     */
    StateHistoryPlugin.prototype.update = /**
     * @param {?=} action
     * @return {?}
     */
    function (action) {
        if (action === void 0) { action = 'Undo'; }
        this.skipUpdate = true;
        __globalState.setCustomAction({ type: "@StateHistory - " + action });
        this.updateStore(this.history.present, this._entityId);
        this.skipUpdate = false;
    };
    return StateHistoryPlugin;
}(AkitaPlugin));
/**
 * @template E, S
 */
export { StateHistoryPlugin };
function StateHistoryPlugin_tsickle_Closure_declarations() {
    /**
     * Allow skipping an update from outside
     * @type {?}
     */
    StateHistoryPlugin.prototype.skip;
    /** @type {?} */
    StateHistoryPlugin.prototype.history;
    /**
     * Skip the update when redo/undo
     * @type {?}
     */
    StateHistoryPlugin.prototype.skipUpdate;
    /** @type {?} */
    StateHistoryPlugin.prototype.subscription;
    /** @type {?} */
    StateHistoryPlugin.prototype.query;
    /** @type {?} */
    StateHistoryPlugin.prototype.params;
    /** @type {?} */
    StateHistoryPlugin.prototype._entityId;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtaGlzdG9yeS1wbHVnaW4uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvcGx1Z2lucy9zdGF0ZS1oaXN0b3J5L3N0YXRlLWhpc3RvcnktcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFVLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDakQsT0FBTyxFQUFFLFdBQVcsRUFBVyxNQUFNLFdBQVcsQ0FBQzs7Ozs7Ozs7Ozs7O0FBT2pEOzs7QUFBQTtJQUEwRCw4Q0FBaUI7SUFjekUsNEJBQXNCLEtBQW9CLEVBQVUsTUFBK0IsRUFBVSxTQUF1Qjs0Q0FBakM7UUFBbkYsWUFDRSxrQkFBTSxLQUFLLENBQUMsU0FHYjtRQUpxQixXQUFLLEdBQUwsS0FBSyxDQUFlO1FBQVUsWUFBTSxHQUFOLE1BQU0sQ0FBeUI7UUFBVSxlQUFTLEdBQVQsU0FBUyxDQUFjOzs7O3FCQVpyRyxLQUFLO3dCQUVGO1lBQ2hCLElBQUksRUFBRSxFQUFFO1lBQ1IsT0FBTyxFQUFFLElBQUk7WUFDYixNQUFNLEVBQUUsRUFBRTtTQUNYOzs7OzJCQUdvQixLQUFLO1FBS3hCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzlELEtBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzs7S0FDakI7SUFFRCxzQkFBSSx1Q0FBTzs7OztRQUFYO1lBQ0UsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1NBQ3JDOzs7T0FBQTtJQUVELHNCQUFJLHlD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QzVCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQztRQUNsQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7UUFDaEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUNyQjs7OztJQUVELGtDQUFLOzs7SUFBTDtRQUNFLElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDYixJQUFJLEVBQUUsRUFBRTtZQUNSLE9BQU8sRUFBRSxJQUFJO1lBQ2IsTUFBTSxFQUFFLEVBQUU7U0FDWCxDQUFDO0tBQ0g7Ozs7O0lBRUQsb0NBQU87Ozs7SUFBUCxVQUFRLFlBQW9CO1FBQXBCLDZCQUFBLEVBQUEsb0JBQW9CO1FBQzFCLElBQUksWUFBWSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNkO1FBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztLQUNqQzs7OztJQUVELHVDQUFVOzs7SUFBVjtRQUNFLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0tBQ2xCOzs7OztJQUVPLG1DQUFNOzs7O2NBQUMsTUFBZTtRQUFmLHVCQUFBLEVBQUEsZUFBZTtRQUM1QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixhQUFhLENBQUMsZUFBZSxDQUFDLEVBQUUsSUFBSSxFQUFFLHFCQUFtQixNQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDOzs2QkE5STVCO0VBVTBELFdBQVcsRUFzSXBFLENBQUE7Ozs7QUF0SUQsOEJBc0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZmlsdGVyLCBwYWlyd2lzZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IF9fZ2xvYmFsU3RhdGUgfSBmcm9tICcuLi8uLi9pbnRlcm5hbC9nbG9iYWwtc3RhdGUnO1xuaW1wb3J0IHsgdG9Cb29sZWFuIH0gZnJvbSAnLi4vLi4vaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHsgQWtpdGFQbHVnaW4sIFF1ZXJpZXMgfSBmcm9tICcuLi9wbHVnaW4nO1xuaW1wb3J0IHsgRW50aXR5UGFyYW0gfSBmcm9tICcuLi9lbnRpdHktY29sbGVjdGlvbi1wbHVnaW4nO1xuXG5leHBvcnQgaW50ZXJmYWNlIFN0YXRlSGlzdG9yeVBhcmFtcyB7XG4gIG1heEFnZT86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFN0YXRlSGlzdG9yeVBsdWdpbjxFID0gYW55LCBTID0gYW55PiBleHRlbmRzIEFraXRhUGx1Z2luPEUsIFM+IHtcbiAgLyoqIEFsbG93IHNraXBwaW5nIGFuIHVwZGF0ZSBmcm9tIG91dHNpZGUgKi9cbiAgcHJpdmF0ZSBza2lwID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBoaXN0b3J5ID0ge1xuICAgIHBhc3Q6IFtdLFxuICAgIHByZXNlbnQ6IG51bGwsXG4gICAgZnV0dXJlOiBbXVxuICB9O1xuXG4gIC8qKiBTa2lwIHRoZSB1cGRhdGUgd2hlbiByZWRvL3VuZG8gKi9cbiAgcHJpdmF0ZSBza2lwVXBkYXRlID0gZmFsc2U7XG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBxdWVyeTogUXVlcmllczxFLCBTPiwgcHJpdmF0ZSBwYXJhbXM6IFN0YXRlSGlzdG9yeVBhcmFtcyA9IHt9LCBwcml2YXRlIF9lbnRpdHlJZD86IEVudGl0eVBhcmFtKSB7XG4gICAgc3VwZXIocXVlcnkpO1xuICAgIHBhcmFtcy5tYXhBZ2UgPSB0b0Jvb2xlYW4ocGFyYW1zLm1heEFnZSkgPyBwYXJhbXMubWF4QWdlIDogMTA7XG4gICAgdGhpcy5hY3RpdmF0ZSgpO1xuICB9XG5cbiAgZ2V0IGhhc1Bhc3QoKSB7XG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeS5wYXN0Lmxlbmd0aCA+IDA7XG4gIH1cblxuICBnZXQgaGFzRnV0dXJlKCkge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnkuZnV0dXJlLmxlbmd0aCA+IDA7XG4gIH1cblxuICBhY3RpdmF0ZSgpIHtcbiAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IHRoaXMuZ2V0U291cmNlKHRoaXMuX2VudGl0eUlkKTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMuc2VsZWN0U291cmNlKHRoaXMuX2VudGl0eUlkKVxuICAgICAgLnBpcGUocGFpcndpc2UoKSlcbiAgICAgIC5zdWJzY3JpYmUoKFtwYXN0LCBwcmVzZW50XSkgPT4ge1xuICAgICAgICBpZiAodGhpcy5za2lwKSB7XG4gICAgICAgICAgdGhpcy5za2lwID0gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5za2lwVXBkYXRlKSB7XG4gICAgICAgICAgaWYgKHRoaXMuaGlzdG9yeS5wYXN0Lmxlbmd0aCA9PT0gdGhpcy5wYXJhbXMubWF4QWdlKSB7XG4gICAgICAgICAgICB0aGlzLmhpc3RvcnkucGFzdCA9IHRoaXMuaGlzdG9yeS5wYXN0LnNsaWNlKDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmhpc3RvcnkucGFzdCA9IFsuLi50aGlzLmhpc3RvcnkucGFzdCwgcGFzdF07XG4gICAgICAgICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSBwcmVzZW50O1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIHVuZG8oKSB7XG4gICAgaWYgKHRoaXMuaGlzdG9yeS5wYXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHsgcGFzdCwgcHJlc2VudCwgZnV0dXJlIH0gPSB0aGlzLmhpc3Rvcnk7XG4gICAgICBjb25zdCBwcmV2aW91cyA9IHBhc3RbcGFzdC5sZW5ndGggLSAxXTtcbiAgICAgIGNvbnN0IG5ld1Bhc3QgPSBwYXN0LnNsaWNlKDAsIHBhc3QubGVuZ3RoIC0gMSk7XG5cbiAgICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gbmV3UGFzdDtcbiAgICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gcHJldmlvdXM7XG4gICAgICB0aGlzLmhpc3RvcnkuZnV0dXJlID0gW3ByZXNlbnQsIC4uLnRoaXMuaGlzdG9yeS5mdXR1cmVdO1xuICAgICAgdGhpcy51cGRhdGUoKTtcbiAgICB9XG4gIH1cblxuICByZWRvKCkge1xuICAgIGlmICh0aGlzLmhpc3RvcnkuZnV0dXJlLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHsgcGFzdCwgcHJlc2VudCwgZnV0dXJlIH0gPSB0aGlzLmhpc3Rvcnk7XG4gICAgICBjb25zdCBuZXh0ID0gdGhpcy5oaXN0b3J5LmZ1dHVyZVswXTtcbiAgICAgIGNvbnN0IG5ld0Z1dHVyZSA9IHRoaXMuaGlzdG9yeS5mdXR1cmUuc2xpY2UoMSk7XG4gICAgICB0aGlzLmhpc3RvcnkucGFzdCA9IFsuLi5wYXN0LCBwcmVzZW50XTtcbiAgICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gbmV4dDtcbiAgICAgIHRoaXMuaGlzdG9yeS5mdXR1cmUgPSBuZXdGdXR1cmU7XG4gICAgICB0aGlzLnVwZGF0ZSgnUmVkbycpO1xuICAgIH1cbiAgfVxuXG4gIGp1bXBUb1Bhc3QoaW5kZXg6IG51bWJlcikge1xuICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5oaXN0b3J5LnBhc3QubGVuZ3RoKSByZXR1cm47XG5cbiAgICBjb25zdCB7IHBhc3QsIGZ1dHVyZSB9ID0gdGhpcy5oaXN0b3J5O1xuICAgIC8qKlxuICAgICAqXG4gICAgICogY29uc3QgcGFzdCA9IFsxLCAyLCAzLCA0LCA1XTtcbiAgICAgKlxuICAgICAqIG5ld1Bhc3QgPSBwYXN0LnNsaWNlKDAsIDIpID0gWzEsIDJdO1xuICAgICAqIHByZXNlbnQgPSBwYXN0W2luZGV4XSA9IDM7XG4gICAgICogWy4uLnBhc3Quc2xpY2UoMiArIDEpLCAuLi5mdXR1cmVdID0gWzQsIDVdO1xuICAgICAqXG4gICAgICovXG4gICAgY29uc3QgbmV3UGFzdCA9IHBhc3Quc2xpY2UoMCwgaW5kZXgpO1xuICAgIGNvbnN0IG5ld0Z1dHVyZSA9IFsuLi5wYXN0LnNsaWNlKGluZGV4ICsgMSksIC4uLmZ1dHVyZV07XG4gICAgY29uc3QgbmV3UHJlc2VudCA9IHBhc3RbaW5kZXhdO1xuICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gbmV3UGFzdDtcbiAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IG5ld1ByZXNlbnQ7XG4gICAgdGhpcy5oaXN0b3J5LmZ1dHVyZSA9IG5ld0Z1dHVyZTtcbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9XG5cbiAganVtcFRvRnV0dXJlKGluZGV4OiBudW1iZXIpIHtcbiAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID49IHRoaXMuaGlzdG9yeS5mdXR1cmUubGVuZ3RoKSByZXR1cm47XG5cbiAgICBjb25zdCB7IHBhc3QsIGZ1dHVyZSB9ID0gdGhpcy5oaXN0b3J5O1xuXG4gICAgY29uc3QgbmV3UGFzdCA9IFsuLi5wYXN0LCAuLi5mdXR1cmUuc2xpY2UoMCwgaW5kZXgpXTtcbiAgICBjb25zdCBuZXdQcmVzZW50ID0gZnV0dXJlW2luZGV4XTtcbiAgICBjb25zdCBuZXdGdXR1cmUgPSBmdXR1cmUuc2xpY2UoaW5kZXggKyAxKTtcblxuICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gbmV3UGFzdDtcbiAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IG5ld1ByZXNlbnQ7XG4gICAgdGhpcy5oaXN0b3J5LmZ1dHVyZSA9IG5ld0Z1dHVyZTtcbiAgICB0aGlzLnVwZGF0ZSgnUmVkbycpO1xuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgdGhpcy5oaXN0b3J5ID0ge1xuICAgICAgcGFzdDogW10sXG4gICAgICBwcmVzZW50OiBudWxsLFxuICAgICAgZnV0dXJlOiBbXVxuICAgIH07XG4gIH1cblxuICBkZXN0cm95KGNsZWFySGlzdG9yeSA9IGZhbHNlKSB7XG4gICAgaWYgKGNsZWFySGlzdG9yeSkge1xuICAgICAgdGhpcy5jbGVhcigpO1xuICAgIH1cbiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgaWdub3JlTmV4dCgpIHtcbiAgICB0aGlzLnNraXAgPSB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGUoYWN0aW9uID0gJ1VuZG8nKSB7XG4gICAgdGhpcy5za2lwVXBkYXRlID0gdHJ1ZTtcbiAgICBfX2dsb2JhbFN0YXRlLnNldEN1c3RvbUFjdGlvbih7IHR5cGU6IGBAU3RhdGVIaXN0b3J5IC0gJHthY3Rpb259YCB9KTtcbiAgICB0aGlzLnVwZGF0ZVN0b3JlKHRoaXMuaGlzdG9yeS5wcmVzZW50LCB0aGlzLl9lbnRpdHlJZCk7XG4gICAgdGhpcy5za2lwVXBkYXRlID0gZmFsc2U7XG4gIH1cbn1cbiJdfQ==