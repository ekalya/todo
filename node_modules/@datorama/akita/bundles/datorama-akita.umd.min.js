!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@datorama/akita",["exports","rxjs","rxjs/operators"],e):e((t.datorama=t.datorama||{},t.datorama.akita={}),t.rxjs,t.rxjs.operators)}(this,function(t,a,v){"use strict";var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};function u(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var m=Object.assign||function m(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t};function b(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&(n[i[r]]=t[i[r]])}return n}function n(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function P(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(i=o.next()).done;)s.push(i.value)}catch(a){r={error:a}}finally{try{i&&!i.done&&(n=o["return"])&&n.call(o)}finally{if(r)throw r.error}}return s}function c(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(P(arguments[e]));return t}function p(t){return Array.isArray(t)?t:[t]}function f(t){return"[object Object]"===Object.prototype.toString.call(t)}function S(t){return h(t)&&"Object"===t.constructor.name}function O(t){return"function"==typeof t}function h(t){return null!=t&&""+t!="false"}function y(t){return void 0===t}function l(t,e){return e.hasOwnProperty(t)}function d(t){return h(t)&&O(t.subscribe)}function o(t){return"string"==typeof t}function r(t){return"number"==typeof t}function g(t){return null!=t}function _(t){return e(t)&&!1===l(t.active,t.entities)}function e(t){return t.hasOwnProperty("active")}var A=function(t,e,i){var n=e.split(".");if(1===n.length)return i;t=m({},t);var r=n.length-2;return e.split(".").slice(1).reduce(function(t,e,n){return t[e]=n===r?i:m({},t[e]),t&&t[e]},t),t},E=function(t,e){return 1===e.split(".").length?t:e.split(".").slice(1).join(".").split(".").reduce(function(t,e){return t&&t[e]},t)},w=function(e){function t(t){return e.call(this,t)||this}return u(t,e),t}(Error),s=function(e){function t(t){return e.call(this,"The new state should be immutable. Make sure to return a new immutable state. \n store: \n "+t)||this}return u(t,e),t}(w),j=function(e){function t(t){return e.call(this,"Entity "+t+" does not exists")||this}return u(t,e),t}(w),x=function(t){function e(){return t.call(this,"Active is null/undefined")||this}return u(e,t),e}(w),I=function(t){function e(){return t.call(this,"Entity state is invalid")||this}return u(e,t),e}(w),k=function(t){function e(){return t.call(this,"Updating entity id is not permitted when updating many entities")||this}return u(e,t),e}(w);function T(t,e){if(!l(t,e))throw new j(t)}var C=new(function(){function t(){}return t.prototype._set=function(t,e,n,i){var r,o;if(e.ids&&e.entities)r=e.ids,o=e.entities;else{var s=Array.isArray(e);o=e,s?o=this.keyBy(e,n,i):function a(t){if(!f(t))throw new I}(e),r=s?e.map(function(t){return t[i]}):Object.keys(o).map(function(t){return e[t][i]})}var u=m({},t,{entities:o,ids:r,loading:!1});return _(u)&&(u.active=null),u},t.prototype._replaceEntity=function(t,e,n){var i;return m({},t,{entities:m({},t.entities,(i={},i[e]=n,i))})},t.prototype._add=function(t,e,n){for(var i={},r=[],o=0;o<e.length;o++){var s=e[o],a=s[n];l(a,t.entities)||(i[a]=s,r.push(a))}return m({},t,{entities:m({},t.entities,i),ids:c(t.ids,r)})},t.prototype._update=function(t,e,n,i){for(var r,o={},s=!1,a=0;a<e.length;a++){var u=e[a];T(r=u,t.entities);var c=t.entities[u],p=O(n)?n(c):n;if(p.hasOwnProperty(i)&&p[i]!==c[i]){if(1<e.length)throw new k;s=!0,r=p[i]}var f=void 0,h=m({},c,p);f=S(c)?h:new c.constructor(h),o[r]=f}var y=t.ids,l=t.entities;if(s){var d=P(e,1)[0],g=t.entities,v=d;g[v];l=b(g,["symbol"==typeof v?v:v+""]),y=t.ids.map(function(t){return t===d?r:t})}return m({},t,{entities:m({},l,o),ids:y})},t.prototype._remove=function(t,e){if(!e)return this._removeAll(t);var n=e.reduce(function(t,e){var n=e;t[n];return b(t,["symbol"==typeof n?n:n+""])},t.entities),i=m({},t,{entities:n,ids:t.ids.filter(function(t){return-1===e.indexOf(t)})});return _(i)&&(i.active=null),i},t.prototype._removeAll=function(t){return m({},t,{entities:{},ids:[],active:null})},t.prototype.keyBy=function(t,e,n){void 0===n&&(n="id");for(var i={},r=0,o=t.length;r<o;r++){var s=t[r];i[s[n]]=e?new e(s):s}return i},t}()),N=function(){function t(){this.skipAction=!1,this.skipTransactionMsg=!1,this.currentT=[],this.activeTransactions=0}return t.prototype.setAction=function(t){this.customAction?(this.currentAction=this.customAction,this.customAction=null,this.skipTransactionMsg=!1):0===this.activeTransactions&&(this.currentAction=t),0<this.activeTransactions&&this.currentT.push(t)},t.prototype.setCustomAction=function(t,e){void 0===e&&(e=!1),this.currentAction=this.customAction=t,this.skipTransactionMsg=e},t.prototype.setSkipAction=function(t){void 0===t&&(t=!0),this.skipAction=t},t}(),D=new N;function B(){return 0<D.activeTransactions}var F="akitaConfig";var K=!0,M={},U=new a.ReplaySubject;function R(t,e){return void 0===e&&(e=!1),{type:1,payload:{name:t,initialState:e}}}function q(){return K}var H=function(){function t(t){this.inTransaction=!1,this._isPristine=!0,D.setAction({type:"@@INIT"}),(M[this.storeName]=this).setState(function(){return t}),U.next({type:0,payload:{store:this}}),q()&&function e(t,e){t||console.error("@StoreConfig({ name }) is missing in "+e)}(this.storeName,this.constructor.name)}return t.prototype.setLoading=function(e){void 0===e&&(e=!1),e!==this._value().loading&&(q()&&D.setAction({type:"Set Loading"}),this.setState(function(t){return m({},t,{loading:e})}))},t.prototype.setError=function(e){e!==this._value().error&&(q()&&D.setAction({type:"Set Error"}),this.setState(function(t){return m({},t,{error:e})}))},t.prototype._select=function(t){return this.store$.pipe(v.map(t),v.distinctUntilChanged())},t.prototype._value=function(){return this.storeValue},Object.defineProperty(t.prototype,"config",{get:function(){return this.constructor[F]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"storeName",{get:function(){return this.config&&this.config.storeName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPristine",{get:function(){return this._isPristine},enumerable:!0,configurable:!0}),t.prototype.setState=function(t,e){void 0===e&&(e=!0);var n=this._value();if(this.storeValue=K?function i(e){return Object.freeze(e),Object.getOwnPropertyNames(e).forEach(function(t){!e.hasOwnProperty(t)||null===e[t]||"object"!=typeof e[t]&&"function"!=typeof e[t]||Object.isFrozen(e[t])||i(e[t])}),e}(t(this._value())):t(this._value()),n===this.storeValue)throw new s(this.storeName);if(!this.store)return this.store=new a.BehaviorSubject(this.storeValue),void U.next(R(this.storeName,!0));B()?this.handleTransaction():this.dispatch(this.storeValue,e)},t.prototype.update=function(i,t){D.setAction({type:"Update Store"}),this.setState(function(t){var e=O(i)?i(t):i,n=Object.assign({},t,e);return S(t)?n:new t.constructor(n)}),this.setDirty()},t.prototype.setPristine=function(){this._isPristine=!0},t.prototype.setDirty=function(){this._isPristine=!1},t.prototype.dispatch=function(t,e){void 0===e&&(e=!0),this.store.next(t),e&&(U.next(R(this.storeName)),q()&&D.setAction({type:"Set State"}))},Object.defineProperty(t.prototype,"store$",{get:function(){return this.store.asObservable()},enumerable:!0,configurable:!0}),t.prototype.watchTransaction=function(){var t=this;(function e(){return D.batchTransaction?D.batchTransaction.asObservable():a.of(!0)})().subscribe(function(){t.inTransaction=!1,q()&&!D.skipTransactionMsg&&D.setAction({type:"@Transaction"}),t.dispatch(t._value()),D.currentT=[],D.skipTransactionMsg=!1})},t.prototype.handleTransaction=function(){this.inTransaction||(this.watchTransaction(),this.inTransaction=!0)},t.prototype.ngOnDestroy=function(){this===M[this.storeName]&&delete M[this.storeName]},t}(),V=function(i){function t(t,e){void 0===t&&(t={}),void 0===e&&(e={});var n=i.call(this,m({},L(),t))||this;return n.options=e,n}return u(t,i),Object.defineProperty(t.prototype,"entities",{get:function(){return this._value().entities},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"idKey",{get:function(){var t=this.config&&this.config.idKey;return t||(this.options.idKey||"id")},enumerable:!0,configurable:!0}),t.prototype.set=function(e,n){var i=this;void 0===n&&(n={}),q()&&D.setAction({type:"Set Entities"}),this.setState(function(t){return C._set(t,e,n.entityClass,i.idKey)}),this.setDirty()},t.prototype.createOrReplace=function(e,n){if(!l(e,this._value().entities))return n[this.idKey]||(n[this.idKey]=e),this.add(n);q()&&D.setAction({type:"Upsert Entity",entityId:[e]}),this.setState(function(t){return C._replaceEntity(t,e,n)})},t.prototype.add=function(t){var e=this,n=p(t);0!==n.length&&(q()&&D.setAction({type:"Add Entity"}),this.setState(function(t){return C._add(t,n,e.idKey)}))},t.prototype.update=function(t,e){var n=this,i=[],r=this._value().ids;if(O(t))for(var o=0,s=r.length;o<s;o++){var a=r[o],u=this._value().entities[a];u&&t(u)&&i.push(a)}else i=h(t)?p(t):r;0!==i.length&&(q()&&D.setAction({type:"Update Entity",entityId:i}),this.setState(function(t){return C._update(t,i,e,n.idKey)}))},t.prototype.updateAll=function(t){0!==this._value().ids.length&&this.update(null,t)},t.prototype.updateRoot=function(t,e){var n=O(t)?t(this._value()):t;if(n===this._value())throw new s(this.storeName);q()&&D.setAction(e||{type:"Update Root"}),this.setState(function(t){return m({},t,n)})},t.prototype.remove=function(t){var e=this._value().ids;if(0!==e.length){var n=h(t);n||this.setPristine();var i=[];if(O(t))for(var r=0,o=e.length;r<o;r++){var s=e[r],a=this._value().entities[s];a&&t(a)&&i.push(s)}else i=n?p(t):null;i&&0===i.length||(q()&&D.setAction({type:"Remove Entity",entityId:i}),this.setState(function(t){return C._remove(t,i)}))}},t.prototype.updateActive=function(i){var r=this;!function t(t){if(!h(t.active))throw new x}(this._value()),q()&&D.setAction({type:"Update Active Entity",entityId:this._value().active}),this.setState(function(t){var e=t.active,n=O(i)?i(t.entities[e]):i;if(n===t)throw new s(r.storeName);return C._update(t,[e],n,r.idKey)})},t.prototype.setActive=function(e){e!==this._value().active&&(q()&&D.setAction({type:"Set Active Entity",entityId:e}),this.setState(function(t){return m({},t,{active:e})}))},t}(H),L=function(){return{entities:{},ids:[],loading:!0,error:null}},z={ASC:"asc",DESC:"desc"};function Q(o,s){return void 0===s&&(s=z.ASC),function(t,e){if(!t.hasOwnProperty(o)||!e.hasOwnProperty(o))return 0;var n="string"==typeof t[o]?t[o].toUpperCase():t[o],i="string"==typeof e[o]?e[o].toUpperCase():e[o],r=0;return i<n?r=1:n<i&&(r=-1),s==z.DESC?-1*r:r}}function J(n){var i,r,o=!1,s=!0;return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return i&&(o=i[1]!==t[1]||i[0]!==t[0]),(s||o&&!s)&&(r=n.apply(this,t)),s=!1,i=t,r}}var $="akitaQueryConfig";var W=function(){function t(t){this.store=t,this.__store__=t}return t.prototype.select=function(t){var e=t||function(t){return t};return this.store._select(e)},t.prototype.selectOnce=function(t){return this.select(t).pipe(v.take(1))},t.prototype.selectLoading=function(){return this.select(function(t){return t.loading})},t.prototype.selectError=function(){return this.select(function(t){return t.error})},t.prototype.getSnapshot=function(){return this.store._value()},Object.defineProperty(t.prototype,"isPristine",{get:function(){return this.store.isPristine},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDirty",{get:function(){return!this.store.isPristine},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"config",{get:function(){return this.constructor[$]},enumerable:!0,configurable:!0}),t}(),X=function(n){function t(t){var e=n.call(this,t)||this;return e.__store__=t,e}return u(t,n),t.prototype.selectAll=function(i){var r=this;void 0===i&&(i={asObject:!1});var t=this.select(function(t){return t}),e=this.select(function(t){return t.entities});return i.sortBy=i.sortBy||this.config&&this.config.sortBy,i.sortByOrder=i.sortByOrder||this.config&&this.config.sortByOrder,e.pipe(v.withLatestFrom(t,function(t,e){var n=e.ids;return i.asObject?G(n,t,i):i.filterBy||i.sortBy?Y(e,i):(r.memoized||(r.memoized=J(Y)),r.memoized(e,i))}))},t.prototype.getAll=function(t){void 0===t&&(t={asObject:!1,filterBy:undefined,limitTo:undefined});var e=this.getSnapshot();return t.asObject?G(e.ids,e.entities,t,!0):Y(e,t)},t.prototype.selectMany=function(t,e){var n=this;void 0===e&&(e={});var i=!!y(e.filterUndefined)||e.filterUndefined,r=t.map(function(t){return n.selectEntity(t)});return a.combineLatest(r).pipe(v.map(function(t){return i?t.filter(function(t){return!y(t)}):t}),v.auditTime(0))},t.prototype.selectEntity=function(e,n){var i=this;return n?this.select(function(t){return i.hasEntity(e)?n(i.getEntity(e)):undefined}):this._byId(e)},t.prototype.getEntity=function(t){return this.getSnapshot().entities[t]},t.prototype.selectActiveId=function(){return this.select(function(t){return t.active})},t.prototype.getActiveId=function(){return this.getSnapshot().active},t.prototype.selectActive=function(e){var n=this;return this.selectActiveId().pipe(v.switchMap(function(t){return n.selectEntity(t,e)}))},t.prototype.getActive=function(){var t=this.getActiveId();return h(t)?this.getEntity(t):undefined},t.prototype.selectCount=function(t){return O(t)?this.selectAll({filterBy:t}).pipe(v.map(function(t){return t.length})):this.select(function(t){return t.ids.length})},t.prototype.getCount=function(t){return O(t)?this.getAll().filter(t).length:this.getSnapshot().ids.length},t.prototype.hasEntity=function(t){return O(t)?this.getAll().some(t):t in this.store.entities},t.prototype.isEmpty=function(){return 0===this.getSnapshot().ids.length},t.prototype._byId=function(e){var n=this;return this.select(function(t){return n.getEntity(e)})},t.prototype.ngOnDestroy=function(){this.memoized=null},t}(W);function Y(n,t){for(var e=[],i=n.ids,r=n.entities,o=t.filterBy,s=t.limitTo,a=t.sortBy,u=t.sortByOrder,c=0;c<i.length;c++){var p=i[c];l(p,r)&&(o?o(r[p])&&e.push(r[p]):e.push(r[p]))}if(a){var f=O(a)?a:Q(a,u);e=e.sort(function(t,e){return f(t,e,n)})}var h=Math.min(s||e.length,e.length);return h===e.length?e:e.slice(0,h)}function G(t,e,n,i){void 0===i&&(i=!1);var r={},o=n.filterBy,s=n.limitTo;if(i&&!o&&!s)return e;var a=Math.min(s||t.length,t.length);if(o&&!1===y(s))for(var u=0,c=0,p=t.length;c<p&&u!==s;c++){l(f=t[c],e)&&o(e[f])&&(r[f]=e[f],u++)}else for(c=0;c<a;c++){var f;l(f=t[c],e)&&(o?h(o(e[f]))&&(r[f]=e[f]):r[f]=e[f])}return r}function Z(t,e){void 0===e&&(e=undefined),function n(){B()||(D.batchTransaction=new a.Subject),D.activeTransactions++}();try{return t.apply(e)}finally{!function i(){0==--D.activeTransactions&&(D.batchTransaction.next(!0),D.batchTransaction.complete())}()}}function tt(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return c(t,e)}var et=function(t){return t.pipe(v.filter(function(t){return null!=t}))};function nt(t,e,n){return void 0===n&&(n=undefined),D.setCustomAction(e,!0),t.apply(n)}function it(r,o){return void 0===o&&(o=!0),function(t,e,n){var i=n.value;return n.value=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return D.setCustomAction(r,o),i.apply(this,t)},n}}var rt=function(){function t(){}return t.prototype.getStoresSnapshot=function(t){void 0===t&&(t=[]);for(var e={},n=0<t.length?t:Object.keys(M),i=0;i<n.length;i++){var r=n[i];e[r]=M[r]._value()}return e},t.prototype.setStoresSnapshot=function(t){var i=t;o(t)&&(i=JSON.parse(i));for(var e=function(t,e){var n=e[t];M[n]&&M[n].setState(function(){return i[n]})},n=0,r=Object.keys(i);n<r.length;n++)e(n,r)},t}(),ot=new rt,st=function(){function t(t){this.query=t}return t.prototype.getQuery=function(){return this.query},t.prototype.getStore=function(){return this.getQuery().__store__},t.prototype.isEntityBased=function(t){return h(t)},t.prototype.selectSource=function(t){return this.isEntityBased(t)?this.getQuery().selectEntity(t).pipe(et):this.getQuery().select(function(t){return t})},t.prototype.getSource=function(t){return this.isEntityBased(t)?this.getQuery().getEntity(t):this.getQuery().getSnapshot()},t.prototype.updateStore=function(e,t){this.isEntityBased(t)?this.getStore().update(t,e):this.getStore().setState(function(t){return m({},t,e)})},t}(),at={pagesControls:!1,range:!1,startWith:1,cacheTimeout:undefined},ut=function(s){function t(t,e){void 0===e&&(e={});var n=s.call(this,t)||this;n.query=t,n.config=e,n.metadata=new Map,n.pages=new Map,n.pagination={currentPage:1,perPage:0,total:0,lastPage:0,data:[]},n.initial=!1,n.isLoading$=n.query.selectLoading().pipe(v.delay(0)),n.config=Object.assign(at,e);var i=n.config,r=i.startWith,o=i.cacheTimeout;return n.page=new a.BehaviorSubject(r),d(o)&&(n.clearCacheSubscription=o.subscribe(function(t){return n.clearCache()})),n}return u(t,s),Object.defineProperty(t.prototype,"pageChanges",{get:function(){return this.page.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentPage",{get:function(){return this.pagination.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isFirst",{get:function(){return 1===this.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isLast",{get:function(){return this.currentPage===this.pagination.lastPage},enumerable:!0,configurable:!0}),t.prototype.withControls=function(){return this.config.pagesControls=!0,this},t.prototype.withRange=function(){return this.config.range=!0,this},t.prototype.setLoading=function(t){void 0===t&&(t=!0),this.getStore().setLoading(t)},t.prototype.update=function(t){this.pagination=t,this.addPage(t.data)},t.prototype.addPage=function(t){var e=this;this.pages.set(this.currentPage,{ids:t.map(function(t){return t[e.getStore().idKey]})}),this.getStore().add(t)},t.prototype.clearCache=function(){var t=this;this.initial||(nt(function(){t.getStore().remove()},{type:"@Pagination - Clear Cache"}),this.pages=new Map),this.initial=!1},t.prototype.clearPage=function(t){this.pages["delete"](t)},t.prototype.destroy=function(t){var e=void 0===t?{}:t,n=e.clearCache,i=e.currentPage;this.clearCacheSubscription&&this.clearCacheSubscription.unsubscribe(),n&&this.clearCache(),y(i)||this.setPage(i),this.initial=!0},t.prototype.isPageActive=function(t){return this.currentPage===t},t.prototype.setPage=function(t){t===this.currentPage&&this.hasPage(t)||this.page.next(this.pagination.currentPage=t)},t.prototype.nextPage=function(){this.currentPage!==this.pagination.lastPage&&this.setPage(this.pagination.currentPage+1)},t.prototype.prevPage=function(){1<this.pagination.currentPage&&this.setPage(this.pagination.currentPage-1)},t.prototype.setLastPage=function(){this.setPage(this.pagination.lastPage)},t.prototype.setFirstPage=function(){this.setPage(1)},t.prototype.hasPage=function(t){return this.pages.has(t)},t.prototype.getPage=function(t){var e=this,n=this.pagination.currentPage;return this.hasPage(n)?this.selectPage(n):(this.setLoading(!0),a.from(t()).pipe(v.switchMap(function(t){return Z(function(){e.setLoading(!1),e.update(t)}),e.selectPage(n)})))},t.prototype.getQuery=function(){return this.query},t.prototype.getFrom=function(){return this.isFirst?1:(this.currentPage-1)*this.pagination.perPage+1},t.prototype.getTo=function(){return this.currentPage*this.pagination.perPage},t.prototype.selectPage=function(s){var a=this;return this.query.selectAll({asObject:!0}).pipe(v.take(1),v.map(function(e){var t=m({},a.pagination,{data:a.pages.get(s).ids.map(function(t){return e[t]})}),n=a.config,i=n.range,r=n.pagesControls;return a.pagination.total||(t.total=t.perPage*t.lastPage,a.pagination.total=t.total),i&&(t.from=a.getFrom(),t.to=a.getTo()),r&&(t.pageControls=function o(t,e){for(var n=Math.ceil(t/e),i=[],r=0;r<n;r++)i.push(r+1);return i}(a.pagination.total,a.pagination.perPage)),t}))},function e(t,e,n,i){var r,o=arguments.length,s=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(s=(o<3?r(s):3<o?r(e,n,s):r(e,n))||s);return 3<o&&s&&Object.defineProperty(e,n,s),s}([it({type:"@Pagination - New Page"},!0),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",void 0)],t.prototype,"update",null),t}(st);var ct=ut,pt=function(r){function t(t,e,n){void 0===n&&(n={});var i=r.call(this,t)||this;return i.query=t,i.factoryFnOrPath=e,i.params=n,i.params=m({debounceTime:300,formKey:"akitaForm",emitEvent:!1},n),i.isKeyBased=o(e),i}return u(t,r),t.prototype.setForm=function(t){return this.form=t,this.activate(),this},t.prototype.reset=function(t){var e,n;n=t||(this.isKeyBased?this.initialValue:this.factoryFnOrPath()),this.form.patchValue(n);var i=this.isKeyBased?A(this.getStore()._value(),this.getStore().storeName+"."+this.factoryFnOrPath,n):((e={})[this.params.formKey]=n,e);this.updateStore(i)},t.prototype.activate=function(){var t,n,i=this;this.isKeyBased?(n=this.getStore().storeName+"."+this.factoryFnOrPath,this.initialValue=E(this.getStore()._value(),n),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent})):(this.getQuery().getSnapshot()[this.params.formKey]||(D.setAction({type:"@PersistNgFormPlugin activate"}),this.updateStore(((t={})[this.params.formKey]=this.factoryFnOrPath(),t))),this.query.selectOnce(function(t){return t[i.params.formKey]}).subscribe(function(t){return i.form.patchValue(t)})),this.formChanges=this.form.valueChanges.pipe(v.debounceTime(this.params.debounceTime)).subscribe(function(e){var t;D.setAction({type:"@PersistForm - Update"}),t=i.isKeyBased?function(t){return A(t,n,e)}:function(){var t;return(t={})[i.params.formKey]=e,t},i.updateStore(t(i.getStore()._value()))})},t.prototype.destroy=function(){this.formChanges&&this.formChanges.unsubscribe()},t}(st),ft="undefined"==typeof localStorage;var ht={beforeRemove:function(t){return t.destroy()}},yt=function(){function t(t,e){this.query=t,this.entityIds=e,this.entities=new Map}return t.prototype.getEntity=function(t){return this.entities.get(t)},t.prototype.hasEntity=function(t){return this.entities.has(t)},t.prototype.removeEntity=function(t){return this.entities["delete"](t)},t.prototype.createEntity=function(t,e){return this.entities.set(t,e)},t.prototype.getIds=function(){return y(this.entityIds)?this.query.getSnapshot().ids:p(this.entityIds)},t.prototype.resolvedIds=function(t){return y(t)?this.getIds():p(t)},t.prototype.rebase=function(n,i){var r=this;if(void 0===i&&(i=ht),h(n))if(y(this.entityIds)){for(var t=0,e=n.length;t<e;t++){var o=n[t];if(!1===this.hasEntity(o)){O(i.beforeAdd)&&i.beforeAdd(o);var s=this.instantiatePlugin(o);this.entities.set(o,s),O(i.afterAdd)&&i.afterAdd(s)}}this.entities.forEach(function(t,e){-1===n.indexOf(e)&&(O(i.beforeRemove)&&i.beforeRemove(t),r.removeEntity(e))})}else{var a=p(this.entityIds);for(t=0,e=a.length;t<e;t++){o=a[t];if(-1<n.indexOf(o)&&!1===this.hasEntity(o)){O(i.beforeAdd)&&i.beforeAdd(o);s=this.instantiatePlugin(o);this.entities.set(o,s),O(i.afterAdd)&&i.afterAdd(s)}else this.entities.forEach(function(t,e){-1===n.indexOf(e)&&!0===r.hasEntity(e)&&(O(i.beforeRemove)&&i.beforeRemove(t),r.removeEntity(e))})}}else this.getIds().forEach(function(t){r.hasEntity(t)||r.createEntity(t,r.instantiatePlugin(t))})},t.prototype.selectIds=function(){return this.query.select(function(t){return t.ids})},t.prototype.activate=function(t){this.rebase(t)},t.prototype.forEachId=function(t,e){for(var n=this.resolvedIds(t),i=0,r=n.length;i<r;i++){var o=n[i];this.hasEntity(o)&&e(this.getEntity(o))}},t}(),lt=function(r){function t(t,e,n){void 0===e&&(e={});var i=r.call(this,t)||this;return i.query=t,i.params=e,i._entityId=n,i.skip=!1,i.history={past:[],present:null,future:[]},i.skipUpdate=!1,e.maxAge=h(e.maxAge)?e.maxAge:10,i.activate(),i}return u(t,r),Object.defineProperty(t.prototype,"hasPast",{get:function(){return 0<this.history.past.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasFuture",{get:function(){return 0<this.history.future.length},enumerable:!0,configurable:!0}),t.prototype.activate=function(){var r=this;this.history.present=this.getSource(this._entityId),this.subscription=this.selectSource(this._entityId).pipe(v.pairwise()).subscribe(function(t){var e=P(t,2),n=e[0],i=e[1];r.skip?r.skip=!1:r.skipUpdate||(r.history.past.length===r.params.maxAge&&(r.history.past=r.history.past.slice(1)),r.history.past=c(r.history.past,[n]),r.history.present=i)})},t.prototype.undo=function(){if(0<this.history.past.length){var t=this.history,e=t.past,n=t.present,i=(t.future,e[e.length-1]),r=e.slice(0,e.length-1);this.history.past=r,this.history.present=i,this.history.future=c([n],this.history.future),this.update()}},t.prototype.redo=function(){if(0<this.history.future.length){var t=this.history,e=t.past,n=t.present,i=(t.future,this.history.future[0]),r=this.history.future.slice(1);this.history.past=c(e,[n]),this.history.present=i,this.history.future=r,this.update("Redo")}},t.prototype.jumpToPast=function(t){if(!(t<0||t>=this.history.past.length)){var e=this.history,n=e.past,i=e.future,r=n.slice(0,t),o=c(n.slice(t+1),i),s=n[t];this.history.past=r,this.history.present=s,this.history.future=o,this.update()}},t.prototype.jumpToFuture=function(t){if(!(t<0||t>=this.history.future.length)){var e=this.history,n=e.past,i=e.future,r=c(n,i.slice(0,t)),o=i[t],s=i.slice(t+1);this.history.past=r,this.history.present=o,this.history.future=s,this.update("Redo")}},t.prototype.clear=function(){this.history={past:[],present:null,future:[]}},t.prototype.destroy=function(t){void 0===t&&(t=!1),t&&this.clear(),this.subscription.unsubscribe()},t.prototype.ignoreNext=function(){this.skip=!0},t.prototype.update=function(t){void 0===t&&(t="Undo"),this.skipUpdate=!0,D.setCustomAction({type:"@StateHistory - "+t}),this.updateStore(this.history.present,this._entityId),this.skipUpdate=!1},t}(st),dt=function(i){function t(t,e){void 0===e&&(e={});var n=i.call(this,t,e.entityIds)||this;return n.query=t,(n.params=e).maxAge=h(e.maxAge)?e.maxAge:10,n.activate(),n.selectIds().pipe(v.skip(1)).subscribe(function(t){return n.activate(t)}),n}return u(t,i),t.prototype.redo=function(t){this.forEachId(t,function(t){return t.redo()})},t.prototype.undo=function(t){this.forEachId(t,function(t){return t.undo()})},t.prototype.hasPast=function(t){if(this.hasEntity(t))return this.getEntity(t).hasPast},t.prototype.hasFuture=function(t){if(this.hasEntity(t))return this.getEntity(t).hasFuture},t.prototype.jumpToFuture=function(t,e){this.forEachId(t,function(t){return t.jumpToFuture(e)})},t.prototype.jumpToPast=function(t,e){this.forEachId(t,function(t){return t.jumpToPast(e)})},t.prototype.clear=function(t){this.forEachId(t,function(t){return t.clear()})},t.prototype.destroy=function(t,e){void 0===e&&(e=!1),this.forEachId(t,function(t){return t.destroy(e)})},t.prototype.instantiatePlugin=function(t){return new lt(this.query,this.params,t)},t}(yt),gt={comparator:function(t,e){return JSON.stringify(t)!==JSON.stringify(e)}},vt=function(o){function t(t,e,n){var i=o.call(this,t)||this;if(i.query=t,i.params=e,i._entityId=n,i.dirty=new a.BehaviorSubject(!1),i.active=!1,i.isDirty$=i.dirty.asObservable().pipe(v.distinctUntilChanged()),i.params=m({},gt,e),i.params.watchProperty){var r=i.params.watchProperty;(r=p(r)).includes("entities")&&!r.includes("ids")&&t instanceof X&&r.push("ids"),i.params.watchProperty=r}return i}return u(t,o),t.prototype.getHead=function(){return this.head},t.prototype.activate=function(){var r=this;this.head=this._getHead();var t=this.params.watchProperty?this.params.watchProperty.map(function(e){return r.query.select(function(t){return t[e]}).pipe(v.map(function(t){return{val:t,__akitaKey:e}}))}):[this.selectSource(this._entityId)];this.subscription=a.merge.apply(void 0,c(t)).pipe(v.skip(1)).subscribe(function(t){if(!y(r.head)){var e=t.__akitaKey?r.head[t.__akitaKey]:r.head,n=t.__akitaKey?t.val:t,i=r.params.comparator(e,n);r.updateDirtiness(i)}})},t.prototype.reset=function(t){void 0===t&&(t={});var e=this.head;O(t.updateFn)&&(e=this.isEntityBased(this._entityId)?t.updateFn(this.head,this.getQuery().getEntity(this._entityId)):t.updateFn(this.head,this.getQuery().getSnapshot())),(this.params.watchProperty?this.compareProp(e):this._getHead()!==e)&&(D.setCustomAction({type:"@DirtyCheck - Revert"}),this.updateStore(e,this._entityId))},t.prototype.setHead=function(){return this.active?this.head=this._getHead():(this.activate(),this.active=!0),this.updateDirtiness(!1),this},t.prototype.isDirty=function(){return h(this.dirty.value)},t.prototype.hasHead=function(){return h(this.getHead())},t.prototype.destroy=function(){this.head=null,this.subscription&&this.subscription.unsubscribe()},t.prototype.updateDirtiness=function(t){this.dirty.next(t)},t.prototype._getHead=function(){var n=this.getSource(this._entityId);return this.params.watchProperty&&(n=this.params.watchProperty.reduce(function(t,e){return t[e]=n[e],t},{})),n},t.prototype.compareProp=function(e){var t=Object.keys(e),n=this._getHead();return t.some(function(t){return e[t]!==n[t]})},t}(st),mt=function(i){function t(t,e){void 0===e&&(e={});var n=i.call(this,t,e.entityIds)||this;return n.query=t,n.params=e,n.isSomeDirty$=n.query.select(function(t){return t.entities}).pipe(v.map(function(t){return n.checkSomeDirty(t)})),n.params=m({},gt,e),n.activate(),n.selectIds().pipe(v.skip(1)).subscribe(function(t){n.rebase(t,{afterAdd:function(t){return t.setHead()}})}),n}return u(t,i),t.prototype.setHead=function(t){return this.forEachId(t,function(t){return t.setHead()}),this},t.prototype.hasHead=function(t){return!!this.entities.has(t)&&this.getEntity(t).hasHead()},t.prototype.reset=function(t,e){void 0===e&&(e={}),this.forEachId(t,function(t){return t.reset(e)})},t.prototype.isDirty=function(t,e){if(void 0===e&&(e=!0),this.entities.has(t)){var n=this.getEntity(t);return e?n.isDirty$:n.isDirty()}return!1},t.prototype.isSomeDirty=function(){var t=this.query.getAll({asObject:!0});return this.checkSomeDirty(t)},t.prototype.destroy=function(t){this.forEachId(t,function(t){return t.destroy()})},t.prototype.instantiatePlugin=function(t){return new vt(this.query,this.params,t)},t.prototype.checkSomeDirty=function(t){var e,n,i=this.resolvedIds();try{for(var r=function o(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}(i),s=r.next();!s.done;s=r.next()){var a=s.value;if(this.params.comparator(this.getEntity(a).getHead(),t[a]))return!0}}catch(u){e={error:u}}finally{try{s&&!s.done&&(n=r["return"])&&n.call(r)}finally{if(e)throw e.error}}return!1},t}(yt);t.__globalState=D,t.EntityStore=V,t.getInitialEntitiesState=L,t.getInitialActiveState=function(){return{active:null}},t.QueryEntity=X,t.Query=W,t.enableAkitaProdMode=function bt(){K=!1},t.isDev=q,t.__stores__=M,t.rootDispatcher=U,t.Store=H,t.applyTransaction=Z,t.transaction=function Pt(){return function(t,e,n){var i=n.value;return n.value=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return Z(function(){return i.apply(t,e)},this)},n}},t.push=tt,t.remove=function St(t,e){return 0<=e?c(t.slice(0,e),t.slice(e+1)):c(t)},t.pop=function Ot(t){return t.slice(0,-1)},t.unshift=function _t(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return c(e,t)},t.sort=function At(t,e){return c(t).sort(e)},t.reverse=function Et(t){return c(t).reverse()},t.swap=function wt(t,e,n){var i=t.slice(),r=t[e];return i[e]=t[n],i[n]=r,i},t.update=function jt(t,n,i){return t.map(function(t,e){return"number"==typeof n&&e===n?i:f(n)&&n===t?m({},n,i):t})},t.splice=function xt(t,e,n){void 0===e&&(e=t.length),void 0===n&&(n=t.length-e);for(var i=[],r=3;r<arguments.length;r++)i[r-3]=arguments[r];return c(t.slice(0,e),i,t.slice(e+(n<0?0:n)))},t.toggle=function It(t,e){return-1<t.indexOf(e)?t.filter(function(t){return e!==t}):tt(t,e)},t.filterNil=et,t.coerceArray=p,t.isObject=f,t.isPlainObject=S,t.isFunction=O,t.toBoolean=h,t.isUndefined=y,t.entityExists=l,t.noop=function kt(){return new a.Observable(function(t){t.next(),t.complete()})},t.isObservable=d,t.isString=o,t.isNumber=r,t.isDefined=g,t.resetActive=_,t.isActiveState=e,t.setValue=A,t.getValue=E,t.applyAction=nt,t.action=it,t.mapInWorker=function Tt(r){return function(n){return new a.Observable(function(e){var i=function t(){var t=new Blob(["self.onmessage = function(e) {\n\n      function deserialize(str) {\n        return JSON.parse(str || '', function(key, value) {\n          if (value &&\n            typeof value === \"string\" &&\n            value.substr(0, 8) == \"function\") {\n            var startBody = value.indexOf('{') + 1;\n            var endBody = value.lastIndexOf('}');\n            var startArgs = value.indexOf('(') + 1;\n            var endArgs = value.indexOf(')');\n            return new Function(value.substring(startArgs, endArgs), value.substring(startBody, endBody));\n          }\n          return value;\n        });\n      }\n\n      var deserialized = deserialize(e.data);\n      var mapped = deserialized.data.map(function(d) {\n        return deserialized.factory(d);\n      });\n\n      self.postMessage(mapped);\n    }"],{type:"text/javascript"}),e=URL.createObjectURL(t);return new Worker(e)}();return i.onmessage=function(t){e.next(t.data),e.complete(),i.terminate()},i.onerror=function(t){e.error(t),e.complete(),i.terminate()},n.subscribe(function(t){var e=function n(t){return JSON.stringify(t,function(t,e){return"function"==typeof e?e.toString():e})}({factory:r,data:t});i.postMessage(e)})})}},t.memoizeOne=J,t.SnapshotManager=rt,t.snapshotManager=ot,t.StoreConfig=function Ct(r){return function(t){t[F]={idKey:"id"};for(var e=0,n=Object.keys(r);e<n.length;e++){var i=n[e];"name"===i?t[F].storeName=r[i]:t[F][i]=r[i]}}},t.configKey=F,t.QueryConfig=function Nt(r){return function(t){t[$]={};for(var e=0,n=Object.keys(r);e<n.length;e++){var i=n[e];t[$][i]=r[i]}}},t.queryConfigKey=$,t.compareValues=Q,t.Order=z,t.AkitaPlugin=st,t.PaginatorPlugin=ut,t.Paginator=ct,t.PersistNgFormPlugin=pt,t.persistState=function Dt(t){if(!ft){var e={key:"AkitaStores",storage:localStorage,deserialize:JSON.parse,serialize:JSON.stringify,include:[],exclude:[]},n=Object.assign({},e,t),i=n.storage,r=n.deserialize,o=n.serialize,s=n.include,a=n.exclude,u=n.key,c=0<s.length,p=0<a.length;if(c&&p)throw new w("You can't use both include and exclude");var f=r(i.getItem(u)||"{}"),h={},y={},l=U.subscribe(function(t){if(0===t.type){var e=t.payload.store.storeName;if(p&&-1<a.indexOf(e)==1)return;if(c){var n=s.find(function(t){return-1<t.indexOf(e)});if(!n)return;g(e=n.split(".")[0],t.payload.store,n),d(e,n)}else g(e,t.payload.store,e),d(e,e)}});return{destroy:function(){l.unsubscribe();for(var t=0,e=Object.keys(h);t<e.length;t++){var n=e[t];h[n].unsubscribe()}h={}},clear:function(){i.clear()},clearStore:function(t){var e=r(i.getItem(u)||"{}");e[t]&&(delete e[t],i.setItem(u,o(e)))}}}function d(n,e){h[n]=M[n]._select(function(t){return E(t,e)}).pipe(v.skip(1)).subscribe(function(t){y[n]=t,function e(){i.setItem(u,o(Object.assign({},f,y)))}()})}function g(e,t,n){f[e]&&(D.setAction({type:"@PersistState"}),t.setState(function(t){return A(t,n,f[e])}),t.setDirty&&t.setDirty())}},t.akitaDevtools=function Bt(s,u){if(void 0===u&&(u={}),window.__REDUX_DEVTOOLS_EXTENSION__){s&&s.run||((s=s||{}).run=function(t){return t()},u=s);var t=Object.assign({},{name:"Akita"},u),c=window.__REDUX_DEVTOOLS_EXTENSION__.connect(t),p={};U.subscribe(function(t){var e;if(1===t.type){if(D.skipAction)return void D.setSkipAction(!1);p=m({},p,((e={})[t.payload.name]=M[t.payload.name]._value(),e));var n=D.currentAction,i=n.type,r=n.entityId,o=function s(t){return t&&t.charAt(0).toUpperCase()+t.slice(1)}(t.payload.name),a=g(r)?"["+o+"] - "+i+" (ids: "+r+")":"["+o+"] - "+i;u.logTrace&&(console.group(a),console.trace(),console.groupEnd()),c.send({type:a,transaction:D.currentT.map(function(t){return t.type})},p)}}),c.subscribe(function(n){if("ACTION"===n.type){var i=P(n.payload.split("."),1)[0];M[i]&&s.run(function(){var t=n.payload.replace(i,"this['"+i+"']");try{new Function(""+t).call(M)}catch(e){console.warn("Unknown Method ☹️")}})}if("DISPATCH"===n.type){if("COMMIT"===n.payload.type)return void c.init(p);if(n.state)for(var r=JSON.parse(n.state),t=function(t,e){var n=e[t];M[n]&&s.run(function(){M[n].setState(function(){return r[n]},!1)})},e=0,o=Object.keys(r);e<o.length;e++)t(e,o)}})}},t.EntityCollectionPlugin=yt,t.StateHistoryPlugin=lt,t.EntityStateHistoryPlugin=dt,t.dirtyCheckDefaultParams=gt,t.DirtyCheckPlugin=vt,t.EntityDirtyCheckPlugin=mt,t.increment=function Ft(t,e){if(void 0===e&&(e={maxValue:undefined}),!1!==r(t))return e.maxValue&&t===e.maxValue?t:t+1},t.decrement=function Kt(t,e){if(void 0===e&&(e={allowNegative:!1}),!1!==r(t))return!1===e.allowNegative&&0===t?t:t-1},t.guid=function Mt(){return"xxxxxx4xyx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},t.ɵa=N,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=datorama-akita.umd.min.js.map