/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { AkitaError } from '../internal/error';
import { __stores__, rootDispatcher } from '../api/store';
import { skip } from 'rxjs/operators';
import { getValue, setValue } from '../internal/utils';
import { __globalState } from '../internal/global-state';
/** @type {?} */
const notBs = typeof localStorage === 'undefined';
/**
 * @record
 */
export function PersistStateParams() { }
function PersistStateParams_tsickle_Closure_declarations() {
    /**
     * The storage key
     * @type {?}
     */
    PersistStateParams.prototype.key;
    /**
     * Storage strategy to use. This defaults to LocalStorage but you can pass SessionStorage or anything that implements the StorageEngine API.
     * @type {?}
     */
    PersistStateParams.prototype.storage;
    /**
     * Custom deserializer. Defaults to JSON.parse
     * @type {?}
     */
    PersistStateParams.prototype.deserialize;
    /**
     * Custom serializer, defaults to JSON.stringify
     * @type {?}
     */
    PersistStateParams.prototype.serialize;
    /**
     * By default the whole state is saved to storage, use this param to include only the stores you need.
     * Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.include;
    /**
     *  By default the whole state is saved to storage, use this param to exclude stores that you don't need.
     *  Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.exclude;
}
/**
 * @param {?=} params
 * @return {?}
 */
export function persistState(params) {
    if (notBs)
        return;
    /** @type {?} */
    const defaults = {
        key: 'AkitaStores',
        storage: localStorage,
        deserialize: JSON.parse,
        serialize: JSON.stringify,
        include: [],
        exclude: []
    };
    const { storage, deserialize, serialize, include, exclude, key } = Object.assign({}, defaults, params);
    /** @type {?} */
    const hasInclude = include.length > 0;
    /** @type {?} */
    const hasExclude = exclude.length > 0;
    if (hasInclude && hasExclude) {
        throw new AkitaError("You can't use both include and exclude");
    }
    /** @type {?} */
    const storageState = deserialize(storage.getItem(key) || '{}');
    /** @type {?} */
    let stores = {};
    /** @type {?} */
    let acc = {};
    /**
     * @return {?}
     */
    function save() {
        storage.setItem(key, serialize(Object.assign({}, storageState, acc)));
    }
    /**
     * @param {?} storeName
     * @param {?} path
     * @return {?}
     */
    function subscribe(storeName, path) {
        stores[storeName] = __stores__[storeName]
            ._select(state => getValue(state, path))
            .pipe(skip(1))
            .subscribe(data => {
            acc[storeName] = data;
            save();
        });
    }
    /**
     * @param {?} storeName
     * @param {?} store
     * @param {?} path
     * @return {?}
     */
    function setInitial(storeName, store, path) {
        if (storageState[storeName]) {
            __globalState.setAction({ type: '@PersistState' });
            store.setState(state => {
                return setValue(state, path, storageState[storeName]);
            });
            if (store.setDirty) {
                store.setDirty();
            }
        }
    }
    /** @type {?} */
    const subscription = rootDispatcher.subscribe(action => {
        if (action.type === 0 /* NEW_STORE */) {
            /** @type {?} */
            let currentStoreName = action.payload["store"].storeName;
            if (hasExclude && exclude.indexOf(currentStoreName) > -1 === true) {
                return;
            }
            if (hasInclude) {
                /** @type {?} */
                const path = include.find(name => name.indexOf(currentStoreName) > -1);
                if (!path) {
                    return;
                }
                else {
                    currentStoreName = path.split('.')[0];
                    setInitial(currentStoreName, action.payload["store"], path);
                    subscribe(currentStoreName, path);
                }
            }
            else {
                setInitial(currentStoreName, action.payload["store"], currentStoreName);
                subscribe(currentStoreName, currentStoreName);
            }
        }
    });
    return {
        /**
         * @return {?}
         */
        destroy() {
            subscription.unsubscribe();
            for (let i = 0, keys = Object.keys(stores); i < keys.length; i++) {
                /** @type {?} */
                const storeName = keys[i];
                stores[storeName].unsubscribe();
            }
            stores = {};
        },
        /**
         * @return {?}
         */
        clear() {
            storage.clear();
        },
        /**
         * @param {?} storeName
         * @return {?}
         */
        clearStore(storeName) {
            /** @type {?} */
            const storageState = deserialize(storage.getItem(key) || '{}');
            if (storageState[storeName]) {
                delete storageState[storeName];
                storage.setItem(key, serialize(storageState));
            }
        }
    };
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc2lzdC1zdGF0ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkYXRvcmFtYS9ha2l0YS8iLCJzb3VyY2VzIjpbInNyYy9lbmhhbmNlcnMvcGVyc2lzdC1zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxVQUFVLEVBQVcsY0FBYyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0QyxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7QUFFekQsTUFBTSxLQUFLLEdBQUcsT0FBTyxZQUFZLEtBQUssV0FBVyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBdUJsRCxNQUFNLHVCQUF1QixNQUFvQztJQUMvRCxJQUFJLEtBQUs7UUFBRSxPQUFPOztJQUVsQixNQUFNLFFBQVEsR0FBdUI7UUFDbkMsR0FBRyxFQUFFLGFBQWE7UUFDbEIsT0FBTyxFQUFFLFlBQVk7UUFDckIsV0FBVyxFQUFFLElBQUksQ0FBQyxLQUFLO1FBQ3ZCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztRQUN6QixPQUFPLEVBQUUsRUFBRTtRQUNYLE9BQU8sRUFBRSxFQUFFO0tBQ1osQ0FBQztJQUNGLE1BQU0sRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQzs7SUFFdkcsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7O0lBQ3RDLE1BQU0sVUFB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QUMsQ0FBQztJQUVILE9BQU87Ozs7UUFDTCxPQUFPO1lBQ0wsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzNCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFOztnQkFDaEUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDakM7WUFDRCxNQUFNLEdBQUcsRUFBRSxDQUFDO1NBQ2I7Ozs7UUFDRCxLQUFLO1lBQ0gsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ2pCOzs7OztRQUNELFVBQVUsQ0FBQyxTQUFpQjs7WUFDMUIsTUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUM7WUFFL0QsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQzNCLE9BQU8sWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUMvQixPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQzthQUMvQztTQUNGO0tBQ0YsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWtpdGFFcnJvciB9IGZyb20gJy4uL2ludGVybmFsL2Vycm9yJztcbmltcG9ydCB7IF9fc3RvcmVzX18sIEFjdGlvbnMsIHJvb3REaXNwYXRjaGVyIH0gZnJvbSAnLi4vYXBpL3N0b3JlJztcbmltcG9ydCB7IHNraXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBnZXRWYWx1ZSwgc2V0VmFsdWUgfSBmcm9tICcuLi9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQgeyBfX2dsb2JhbFN0YXRlIH0gZnJvbSAnLi4vaW50ZXJuYWwvZ2xvYmFsLXN0YXRlJztcblxuY29uc3Qgbm90QnMgPSB0eXBlb2YgbG9jYWxTdG9yYWdlID09PSAndW5kZWZpbmVkJztcblxuZXhwb3J0IGludGVyZmFjZSBQZXJzaXN0U3RhdGVQYXJhbXMge1xuICAvKiogVGhlIHN0b3JhZ2Uga2V5ICovXG4gIGtleTogc3RyaW5nO1xuICAvKiogU3RvcmFnZSBzdHJhdGVneSB0byB1c2UuIFRoaXMgZGVmYXVsdHMgdG8gTG9jYWxTdG9yYWdlIGJ1dCB5b3UgY2FuIHBhc3MgU2Vzc2lvblN0b3JhZ2Ugb3IgYW55dGhpbmcgdGhhdCBpbXBsZW1lbnRzIHRoZSBTdG9yYWdlRW5naW5lIEFQSS4gKi9cbiAgc3RvcmFnZTogU3RvcmFnZTtcbiAgLyoqIEN1c3RvbSBkZXNlcmlhbGl6ZXIuIERlZmF1bHRzIHRvIEpTT04ucGFyc2UgKi9cbiAgZGVzZXJpYWxpemU6IEZ1bmN0aW9uO1xuICAvKiogQ3VzdG9tIHNlcmlhbGl6ZXIsIGRlZmF1bHRzIHRvIEpTT04uc3RyaW5naWZ5ICovXG4gIHNlcmlhbGl6ZTogRnVuY3Rpb247XG4gIC8qKlxuICAgKiBCeSBkZWZhdWx0IHRoZSB3aG9sZSBzdGF0ZSBpcyBzYXZlZCB0byBzdG9yYWdlLCB1c2UgdGhpcyBwYXJhbSB0byBpbmNsdWRlIG9ubHkgdGhlIHN0b3JlcyB5b3UgbmVlZC5cbiAgICogUGF5IGF0dGVudGlvbiB0aGF0IHlvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXG4gICAqL1xuICBpbmNsdWRlOiBzdHJpbmdbXTtcbiAgLyoqXG4gICAqICBCeSBkZWZhdWx0IHRoZSB3aG9sZSBzdGF0ZSBpcyBzYXZlZCB0byBzdG9yYWdlLCB1c2UgdGhpcyBwYXJhbSB0byBleGNsdWRlIHN0b3JlcyB0aGF0IHlvdSBkb24ndCBuZWVkLlxuICAgKiAgUGF5IGF0dGVudGlvbiB0aGF0IHlvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXG4gICAqL1xuICBleGNsdWRlOiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlcnNpc3RTdGF0ZShwYXJhbXM/OiBQYXJ0aWFsPFBlcnNpc3RTdGF0ZVBhcmFtcz4pIHtcbiAgaWYgKG5vdEJzKSByZXR1cm47XG5cbiAgY29uc3QgZGVmYXVsdHM6IFBlcnNpc3RTdGF0ZVBhcmFtcyA9IHtcbiAgICBrZXk6ICdBa2l0YVN0b3JlcycsXG4gICAgc3RvcmFnZTogbG9jYWxTdG9yYWdlLFxuICAgIGRlc2VyaWFsaXplOiBKU09OLnBhcnNlLFxuICAgIHNlcmlhbGl6ZTogSlNPTi5zdHJpbmdpZnksXG4gICAgaW5jbHVkZTogW10sXG4gICAgZXhjbHVkZTogW11cbiAgfTtcbiAgY29uc3QgeyBzdG9yYWdlLCBkZXNlcmlhbGl6ZSwgc2VyaWFsaXplLCBpbmNsdWRlLCBleGNsdWRlLCBrZXkgfSA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRzLCBwYXJhbXMpO1xuXG4gIGNvbnN0IGhhc0luY2x1ZGUgPSBpbmNsdWRlLmxlbmd0aCA+IDA7XG4gIGNvbnN0IGhhc0V4Y2x1ZGUgPSBleGNsdWRlLmxlbmd0aCA+IDA7XG5cbiAgaWYgKGhhc0luY2x1ZGUgJiYgaGFzRXhjbHVkZSkge1xuICAgIHRocm93IG5ldyBBa2l0YUVycm9yKFwiWW91IGNhbid0IHVzZSBib3RoIGluY2x1ZGUgYW5kIGV4Y2x1ZGVcIik7XG4gIH1cblxuICBjb25zdCBzdG9yYWdlU3RhdGUgPSBkZXNlcmlhbGl6ZShzdG9yYWdlLmdldEl0ZW0oa2V5KSB8fCAne30nKTtcblxuICBsZXQgc3RvcmVzID0ge307XG4gIGxldCBhY2MgPSB7fTtcblxuICBmdW5jdGlvbiBzYXZlKCkge1xuICAgIHN0b3JhZ2Uuc2V0SXRlbShrZXksIHNlcmlhbGl6ZShPYmplY3QuYXNzaWduKHt9LCBzdG9yYWdlU3RhdGUsIGFjYykpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHN1YnNjcmliZShzdG9yZU5hbWUsIHBhdGgpIHtcbiAgICBzdG9yZXNbc3RvcmVOYW1lXSA9IF9fc3RvcmVzX19bc3RvcmVOYW1lXVxuICAgICAgLl9zZWxlY3Qoc3RhdGUgPT4gZ2V0VmFsdWUoc3RhdGUsIHBhdGgpKVxuICAgICAgLnBpcGUoc2tpcCgxKSlcbiAgICAgIC5zdWJzY3JpYmUoZGF0YSA9PiB7XG4gICAgICAgIGFjY1tzdG9yZU5hbWVdID0gZGF0YTtcbiAgICAgICAgc2F2ZSgpO1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBzZXRJbml0aWFsKHN0b3JlTmFtZSwgc3RvcmUsIHBhdGgpIHtcbiAgICBpZiAoc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV0pIHtcbiAgICAgIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ0BQZXJzaXN0U3RhdGUnIH0pO1xuICAgICAgc3RvcmUuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgICByZXR1cm4gc2V0VmFsdWUoc3RhdGUsIHBhdGgsIHN0b3JhZ2VTdGF0ZVtzdG9yZU5hbWVdKTtcbiAgICAgIH0pO1xuICAgICAgaWYgKHN0b3JlLnNldERpcnR5KSB7XG4gICAgICAgIHN0b3JlLnNldERpcnR5KCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY29uc3Qgc3Vic2NyaXB0aW9uID0gcm9vdERpc3BhdGNoZXIuc3Vic2NyaWJlKGFjdGlvbiA9PiB7XG4gICAgaWYgKGFjdGlvbi50eXBlID09PSBBY3Rpb25zLk5FV19TVE9SRSkge1xuICAgICAgbGV0IGN1cnJlbnRTdG9yZU5hbWUgPSBhY3Rpb24ucGF5bG9hZC5zdG9yZS5zdG9yZU5hbWU7XG5cbiAgICAgIGlmIChoYXNFeGNsdWRlICYmIGV4Y2x1ZGUuaW5kZXhPZihjdXJyZW50U3RvcmVOYW1lKSA+IC0xID09PSB0cnVlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKGhhc0luY2x1ZGUpIHtcbiAgICAgICAgY29uc3QgcGF0aCA9IGluY2x1ZGUuZmluZChuYW1lID0+IG5hbWUuaW5kZXhPZihjdXJyZW50U3RvcmVOYW1lKSA+IC0xKTtcbiAgICAgICAgaWYgKCFwYXRoKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGN1cnJlbnRTdG9yZU5hbWUgPSBwYXRoLnNwbGl0KCcuJylbMF07XG4gICAgICAgICAgc2V0SW5pdGlhbChjdXJyZW50U3RvcmVOYW1lLCBhY3Rpb24ucGF5bG9hZC5zdG9yZSwgcGF0aCk7XG4gICAgICAgICAgc3Vic2NyaWJlKGN1cnJlbnRTdG9yZU5hbWUsIHBhdGgpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzZXRJbml0aWFsKGN1cnJlbnRTdG9yZU5hbWUsIGFjdGlvbi5wYXlsb2FkLnN0b3JlLCBjdXJyZW50U3RvcmVOYW1lKTtcbiAgICAgICAgc3Vic2NyaWJlKGN1cnJlbnRTdG9yZU5hbWUsIGN1cnJlbnRTdG9yZU5hbWUpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICBkZXN0cm95KCkge1xuICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICBmb3IgKGxldCBpID0gMCwga2V5cyA9IE9iamVjdC5rZXlzKHN0b3Jlcyk7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHN0b3JlTmFtZSA9IGtleXNbaV07XG4gICAgICAgIHN0b3Jlc1tzdG9yZU5hbWVdLnVuc3Vic2NyaWJlKCk7XG4gICAgICB9XG4gICAgICBzdG9yZXMgPSB7fTtcbiAgICB9LFxuICAgIGNsZWFyKCkge1xuICAgICAgc3RvcmFnZS5jbGVhcigpO1xuICAgIH0sXG4gICAgY2xlYXJTdG9yZShzdG9yZU5hbWU6IHN0cmluZykge1xuICAgICAgY29uc3Qgc3RvcmFnZVN0YXRlID0gZGVzZXJpYWxpemUoc3RvcmFnZS5nZXRJdGVtKGtleSkgfHwgJ3t9Jyk7XG5cbiAgICAgIGlmIChzdG9yYWdlU3RhdGVbc3RvcmVOYW1lXSkge1xuICAgICAgICBkZWxldGUgc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV07XG4gICAgICAgIHN0b3JhZ2Uuc2V0SXRlbShrZXksIHNlcmlhbGl6ZShzdG9yYWdlU3RhdGUpKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG59XG4iXX0=