/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { AkitaPlugin } from '../plugin';
import { QueryEntity } from '../../api/query-entity';
import { BehaviorSubject, merge } from 'rxjs';
import { distinctUntilChanged, map, skip } from 'rxjs/operators';
import { coerceArray, isFunction, isUndefined, toBoolean } from '../../internal/utils';
import { __globalState } from '../../internal/global-state';
/** @type {?} */
export const dirtyCheckDefaultParams = {
    comparator: (head, current) => JSON.stringify(head) !== JSON.stringify(current)
};
/**
 * @template Entity, StoreState
 */
export class DirtyCheckPlugin extends AkitaPlugin {
    /**
     * @param {?} query
     * @param {?=} params
     * @param {?=} _entityId
     */
    constructor(query, params, _entityId) {
        super(query);
        this.query = query;
        this.params = params;
        this._entityId = _entityId;
        this.dirty = new BehaviorSubject(false);
        this.active = false;
        this.isDirty$ = this.dirty.asObservable().pipe(distinctUntilChanged());
        this.params = Object.assign({}, dirtyCheckDefaultParams, params);
        if (this.params.watchProperty) {
            /** @type {?} */
            let watchProp = this.params.watchProperty;
            watchProp = coerceArray(watchProp);
            if (watchProp.includes('entities') && !watchProp.includes('ids') && query instanceof QueryEntity) {
                watchProp.push('ids');
            }
            this.params.watchProperty = watchProp;
        }
    }
    /**
     * @return {?}
     */
    getHead() {
        return this.head;
    }
    /**
     * @return {?}
     */
    activate() {
        this.head = this._getHead();
        /** *
         * if we are tracking specific properties select only the relevant ones
          @type {?} */
        const source = this.params.watchProperty
            ? (/** @type {?} */ (this.params.watchProperty)).map(prop => this.query.select(state => state[prop]).pipe(map(val => ({ val, __akitaKey: prop }))))
            : [this.selectSource(this._entityId)];
        this.subscription = merge(...source)
            .pipe(skip(1))
            .subscribe((currentState) => {
            if (isUndefined(this.head))
                return;
            /** *
             * __akitaKey is used to determine if we are tracking a specific property or a store change
              @type {?} */
            const head = currentState.__akitaKey ? this.head[/** @type {?} */ (currentState.__akitaKey)] : this.head;
            /** @type {?} */
            const compareTo = currentState.__akitaKey ? currentState.val : currentState;
            /** @type {?} */
            const isChange = this.params.comparator(head, compareTo);
            this.updateDirtiness(isChange);
        });
    }
    /**
     * @param {?=} params
     * @return {?}
     */
    reset(params = {}) {
        /** @type {?} */
        let currentValue = this.head;
        if (isFunction(params.updateFn)) {
            if (this.isEntityBased(this._entityId)) {
                currentValue = params.updateFn(this.head, (/** @type {?} */ (this.getQuery())).getEntity(this._entityId));
            }
            else {
                currentValue = params.updateFn(this.head, (/** @type {?} */ (this.getQuery())).getSnapshot());
            }
        }
        /** *
         * If we are watching specific props compare them, if not compare the entire store
          @type {?} */
        const update = this.params.watchProperty ? this.compareProp(currentValue) : this._getHead() !== currentValue;
        if (update) {
            __globalState.setCustomAction({ type: `@DirtyCheck - Revert` });
            this.updateStore(currentValue, this._entityId);
        }
    }
    /**
     * @return {?}
     */
    setHead() {
        if (!this.active) {
            this.activate();
            this.active = true;
        }
        else {
            this.head = this._getHead();
        }
        this.updateDirtiness(false);
        return this;
    }
    /**
     * @return {?}
     */
    isDirty() {
        return toBoolean(this.dirty.value);
    }
    /**
     * @return {?}
     */
    hasHead() {
        return toBoolean(this.getHead());
    }
    /**
     * @return {?}
     */
    destroy() {
        this.head = null;
        this.subscription && this.subscription.unsubscribe();
    }
    /**
     * @param {?} isDirty
     * @return {?}
     */
    updateDirtiness(isDirty) {
        this.dirty.next(isDirty);
    }
    /**
     * @return {?}
     */
    _getHead() {
        /** @type {?} */
        let head = /** @type {?} */ (this.getSource(this._entityId));
        if (this.params.watchProperty) {
            head = (/** @type {?} */ (this.params.watchProperty)).reduce((_head, prop) => {
                _head[prop] = (/** @type {?} */ (head))[prop];
                return _head;
            }, /** @type {?} */ ({}));
        }
        return head;
    }
    /**
     * @param {?} currentState
     * @return {?}
     */
    compareProp(currentState) {
        /** @type {?} */
        const propKeys = Object.keys(currentState);
        /** @type {?} */
        const head = this._getHead();
        return propKeys.some(propKey => currentState[propKey] !== head[propKey]);
    }
}
function DirtyCheckPlugin_tsickle_Closure_declarations() {
    /** @type {?} */
    DirtyCheckPlugin.prototype.head;
    /** @type {?} */
    DirtyCheckPlugin.prototype.dirty;
    /** @type {?} */
    DirtyCheckPlugin.prototype.subscription;
    /** @type {?} */
    DirtyCheckPlugin.prototype.active;
    /** @type {?} */
    DirtyCheckPlugin.prototype.isDirty$;
    /** @type {?} */
    DirtyCheckPlugin.prototype.query;
    /** @type {?} */
    DirtyCheckPlugin.prototype.params;
    /** @type {?} */
    DirtyCheckPlugin.prototype._entityId;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlydHktY2hlY2stcGx1Z2luLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BsdWdpbnMvZGlydHktY2hlY2svZGlydHktY2hlY2stcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFXLE1BQU0sV0FBVyxDQUFDO0FBQ2pELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNyRCxPQUFPLEVBQWMsZUFBZSxFQUFnQixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFdkYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDZCQUE2QixDQUFDOztBQVU1RCxhQUFhLHVCQUF1QixHQUFHO0lBQ3JDLFVBQVUsRUFBRSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7Q0FDaEYsQ0FBQzs7OztBQU1GLE1BQU0sdUJBQXdELFNBQVEsV0FBK0I7Ozs7OztJQVFuRyxZQUFzQixLQUFrQyxFQUFVLE1BQXlCLEVBQVUsU0FBdUI7UUFDMUgsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRE8sVUFBSyxHQUFMLEtBQUssQ0FBNkI7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFtQjtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQWM7cUJBTjVHLElBQUksZUFBZSxDQUFDLEtBQUssQ0FBQztzQkFFekIsS0FBSzt3QkFFVSxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxD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QUFFLENBQUM7S0FDdEQ7Ozs7O0lBRU8sZUFBZSxDQUFDLE9BQWdCO1FBQ3RDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDOzs7OztJQUduQixRQUFROztRQUNkLElBQUksSUFBSSxxQkFBcUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFlLEVBQUM7UUFDMUYsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRTtZQUM3QixJQUFJLEdBQUcsbUJBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFxQyxFQUFDLENBQUMsTUFBTSxDQUMvRCxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRTtnQkFDZCxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsbUJBQUMsSUFBMkIsRUFBQyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNsRCxPQUFPLEtBQUssQ0FBQzthQUNkLG9CQUNELEVBQXlCLEVBQzFCLENBQUM7U0FDSDtRQUNELE9BQU8sSUFBSSxDQUFDOzs7Ozs7SUFHTixXQUFXLENBQUMsWUFBaUM7O1FBQ25ELE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7O1FBQzNDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUU3QixPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7O0NBRTVFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWtpdGFQbHVnaW4sIFF1ZXJpZXMgfSBmcm9tICcuLi9wbHVnaW4nO1xuaW1wb3J0IHsgUXVlcnlFbnRpdHkgfSBmcm9tICcuLi8uLi9hcGkvcXVlcnktZW50aXR5JztcbmltcG9ydCB7IE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCwgU3Vic2NyaXB0aW9uLCBtZXJnZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc2tpcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGNvZXJjZUFycmF5LCBpc0Z1bmN0aW9uLCBpc1VuZGVmaW5lZCwgdG9Cb29sZWFuIH0gZnJvbSAnLi4vLi4vaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHsgRW50aXR5UGFyYW0gfSBmcm9tICcuLi9lbnRpdHktY29sbGVjdGlvbi1wbHVnaW4nO1xuaW1wb3J0IHsgX19nbG9iYWxTdGF0ZSB9IGZyb20gJy4uLy4uL2ludGVybmFsL2dsb2JhbC1zdGF0ZSc7XG5pbXBvcnQgeyBRdWVyeSB9IGZyb20gJy4uLy4uL2FwaS9xdWVyeSc7XG5cbmV4cG9ydCB0eXBlIERpcnR5Q2hlY2tDb21wYXJhdG9yPEVudGl0eT4gPSAoaGVhZDogRW50aXR5LCBjdXJyZW50OiBFbnRpdHkpID0+IGJvb2xlYW47XG5cbmV4cG9ydCB0eXBlIERpcnR5Q2hlY2tQYXJhbXM8U3RvcmVTdGF0ZSA9IGFueT4gPSB7XG4gIGNvbXBhcmF0b3I/OiBEaXJ0eUNoZWNrQ29tcGFyYXRvcjxTdG9yZVN0YXRlPjtcbiAgd2F0Y2hQcm9wZXJ0eT86IGtleW9mIFN0b3JlU3RhdGUgfCAoa2V5b2YgU3RvcmVTdGF0ZSlbXTtcbn07XG5cbmV4cG9ydCBjb25zdCBkaXJ0eUNoZWNrRGVmYXVsdFBhcmFtcyA9IHtcbiAgY29tcGFyYXRvcjogKGhlYWQsIGN1cnJlbnQpID0+IEpTT04uc3RyaW5naWZ5KGhlYWQpICE9PSBKU09OLnN0cmluZ2lmeShjdXJyZW50KVxufTtcblxuZXhwb3J0IHR5cGUgRGlydHlDaGVja1Jlc2V0UGFyYW1zPFN0b3JlU3RhdGUgPSBhbnk+ID0ge1xuICB1cGRhdGVGbj86IFN0b3JlU3RhdGUgfCAoKGhlYWQ6IFN0b3JlU3RhdGUsIGN1cnJlbnQ6IFN0b3JlU3RhdGUpID0+IGFueSk7XG59O1xuXG5leHBvcnQgY2xhc3MgRGlydHlDaGVja1BsdWdpbjxFbnRpdHkgPSBhbnksIFN0b3JlU3RhdGUgPSBhbnk+IGV4dGVuZHMgQWtpdGFQbHVnaW48RW50aXR5LCBTdG9yZVN0YXRlPiB7XG4gIHByaXZhdGUgaGVhZDogU3RvcmVTdGF0ZSB8IFBhcnRpYWw8U3RvcmVTdGF0ZT4gfCBFbnRpdHk7XG4gIHByaXZhdGUgZGlydHkgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KGZhbHNlKTtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBhY3RpdmUgPSBmYWxzZTtcblxuICBpc0RpcnR5JDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMuZGlydHkuYXNPYnNlcnZhYmxlKCkucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcXVlcnk6IFF1ZXJpZXM8RW50aXR5LCBTdG9yZVN0YXRlPiwgcHJpdmF0ZSBwYXJhbXM/OiBEaXJ0eUNoZWNrUGFyYW1zLCBwcml2YXRlIF9lbnRpdHlJZD86IEVudGl0eVBhcmFtKSB7XG4gICAgc3VwZXIocXVlcnkpO1xuICAgIHRoaXMucGFyYW1zID0geyAuLi5kaXJ0eUNoZWNrRGVmYXVsdFBhcmFtcywgLi4ucGFyYW1zIH07XG4gICAgaWYgKHRoaXMucGFyYW1zLndhdGNoUHJvcGVydHkpIHtcbiAgICAgIGxldCB3YXRjaFByb3AgPSB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5O1xuICAgICAgd2F0Y2hQcm9wID0gY29lcmNlQXJyYXkod2F0Y2hQcm9wKTtcbiAgICAgIGlmICh3YXRjaFByb3AuaW5jbHVkZXMoJ2VudGl0aWVzJykgJiYgIXdhdGNoUHJvcC5pbmNsdWRlcygnaWRzJykgJiYgcXVlcnkgaW5zdGFuY2VvZiBRdWVyeUVudGl0eSkge1xuICAgICAgICB3YXRjaFByb3AucHVzaCgnaWRzJyk7XG4gICAgICB9XG4gICAgICB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5ID0gd2F0Y2hQcm9wO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRIZWFkKCkge1xuICAgIHJldHVybiB0aGlzLmhlYWQ7XG4gIH1cblxuICBwcml2YXRlIGFjdGl2YXRlKCkge1xuICAgIHRoaXMuaGVhZCA9IHRoaXMuX2dldEhlYWQoKTtcbiAgICAvKiogaWYgd2UgYXJlIHRyYWNraW5nIHNwZWNpZmljIHByb3BlcnRpZXMgc2VsZWN0IG9ubHkgdGhlIHJlbGV2YW50IG9uZXMgKi9cbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5XG4gICAgICA/ICh0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5IGFzIChrZXlvZiBTdG9yZVN0YXRlKVtdKS5tYXAocHJvcCA9PiB0aGlzLnF1ZXJ5LnNlbGVjdChzdGF0ZSA9PiBzdGF0ZVtwcm9wXSkucGlwZShtYXAodmFsID0+ICh7IHZhbCwgX19ha2l0YUtleTogcHJvcCB9KSkpKVxuICAgICAgOiBbdGhpcy5zZWxlY3RTb3VyY2UodGhpcy5fZW50aXR5SWQpXTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IG1lcmdlKC4uLnNvdXJjZSlcbiAgICAgIC5waXBlKHNraXAoMSkpXG4gICAgICAuc3Vic2NyaWJlKChjdXJyZW50U3RhdGU6IGFueSkgPT4ge1xuICAgICAgICBpZiAoaXNVbmRlZmluZWQodGhpcy5oZWFkKSkgcmV0dXJuO1xuICAgICAgICAvKiogX19ha2l0YUtleSBpcyB1c2VkIHRvIGRldGVybWluZSBpZiB3ZSBhcmUgdHJhY2tpbmcgYSBzcGVjaWZpYyBwcm9wZXJ0eSBvciBhIHN0b3JlIGNoYW5nZSAqL1xuICAgICAgICBjb25zdCBoZWFkID0gY3VycmVudFN0YXRlLl9fYWtpdGFLZXkgPyB0aGlzLmhlYWRbY3VycmVudFN0YXRlLl9fYWtpdGFLZXkgYXMgYW55XSA6IHRoaXMuaGVhZDtcbiAgICAgICAgY29uc3QgY29tcGFyZVRvID0gY3VycmVudFN0YXRlLl9fYWtpdGFLZXkgPyBjdXJyZW50U3RhdGUudmFsIDogY3VycmVudFN0YXRlO1xuICAgICAgICBjb25zdCBpc0NoYW5nZSA9IHRoaXMucGFyYW1zLmNvbXBhcmF0b3IoaGVhZCwgY29tcGFyZVRvKTtcblxuICAgICAgICB0aGlzLnVwZGF0ZURpcnRpbmVzcyhpc0NoYW5nZSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHJlc2V0KHBhcmFtczogRGlydHlDaGVja1Jlc2V0UGFyYW1zID0ge30pIHtcbiAgICBsZXQgY3VycmVudFZhbHVlID0gdGhpcy5oZWFkO1xuICAgIGlmIChpc0Z1bmN0aW9uKHBhcmFtcy51cGRhdGVGbikpIHtcbiAgICAgIGlmICh0aGlzLmlzRW50aXR5QmFzZWQodGhpcy5fZW50aXR5SWQpKSB7XG4gICAgICAgIGN1cnJlbnRWYWx1ZSA9IHBhcmFtcy51cGRhdGVGbih0aGlzLmhlYWQsICh0aGlzLmdldFF1ZXJ5KCkgYXMgUXVlcnlFbnRpdHk8U3RvcmVTdGF0ZSwgRW50aXR5PikuZ2V0RW50aXR5KHRoaXMuX2VudGl0eUlkKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjdXJyZW50VmFsdWUgPSBwYXJhbXMudXBkYXRlRm4odGhpcy5oZWFkLCAodGhpcy5nZXRRdWVyeSgpIGFzIFF1ZXJ5PFN0b3JlU3RhdGU+KS5nZXRTbmFwc2hvdCgpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLyoqIElmIHdlIGFyZSB3YXRjaGluZyBzcGVjaWZpYyBwcm9wcyBjb21wYXJlIHRoZW0sIGlmIG5vdCBjb21wYXJlIHRoZSBlbnRpcmUgc3RvcmUgKi9cbiAgICBjb25zdCB1cGRhdGUgPSB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5ID8gdGhpcy5jb21wYXJlUHJvcChjdXJyZW50VmFsdWUpIDogdGhpcy5fZ2V0SGVhZCgpICE9PSBjdXJyZW50VmFsdWU7XG4gICAgaWYgKHVwZGF0ZSkge1xuICAgICAgX19nbG9iYWxTdGF0ZS5zZXRDdXN0b21BY3Rpb24oeyB0eXBlOiBgQERpcnR5Q2hlY2sgLSBSZXZlcnRgIH0pO1xuICAgICAgdGhpcy51cGRhdGVTdG9yZShjdXJyZW50VmFsdWUsIHRoaXMuX2VudGl0eUlkKTtcbiAgICB9XG4gIH1cblxuICBzZXRIZWFkKCkge1xuICAgIGlmICghdGhpcy5hY3RpdmUpIHtcbiAgICAgIHRoaXMuYWN0aXZhdGUoKTtcbiAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5oZWFkID0gdGhpcy5fZ2V0SGVhZCgpO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZURpcnRpbmVzcyhmYWxzZSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBpc0RpcnR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0b0Jvb2xlYW4odGhpcy5kaXJ0eS52YWx1ZSk7XG4gIH1cblxuICBoYXNIZWFkKCkge1xuICAgIHJldHVybiB0b0Jvb2xlYW4odGhpcy5nZXRIZWFkKCkpO1xuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLmhlYWQgPSBudWxsO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uICYmIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZURpcnRpbmVzcyhpc0RpcnR5OiBib29sZWFuKSB7XG4gICAgdGhpcy5kaXJ0eS5uZXh0KGlzRGlydHkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0SGVhZCgpOiBQYXJ0aWFsPFN0b3JlU3RhdGU+IHwgU3RvcmVTdGF0ZSB7XG4gICAgbGV0IGhlYWQ6IFN0b3JlU3RhdGUgfCBQYXJ0aWFsPFN0b3JlU3RhdGU+ID0gdGhpcy5nZXRTb3VyY2UodGhpcy5fZW50aXR5SWQpIGFzIFN0b3JlU3RhdGU7XG4gICAgaWYgKHRoaXMucGFyYW1zLndhdGNoUHJvcGVydHkpIHtcbiAgICAgIGhlYWQgPSAodGhpcy5wYXJhbXMud2F0Y2hQcm9wZXJ0eSBhcyAoa2V5b2YgU3RvcmVTdGF0ZSlbXSkucmVkdWNlKFxuICAgICAgICAoX2hlYWQsIHByb3ApID0+IHtcbiAgICAgICAgICBfaGVhZFtwcm9wXSA9IChoZWFkIGFzIFBhcnRpYWw8U3RvcmVTdGF0ZT4pW3Byb3BdO1xuICAgICAgICAgIHJldHVybiBfaGVhZDtcbiAgICAgICAgfSxcbiAgICAgICAge30gYXMgUGFydGlhbDxTdG9yZVN0YXRlPlxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGhlYWQ7XG4gIH1cblxuICBwcml2YXRlIGNvbXBhcmVQcm9wKGN1cnJlbnRTdGF0ZTogUGFydGlhbDxTdG9yZVN0YXRlPik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHByb3BLZXlzID0gT2JqZWN0LmtleXMoY3VycmVudFN0YXRlKTtcbiAgICBjb25zdCBoZWFkID0gdGhpcy5fZ2V0SGVhZCgpO1xuXG4gICAgcmV0dXJuIHByb3BLZXlzLnNvbWUocHJvcEtleSA9PiBjdXJyZW50U3RhdGVbcHJvcEtleV0gIT09IGhlYWRbcHJvcEtleV0pO1xuICB9XG59XG4iXX0=