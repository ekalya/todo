/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { pairwise } from 'rxjs/operators';
import { __globalState } from '../../internal/global-state';
import { toBoolean } from '../../internal/utils';
import { AkitaPlugin } from '../plugin';
/**
 * @record
 */
export function StateHistoryParams() { }
function StateHistoryParams_tsickle_Closure_declarations() {
    /** @type {?|undefined} */
    StateHistoryParams.prototype.maxAge;
}
/**
 * @template E, S
 */
export class StateHistoryPlugin extends AkitaPlugin {
    /**
     * @param {?} query
     * @param {?=} params
     * @param {?=} _entityId
     */
    constructor(query, params = {}, _entityId) {
        super(query);
        this.query = query;
        this.params = params;
        this._entityId = _entityId;
        /**
         * Allow skipping an update from outside
         */
        this.skip = false;
        this.history = {
            past: [],
            present: null,
            future: []
        };
        /**
         * Skip the update when redo/undo
         */
        this.skipUpdate = false;
        params.maxAge = toBoolean(params.maxAge) ? params.maxAge : 10;
        this.activate();
    }
    /**
     * @return {?}
     */
    get hasPast() {
        return this.history.past.length > 0;
    }
    /**
     * @return {?}
     */
    get hasFuture() {
        return this.history.future.length > 0;
    }
    /**
     * @return {?}
     */
    activate() {
        this.history.present = this.getSource(this._entityId);
        this.subscription = this.selectSource(this._entityId)
            .pipe(pairwise())
            .subscribe(([past, present]) => {
            if (this.skip) {
                this.skip = false;
                return;
            }
            if (!this.skipUpdate) {
                if (this.history.past.length === this.params.maxAge) {
                    this.history.past = this.history.past.slice(1);
                }
                this.history.past = [...this.history.past, past];
                this.history.present = present;
            }
        });
    }
    /**
     * @return {?}
     */
    undo() {
        if (this.history.past.length > 0) {
            const { past, present, future } = this.history;
            /** @type {?} */
            const previous = past[past.length - 1];
            /** @type {?} */
            const newPast = past.slice(0, past.length - 1);
            this.history.past = newPast;
            this.history.present = previous;
            this.history.future = [present, ...this.history.future];
            this.update();
        }
    }
    /**
     * @return {?}
     */
    redo() {
        if (this.history.future.length > 0) {
            const { past, present, future } = this.history;
            /** @type {?} */
            const next = this.history.future[0];
            /** @type {?} */
            const newFuture = this.history.future.slice(1);
            this.history.past = [...past, present];
            this.history.present = next;
            this.history.future = newFuture;
            this.update('Redo');
        }
    }
    /**
     * @param {?} index
     * @return {?}
     */
    jumpToPast(index) {
        if (index < 0 || index >= this.history.past.length)
            return;
        const { past, future } = this.history;
        /** *
         *
         * const past = [1, 2, 3, 4, 5];
         *
         * newPast = past.slice(0, 2) = [1, 2];
         * present = past[index] = 3;
         * [...past.slice(2 + 1), ...future] = [4, 5];
         *
          @type {?} */
        const newPast = past.slice(0, index);
        /** @type {?} */
        const newFuture = [...past.slice(index + 1), ...future];
        /** @type {?} */
        const newPresent = past[index];
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update();
    }
    /**
     * @param {?} index
     * @return {?}
     */
    jumpToFuture(index) {
        if (index < 0 || index >= this.history.future.length)
            return;
        const { past, future } = this.history;
        /** @type {?} */
        const newPast = [...past, ...future.slice(0, index)];
        /** @type {?} */
        const newPresent = future[index];
        /** @type {?} */
        const newFuture = future.slice(index + 1);
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update('Redo');
    }
    /**
     * @return {?}
     */
    clear() {
        this.history = {
            past: [],
            present: null,
            future: []
        };
    }
    /**
     * @param {?=} clearHistory
     * @return {?}
     */
    destroy(clearHistory = false) {
        if (clearHistory) {
            this.clear();
        }
        this.subscription.unsubscribe();
    }
    /**
     * @return {?}
     */
    ignoreNext() {
        this.skip = true;
    }
    /**
     * @param {?=} action
     * @return {?}
     */
    update(action = 'Undo') {
        this.skipUpdate = true;
        __globalState.setCustomAction({ type: `@StateHistory - ${action}` });
        this.updateStore(this.history.present, this._entityId);
        this.skipUpdate = false;
    }
}
function StateHistoryPlugin_tsickle_Closure_declarations() {
    /**
     * Allow skipping an update from outside
     * @type {?}
     */
    StateHistoryPlugin.prototype.skip;
    /** @type {?} */
    StateHistoryPlugin.prototype.history;
    /**
     * Skip the update when redo/undo
     * @type {?}
     */
    StateHistoryPlugin.prototype.skipUpdate;
    /** @type {?} */
    StateHistoryPlugin.prototype.subscription;
    /** @type {?} */
    StateHistoryPlugin.prototype.query;
    /** @type {?} */
    StateHistoryPlugin.prototype.params;
    /** @type {?} */
    StateHistoryPlugin.prototype._entityId;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtaGlzdG9yeS1wbHVnaW4uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvcGx1Z2lucy9zdGF0ZS1oaXN0b3J5L3N0YXRlLWhpc3RvcnktcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQVUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzVELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFXLE1BQU0sV0FBVyxDQUFDOzs7Ozs7Ozs7Ozs7QUFPakQsTUFBTSx5QkFBNEMsU0FBUSxXQUFpQjs7Ozs7O0lBY3pFLFlBQXNCLEtBQW9CLEVBQVUsU0FBNkIsRUFBRSxFQUFVLFNBQXVCO1FBQ2xILEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQURPLFVBQUssR0FBTCxLQUFLLENBQWU7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUF5QjtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQWM7Ozs7b0JBWnJHLEtBQUs7dUJBRUY7WUFDaEIsSUFBSSxFQUFFLEVBQUU7WUFDUixPQUFPLEVBQUUsSUFBSTtZQUNiLE1BQU0sRUFBRSxFQUFFO1NBQ1g7Ozs7MEJBR29CLEtBQUs7UUFLeEIsTUFBTSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDOUQsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0tBQ2pCOzs7O0lBRUQsSUFBSSxPQUFPO1FBQ1QsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0tBQ3JDOzs7O0lBRUQsSUFBSSxTQUFTO1FBQ1gsT0FB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QUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFMUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDO1FBQzVCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQztRQUNsQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7UUFDaEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUNyQjs7OztJQUVELEtBQUs7UUFDSCxJQUFJLENBQUMsT0FBTyxHQUFHO1lBQ2IsSUFBSSxFQUFFLEVBQUU7WUFDUixPQUFPLEVBQUUsSUFBSTtZQUNiLE1BQU0sRUFBRSxFQUFFO1NBQ1gsQ0FBQztLQUNIOzs7OztJQUVELE9BQU8sQ0FBQyxZQUFZLEdBQUcsS0FBSztRQUMxQixJQUFJLFlBQVksRUFBRTtZQUNoQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDZDtRQUNELElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7S0FDakM7Ozs7SUFFRCxVQUFVO1FBQ1IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7S0FDbEI7Ozs7O0lBRU8sTUFBTSxDQUFDLE1BQU0sR0FBRyxNQUFNO1FBQzVCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLGFBQWEsQ0FBQyxlQUFlLENBQUMsRUFBRSxJQUFJLEVBQUUsbUJBQW1CLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQzs7Q0FFM0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmaWx0ZXIsIHBhaXJ3aXNlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgX19nbG9iYWxTdGF0ZSB9IGZyb20gJy4uLy4uL2ludGVybmFsL2dsb2JhbC1zdGF0ZSc7XG5pbXBvcnQgeyB0b0Jvb2xlYW4gfSBmcm9tICcuLi8uLi9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQgeyBBa2l0YVBsdWdpbiwgUXVlcmllcyB9IGZyb20gJy4uL3BsdWdpbic7XG5pbXBvcnQgeyBFbnRpdHlQYXJhbSB9IGZyb20gJy4uL2VudGl0eS1jb2xsZWN0aW9uLXBsdWdpbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RhdGVIaXN0b3J5UGFyYW1zIHtcbiAgbWF4QWdlPzogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgU3RhdGVIaXN0b3J5UGx1Z2luPEUgPSBhbnksIFMgPSBhbnk+IGV4dGVuZHMgQWtpdGFQbHVnaW48RSwgUz4ge1xuICAvKiogQWxsb3cgc2tpcHBpbmcgYW4gdXBkYXRlIGZyb20gb3V0c2lkZSAqL1xuICBwcml2YXRlIHNraXAgPSBmYWxzZTtcblxuICBwcml2YXRlIGhpc3RvcnkgPSB7XG4gICAgcGFzdDogW10sXG4gICAgcHJlc2VudDogbnVsbCxcbiAgICBmdXR1cmU6IFtdXG4gIH07XG5cbiAgLyoqIFNraXAgdGhlIHVwZGF0ZSB3aGVuIHJlZG8vdW5kbyAqL1xuICBwcml2YXRlIHNraXBVcGRhdGUgPSBmYWxzZTtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHF1ZXJ5OiBRdWVyaWVzPEUsIFM+LCBwcml2YXRlIHBhcmFtczogU3RhdGVIaXN0b3J5UGFyYW1zID0ge30sIHByaXZhdGUgX2VudGl0eUlkPzogRW50aXR5UGFyYW0pIHtcbiAgICBzdXBlcihxdWVyeSk7XG4gICAgcGFyYW1zLm1heEFnZSA9IHRvQm9vbGVhbihwYXJhbXMubWF4QWdlKSA/IHBhcmFtcy5tYXhBZ2UgOiAxMDtcbiAgICB0aGlzLmFjdGl2YXRlKCk7XG4gIH1cblxuICBnZXQgaGFzUGFzdCgpIHtcbiAgICByZXR1cm4gdGhpcy5oaXN0b3J5LnBhc3QubGVuZ3RoID4gMDtcbiAgfVxuXG4gIGdldCBoYXNGdXR1cmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeS5mdXR1cmUubGVuZ3RoID4gMDtcbiAgfVxuXG4gIGFjdGl2YXRlKCkge1xuICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gdGhpcy5nZXRTb3VyY2UodGhpcy5fZW50aXR5SWQpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uID0gdGhpcy5zZWxlY3RTb3VyY2UodGhpcy5fZW50aXR5SWQpXG4gICAgICAucGlwZShwYWlyd2lzZSgpKVxuICAgICAgLnN1YnNjcmliZSgoW3Bhc3QsIHByZXNlbnRdKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnNraXApIHtcbiAgICAgICAgICB0aGlzLnNraXAgPSBmYWxzZTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLnNraXBVcGRhdGUpIHtcbiAgICAgICAgICBpZiAodGhpcy5oaXN0b3J5LnBhc3QubGVuZ3RoID09PSB0aGlzLnBhcmFtcy5tYXhBZ2UpIHtcbiAgICAgICAgICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gdGhpcy5oaXN0b3J5LnBhc3Quc2xpY2UoMSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gWy4uLnRoaXMuaGlzdG9yeS5wYXN0LCBwYXN0XTtcbiAgICAgICAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IHByZXNlbnQ7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgdW5kbygpIHtcbiAgICBpZiAodGhpcy5oaXN0b3J5LnBhc3QubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgeyBwYXN0LCBwcmVzZW50LCBmdXR1cmUgfSA9IHRoaXMuaGlzdG9yeTtcbiAgICAgIGNvbnN0IHByZXZpb3VzID0gcGFzdFtwYXN0Lmxlbmd0aCAtIDFdO1xuICAgICAgY29uc3QgbmV3UGFzdCA9IHBhc3Quc2xpY2UoMCwgcGFzdC5sZW5ndGggLSAxKTtcblxuICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBuZXdQYXN0O1xuICAgICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSBwcmV2aW91cztcbiAgICAgIHRoaXMuaGlzdG9yeS5mdXR1cmUgPSBbcHJlc2VudCwgLi4udGhpcy5oaXN0b3J5LmZ1dHVyZV07XG4gICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHJlZG8oKSB7XG4gICAgaWYgKHRoaXMuaGlzdG9yeS5mdXR1cmUubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgeyBwYXN0LCBwcmVzZW50LCBmdXR1cmUgfSA9IHRoaXMuaGlzdG9yeTtcbiAgICAgIGNvbnN0IG5leHQgPSB0aGlzLmhpc3RvcnkuZnV0dXJlWzBdO1xuICAgICAgY29uc3QgbmV3RnV0dXJlID0gdGhpcy5oaXN0b3J5LmZ1dHVyZS5zbGljZSgxKTtcbiAgICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gWy4uLnBhc3QsIHByZXNlbnRdO1xuICAgICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSBuZXh0O1xuICAgICAgdGhpcy5oaXN0b3J5LmZ1dHVyZSA9IG5ld0Z1dHVyZTtcbiAgICAgIHRoaXMudXBkYXRlKCdSZWRvJyk7XG4gICAgfVxuICB9XG5cbiAganVtcFRvUGFzdChpbmRleDogbnVtYmVyKSB7XG4gICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGgpIHJldHVybjtcblxuICAgIGNvbnN0IHsgcGFzdCwgZnV0dXJlIH0gPSB0aGlzLmhpc3Rvcnk7XG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBjb25zdCBwYXN0ID0gWzEsIDIsIDMsIDQsIDVdO1xuICAgICAqXG4gICAgICogbmV3UGFzdCA9IHBhc3Quc2xpY2UoMCwgMikgPSBbMSwgMl07XG4gICAgICogcHJlc2VudCA9IHBhc3RbaW5kZXhdID0gMztcbiAgICAgKiBbLi4ucGFzdC5zbGljZSgyICsgMSksIC4uLmZ1dHVyZV0gPSBbNCwgNV07XG4gICAgICpcbiAgICAgKi9cbiAgICBjb25zdCBuZXdQYXN0ID0gcGFzdC5zbGljZSgwLCBpbmRleCk7XG4gICAgY29uc3QgbmV3RnV0dXJlID0gWy4uLnBhc3Quc2xpY2UoaW5kZXggKyAxKSwgLi4uZnV0dXJlXTtcbiAgICBjb25zdCBuZXdQcmVzZW50ID0gcGFzdFtpbmRleF07XG4gICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBuZXdQYXN0O1xuICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gbmV3UHJlc2VudDtcbiAgICB0aGlzLmhpc3RvcnkuZnV0dXJlID0gbmV3RnV0dXJlO1xuICAgIHRoaXMudXBkYXRlKCk7XG4gIH1cblxuICBqdW1wVG9GdXR1cmUoaW5kZXg6IG51bWJlcikge1xuICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5oaXN0b3J5LmZ1dHVyZS5sZW5ndGgpIHJldHVybjtcblxuICAgIGNvbnN0IHsgcGFzdCwgZnV0dXJlIH0gPSB0aGlzLmhpc3Rvcnk7XG5cbiAgICBjb25zdCBuZXdQYXN0ID0gWy4uLnBhc3QsIC4uLmZ1dHVyZS5zbGljZSgwLCBpbmRleCldO1xuICAgIGNvbnN0IG5ld1ByZXNlbnQgPSBmdXR1cmVbaW5kZXhdO1xuICAgIGNvbnN0IG5ld0Z1dHVyZSA9IGZ1dHVyZS5zbGljZShpbmRleCArIDEpO1xuXG4gICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBuZXdQYXN0O1xuICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gbmV3UHJlc2VudDtcbiAgICB0aGlzLmhpc3RvcnkuZnV0dXJlID0gbmV3RnV0dXJlO1xuICAgIHRoaXMudXBkYXRlKCdSZWRvJyk7XG4gIH1cblxuICBjbGVhcigpIHtcbiAgICB0aGlzLmhpc3RvcnkgPSB7XG4gICAgICBwYXN0OiBbXSxcbiAgICAgIHByZXNlbnQ6IG51bGwsXG4gICAgICBmdXR1cmU6IFtdXG4gICAgfTtcbiAgfVxuXG4gIGRlc3Ryb3koY2xlYXJIaXN0b3J5ID0gZmFsc2UpIHtcbiAgICBpZiAoY2xlYXJIaXN0b3J5KSB7XG4gICAgICB0aGlzLmNsZWFyKCk7XG4gICAgfVxuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBpZ25vcmVOZXh0KCkge1xuICAgIHRoaXMuc2tpcCA9IHRydWU7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZShhY3Rpb24gPSAnVW5kbycpIHtcbiAgICB0aGlzLnNraXBVcGRhdGUgPSB0cnVlO1xuICAgIF9fZ2xvYmFsU3RhdGUuc2V0Q3VzdG9tQWN0aW9uKHsgdHlwZTogYEBTdGF0ZUhpc3RvcnkgLSAke2FjdGlvbn1gIH0pO1xuICAgIHRoaXMudXBkYXRlU3RvcmUodGhpcy5oaXN0b3J5LnByZXNlbnQsIHRoaXMuX2VudGl0eUlkKTtcbiAgICB0aGlzLnNraXBVcGRhdGUgPSBmYWxzZTtcbiAgfVxufVxuIl19