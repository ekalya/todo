/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { BehaviorSubject, ReplaySubject } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { AkitaImmutabilityError, assertDecorator } from '../internal/error';
import { commit, isTransactionInProcess } from '../internal/transaction.internal';
import { isFunction, isPlainObject } from '../internal/utils';
import { deepFreeze } from '../internal/deep-freeze';
import { configKey } from './store-config';
import { __globalState } from '../internal/global-state';
/** *
 * Whether we are in dev mode
  @type {?} */
let __DEV__ = true;
/** @type {?} */
export const __stores__ = {};
/** @enum {number} */
const Actions = {
    NEW_STORE: 0,
    NEW_STATE: 1,
};
export { Actions };
/** @type {?} */
export const rootDispatcher = new ReplaySubject();
/**
 * @param {?} storeName
 * @param {?=} initialState
 * @return {?}
 */
function nextState(storeName, initialState = false) {
    return {
        type: 1 /* NEW_STATE */,
        payload: {
            name: storeName,
            initialState
        }
    };
}
/**
 * Enable production mode to disable objectFreeze
 * @return {?}
 */
export function enableAkitaProdMode() {
    __DEV__ = false;
}
/**
 * @return {?}
 */
export function isDev() {
    return __DEV__;
}
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S
 */
export class Store {
    /**
     *
     * Initial the store with the state
     * @param {?} initialState
     */
    constructor(initialState) {
        /**
         * Whether we are inside transaction *
         */
        this.inTransaction = false;
        this._isPristine = true;
        __globalState.setAction({ type: '@@INIT' });
        __stores__[this.storeName] = this;
        this.setState(() => initialState);
        rootDispatcher.next({
            type: 0 /* NEW_STORE */,
            payload: { store: this }
        });
        isDev() && assertDecorator(this.storeName, this.constructor.name);
    }
    /**
     * @param {?=} loading
     * @return {?}
     */
    setLoading(loading = false) {
        if (loading !== (/** @type {?} */ (this._value())).loading) {
            isDev() && __globalState.setAction({ type: 'Set Loading' });
            this.setState(s => (/** @type {?} */ (Object.assign({}, (/** @type {?} */ (s)), { loading }))));
        }
    }
    /**
     * Update the store's error state.
     * @template T
     * @param {?} error
     * @return {?}
     */
    setError(error) {
        if (error !== (/** @type {?} */ (this._value())).error) {
            isDev() && __globalState.setAction({ type: 'Set Error' });
            this.setState(s => (/** @type {?} */ (Object.assign({}, (/** @type {?} */ (s)), { error }))));
        }
    }
    /**
     * Select a slice from the store
     *
     * \@example
     * this.store.select(state => state.entities)
     *
     * @template R
     * @param {?} project
     * @return {?}
     */
    _select(project) {
        return this.store$.pipe(map(project), distinctUntilChanged());
    }
    /**
     * @return {?}
     */
    _value() {
        return this.storeValue;
    }
    /**
     * @return {?}
     */
    get config() {
        return this.constructor[configKey];
    }
    /**
     * Get the store name
     * @return {?}
     */
    get storeName() {
        return this.config && this.config['storeName'];
    }
    /**
     * @return {?}
     */
    get isPristine() {
        return this._isPristine;
    }
    /**
     * `setState()` is the only way to update a store; It receives a callback function,
     * which gets the current state, and returns a new immutable state,
     * which will be the new value of the store.
     * @param {?} newStateFn
     * @param {?=} _rootDispatcher
     * @return {?}
     */
    setState(newStateFn, _rootDispatcher = true) {
        /** @type {?} */
        const prevState = this._value();
        this.storeValue = __DEV__ ? deepFreeze(newStateFn(this._value())) : newStateFn(this._value());
        if (prevState === this.storeValue) {
            throw new AkitaImmutabilityError(this.storeName);
        }
        if (!this.store) {
            this.store = new BehaviorSubject(this.storeValue);
            rootDispatcher.next(nextState(this.storeName, true));
            return;
        }
        if (isTransactionInProcess()) {
            this.handleTransaction();
            return;
        }
        this.dispatch(this.storeValue, _rootDispatcher);
    }
    /**
     * @param {?} newStateOrId
     * @param {?=} newState
     * @return {?}
     */
    update(newStateOrId, newState) {
        __globalState.setAction({ type: 'Update Store' });
        this.setState(state => {
            /** @type {?} */
            let value = isFunction(newStateOrId) ? newStateOrId(state) : newStateOrId;
            /** @type {?} */
            let merged = Object.assign({}, state, value);
            return isPlainObject(state) ? merged : new (/** @type {?} */ (state)).constructor(merged);
        });
        this.setDirty();
    }
    /**
     * Sets the store to a pristine state.
     * @return {?}
     */
    setPristine() {
        this._isPristine = true;
    }
    /**
     * Sets the store to a dirty state, indicating that it is not pristine.
     * @return {?}
     */
    setDirty() {
        this._isPristine = false;
    }
    /**
     * @param {?} state
     * @param {?=} _rootDispatcher
     * @return {?}
     */
    dispatch(state, _rootDispatcher = true) {
        this.store.next(state);
        if (_rootDispatcher) {
            rootDispatcher.next(nextState(this.storeName));
            isDev() && __globalState.setAction({ type: 'Set State' });
        }
    }
    /**
     * @return {?}
     */
    get store$() {
        return this.store.asObservable();
    }
    /**
     * When the transaction ends dispatch the final value once
     * @return {?}
     */
    watchTransaction() {
        commit().subscribe(() => {
            this.inTransaction = false;
            if (isDev() && !__globalState.skipTransactionMsg) {
                __globalState.setAction({ type: '@Transaction' });
            }
            this.dispatch(this._value());
            __globalState.currentT = [];
            __globalState.skipTransactionMsg = false;
        });
    }
    /**
     * Listen to the transaction stream
     * @return {?}
     */
    handleTransaction() {
        if (!this.inTransaction) {
            this.watchTransaction();
            this.inTransaction = true;
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this === __stores__[this.storeName]) {
            delete __stores__[this.storeName];
        }
    }
}
function Store_tsickle_Closure_declarations() {
    /**
     * Manage the store with BehaviorSubject
     * @type {?}
     */
    Store.prototype.store;
    /**
     * The current state value
     * @type {?}
     */
    Store.prototype.storeValue;
    /**
     * Whether we are inside transaction *
     * @type {?}
     */
    Store.prototype.inTransaction;
    /** @type {?} */
    Store.prototype._isPristine;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvYXBpL3N0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLEVBQUUsZUFBZSxFQUFjLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0QsT0FBTyxFQUFFLHNCQUFzQixFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxNQUFNLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNsRixPQUFPLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsU0FBUyxFQUFzQixNQUFNLGdCQUFnQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7OztBQUd6RCxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUM7O0FBRW5CLGFBQWEsVUFBVSxHQUF3QyxFQUFFLENBQUM7OztJQUdoRSxZQUFTO0lBQ1QsWUFBUzs7OztBQVFYLGFBQWEsY0FBYyxHQUFHLElBQUksYUFBYSxFQUFVLENBQUM7Ozs7OztBQUUxRCxtQkFBbUIsU0FBUyxFQUFFLFlBQVksR0FBRyxLQUFLO0lBQ2hELE9BQU87UUFDTCxJQUFJLG1CQUFtQjtRQUN2QixPQUFPLEVBQUU7WUFDUCxJQUFJLEVBQUUsU0FBUztZQUNmLFlBQVk7U0FDYjtLQUNGLENBQUM7Q0FDSDs7Ozs7QUFLRCxNQUFNO0lBQ0osT0FBTyxHQUFHLEtBQUssQ0FBQztDQUNqQjs7OztBQUVELE1BQU07SUFDSixPQUFPLE9BQU8sQ0FBQztDQUNoQjs7Ozs7O0FBTUQsTUFBTTs7Ozs7O0lBZ0JKLFlBQVksWUFBWTs7Ozs2QkFSQSxLQUFLOzJCQUVQLElBQUk7UUFPeEIsYUFBYSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDbEMsY0FBYyxDQUFDLElBQUksQ0FBQztZQUNsQixJQUFJLG1CQUFtQjtZQUN2QixPQUFPLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO1NBQ3pCLENBQUMsQ0FBQztRQUNILEtBQUssRUFBRSxJQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDbkU7Ozs7O0lBRUQsVUFBVSxDQUFDLE9BQU8sR0FBRyxLQUFLO1FBQ3hCLElBQUksT0FBTyxLQUFLLG1CQUFDLElBQUksQ0FBQyxNQUFNLEVBQThCLEVBQUMsQ0FBQyxPQUFPLEVBQUU7WUFDbkUsS0FBSyxFQUFFLElBQUksYUFBYSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFDO1lBQzVELElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxtQkFBQyxrQkFBSyxtQkFBQyxDQUFXLEVBQUMsSUFBRSxPQUFPLEdBQVMsRUFBQyxDQUFDLENBQUM7U0FDNUQ7S0FDRjs7Ozs7OztJQUtELFFBQVEsQ0FBSSxLQUFRO1FBQ2xCLElBQUksS0FBSyxLQUFLLG1CQUFDLElBQUksQ0FBQyxNQUFNLEVBQXdCLEVBQUMsQ0FBQyxLQUFLLEVBQUU7WUFDekQsS0FBSyxFQUFFLElBQUksYUFBYSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1lBQzFELElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxtQkFBQyxrQkFBSyxtQkFBQyxDQUFXLEVBQUMsSUFBRSxLQUFLLEdBQVMsRUFBQyxDQUFDLENBQUM7U0FDMUQ7S0FDRjs7Ozs7Ozs7Ozs7SUFTRCxPQUFPLENBQUksT0FBd0I7UUFDakMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDckIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUNaLG9CQUFvQixFQUFFLENBQ3ZCLENBQUM7S0FDSDs7OztJQUVELE1BQU07UUFDSixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7S0FDeEI7Ozs7SUFFRCxJQUFJLE1BQU07UUFDUixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7S0FDcEM7Ozs7O0lBS0QsSUFBSSxTQUFTO1FBQ1gsT0FBTyxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7S0FDaEQ7Ozs7SUFFRCxJQUFJLFVBQVU7UUFDWixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7S0FDekI7Ozs7Ozs7OztJQU9ELFFBQVEsQ0FBQyxVQUFxQyxFQUFFLGVBQWUsR0FBRyxJQUFJOztRQUNwRSxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDaEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBRTlGLElBQUksU0FBUyxLQUFLLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDakMsTUFBTSxJQUFJLHNCQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNsRDtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2YsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbEQsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3JELE9BQU87U0FDUjtRQUVELElBQUksc0JBQXNCLEVBQUUsRUFBRTtZQUM1QixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUN6QixPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsZUFBZSxDQUFDLENBQUM7S0FDakQ7Ozs7OztJQVlELE1BQU0sQ0FBQyxZQUFrRixFQUFFLFFBQXFCO1FBQzlHLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFOztZQUNwQixJQUFJLEtBQUssR0FBRyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDOztZQUMxRSxJQUFJLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDN0MsT0FBTyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxtQkFBQyxLQUFZLEVBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDL0UsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0tBQ2pCOzs7OztJQUtELFdBQVc7UUFDVCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztLQUN6Qjs7Ozs7SUFLRCxRQUFRO1FBQ04sSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7S0FDMUI7Ozs7OztJQUVPLFFBQVEsQ0FBQyxLQUFRLEVBQUUsZUFBZSxHQUFHLElBQUk7UUFDL0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkIsSUFBSSxlQUFlLEVBQUU7WUFDbkIsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDL0MsS0FBSyxFQUFFLElBQUksYUFBYSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1NBQzNEOzs7OztRQUdTLE1BQU07UUFDaEIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDOzs7Ozs7SUFNM0IsZ0JBQWdCO1FBQ3RCLE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7WUFDM0IsSUFBSSxLQUFLLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsRUFBRTtnQkFDaEQsYUFBYSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO2FBQ25EO1lBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUM3QixhQUFhLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztZQUM1QixhQUFhLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO1NBQzFDLENBQUMsQ0FBQzs7Ozs7O0lBTUcsaUJBQWlCO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1NBQzNCOzs7OztJQUdLLFdBQVc7UUFDakIsSUFBSSxJQUFJLEtBQUssVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUN2QyxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDbkM7O0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIYXNoTWFwLCBJRCB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQWtpdGFJbW11dGFiaWxpdHlFcnJvciwgYXNzZXJ0RGVjb3JhdG9yIH0gZnJvbSAnLi4vaW50ZXJuYWwvZXJyb3InO1xuaW1wb3J0IHsgY29tbWl0LCBpc1RyYW5zYWN0aW9uSW5Qcm9jZXNzIH0gZnJvbSAnLi4vaW50ZXJuYWwvdHJhbnNhY3Rpb24uaW50ZXJuYWwnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiwgaXNQbGFpbk9iamVjdCB9IGZyb20gJy4uL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7IGRlZXBGcmVlemUgfSBmcm9tICcuLi9pbnRlcm5hbC9kZWVwLWZyZWV6ZSc7XG5pbXBvcnQgeyBjb25maWdLZXksIFN0b3JlQ29uZmlnT3B0aW9ucyB9IGZyb20gJy4vc3RvcmUtY29uZmlnJztcbmltcG9ydCB7IF9fZ2xvYmFsU3RhdGUgfSBmcm9tICcuLi9pbnRlcm5hbC9nbG9iYWwtc3RhdGUnO1xuXG4vKiogV2hldGhlciB3ZSBhcmUgaW4gZGV2IG1vZGUgKi9cbmxldCBfX0RFVl9fID0gdHJ1ZTtcblxuZXhwb3J0IGNvbnN0IF9fc3RvcmVzX186IHsgW3N0b3JlTmFtZTogc3RyaW5nXTogU3RvcmU8YW55PiB9ID0ge307XG5cbmV4cG9ydCBjb25zdCBlbnVtIEFjdGlvbnMge1xuICBORVdfU1RPUkUsXG4gIE5FV19TVEFURVxufVxuXG5leHBvcnQgdHlwZSBBY3Rpb24gPSB7XG4gIHR5cGU6IEFjdGlvbnM7XG4gIHBheWxvYWQ6IEhhc2hNYXA8YW55Pjtcbn07XG5cbmV4cG9ydCBjb25zdCByb290RGlzcGF0Y2hlciA9IG5ldyBSZXBsYXlTdWJqZWN0PEFjdGlvbj4oKTtcblxuZnVuY3Rpb24gbmV4dFN0YXRlKHN0b3JlTmFtZSwgaW5pdGlhbFN0YXRlID0gZmFsc2UpIHtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiBBY3Rpb25zLk5FV19TVEFURSxcbiAgICBwYXlsb2FkOiB7XG4gICAgICBuYW1lOiBzdG9yZU5hbWUsXG4gICAgICBpbml0aWFsU3RhdGVcbiAgICB9XG4gIH07XG59XG5cbi8qKlxuICogRW5hYmxlIHByb2R1Y3Rpb24gbW9kZSB0byBkaXNhYmxlIG9iamVjdEZyZWV6ZVxuICovXG5leHBvcnQgZnVuY3Rpb24gZW5hYmxlQWtpdGFQcm9kTW9kZSgpIHtcbiAgX19ERVZfXyA9IGZhbHNlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNEZXYoKSB7XG4gIHJldHVybiBfX0RFVl9fO1xufVxuXG4vKipcbiAqIFRoZSBSb290IFN0b3JlIHRoYXQgZXZlcnkgc3ViIHN0b3JlIG5lZWRzIHRvIGluaGVyaXQgYW5kXG4gKiBpbnZva2UgYHN1cGVyYCB3aXRoIHRoZSBpbml0aWFsIHN0YXRlLlxuICovXG5leHBvcnQgY2xhc3MgU3RvcmU8Uz4ge1xuICAvKiogTWFuYWdlIHRoZSBzdG9yZSB3aXRoIEJlaGF2aW9yU3ViamVjdCAqL1xuICBwcml2YXRlIHN0b3JlOiBCZWhhdmlvclN1YmplY3Q8UmVhZG9ubHk8Uz4+O1xuXG4gIC8qKiBUaGUgY3VycmVudCBzdGF0ZSB2YWx1ZSAqL1xuICBwcml2YXRlIHN0b3JlVmFsdWU6IFM7XG5cbiAgLyoqIFdoZXRoZXIgd2UgYXJlIGluc2lkZSB0cmFuc2FjdGlvbiAqKi9cbiAgcHJpdmF0ZSBpblRyYW5zYWN0aW9uID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBfaXNQcmlzdGluZSA9IHRydWU7XG5cbiAgLyoqXG4gICAqXG4gICAqIEluaXRpYWwgdGhlIHN0b3JlIHdpdGggdGhlIHN0YXRlXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihpbml0aWFsU3RhdGUpIHtcbiAgICBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdAQElOSVQnIH0pO1xuICAgIF9fc3RvcmVzX19bdGhpcy5zdG9yZU5hbWVdID0gdGhpcztcbiAgICB0aGlzLnNldFN0YXRlKCgpID0+IGluaXRpYWxTdGF0ZSk7XG4gICAgcm9vdERpc3BhdGNoZXIubmV4dCh7XG4gICAgICB0eXBlOiBBY3Rpb25zLk5FV19TVE9SRSxcbiAgICAgIHBheWxvYWQ6IHsgc3RvcmU6IHRoaXMgfVxuICAgIH0pO1xuICAgIGlzRGV2KCkgJiYgYXNzZXJ0RGVjb3JhdG9yKHRoaXMuc3RvcmVOYW1lLCB0aGlzLmNvbnN0cnVjdG9yLm5hbWUpO1xuICB9XG5cbiAgc2V0TG9hZGluZyhsb2FkaW5nID0gZmFsc2UpIHtcbiAgICBpZiAobG9hZGluZyAhPT0gKHRoaXMuX3ZhbHVlKCkgYXMgUyAmIHsgbG9hZGluZzogYm9vbGVhbiB9KS5sb2FkaW5nKSB7XG4gICAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1NldCBMb2FkaW5nJyB9KTtcbiAgICAgIHRoaXMuc2V0U3RhdGUocyA9PiAoeyAuLi4ocyBhcyBvYmplY3QpLCBsb2FkaW5nIH0gYXMgYW55KSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB0aGUgc3RvcmUncyBlcnJvciBzdGF0ZS5cbiAgICovXG4gIHNldEVycm9yPFQ+KGVycm9yOiBUKSB7XG4gICAgaWYgKGVycm9yICE9PSAodGhpcy5fdmFsdWUoKSBhcyBTICYgeyBlcnJvcjogYW55IH0pLmVycm9yKSB7XG4gICAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1NldCBFcnJvcicgfSk7XG4gICAgICB0aGlzLnNldFN0YXRlKHMgPT4gKHsgLi4uKHMgYXMgb2JqZWN0KSwgZXJyb3IgfSBhcyBhbnkpKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IGEgc2xpY2UgZnJvbSB0aGUgc3RvcmVcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5zZWxlY3Qoc3RhdGUgPT4gc3RhdGUuZW50aXRpZXMpXG4gICAqXG4gICAqL1xuICBfc2VsZWN0PFI+KHByb2plY3Q6IChzdG9yZTogUykgPT4gUik6IE9ic2VydmFibGU8Uj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlJC5waXBlKFxuICAgICAgbWFwKHByb2plY3QpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICk7XG4gIH1cblxuICBfdmFsdWUoKTogUyB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmVWYWx1ZTtcbiAgfVxuXG4gIGdldCBjb25maWcoKTogU3RvcmVDb25maWdPcHRpb25zIHtcbiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvcltjb25maWdLZXldO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgc3RvcmUgbmFtZVxuICAgKi9cbiAgZ2V0IHN0b3JlTmFtZSgpIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWcgJiYgdGhpcy5jb25maWdbJ3N0b3JlTmFtZSddO1xuICB9XG5cbiAgZ2V0IGlzUHJpc3RpbmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lzUHJpc3RpbmU7XG4gIH1cblxuICAvKipcbiAgICogYHNldFN0YXRlKClgIGlzIHRoZSBvbmx5IHdheSB0byB1cGRhdGUgYSBzdG9yZTsgSXQgcmVjZWl2ZXMgYSBjYWxsYmFjayBmdW5jdGlvbixcbiAgICogd2hpY2ggZ2V0cyB0aGUgY3VycmVudCBzdGF0ZSwgYW5kIHJldHVybnMgYSBuZXcgaW1tdXRhYmxlIHN0YXRlLFxuICAgKiB3aGljaCB3aWxsIGJlIHRoZSBuZXcgdmFsdWUgb2YgdGhlIHN0b3JlLlxuICAgKi9cbiAgc2V0U3RhdGUobmV3U3RhdGVGbjogKHN0YXRlOiBSZWFkb25seTxTPikgPT4gUywgX3Jvb3REaXNwYXRjaGVyID0gdHJ1ZSkge1xuICAgIGNvbnN0IHByZXZTdGF0ZSA9IHRoaXMuX3ZhbHVlKCk7XG4gICAgdGhpcy5zdG9yZVZhbHVlID0gX19ERVZfXyA/IGRlZXBGcmVlemUobmV3U3RhdGVGbih0aGlzLl92YWx1ZSgpKSkgOiBuZXdTdGF0ZUZuKHRoaXMuX3ZhbHVlKCkpO1xuXG4gICAgaWYgKHByZXZTdGF0ZSA9PT0gdGhpcy5zdG9yZVZhbHVlKSB7XG4gICAgICB0aHJvdyBuZXcgQWtpdGFJbW11dGFiaWxpdHlFcnJvcih0aGlzLnN0b3JlTmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnN0b3JlKSB7XG4gICAgICB0aGlzLnN0b3JlID0gbmV3IEJlaGF2aW9yU3ViamVjdCh0aGlzLnN0b3JlVmFsdWUpO1xuICAgICAgcm9vdERpc3BhdGNoZXIubmV4dChuZXh0U3RhdGUodGhpcy5zdG9yZU5hbWUsIHRydWUpKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaXNUcmFuc2FjdGlvbkluUHJvY2VzcygpKSB7XG4gICAgICB0aGlzLmhhbmRsZVRyYW5zYWN0aW9uKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5kaXNwYXRjaCh0aGlzLnN0b3JlVmFsdWUsIF9yb290RGlzcGF0Y2hlcik7XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgaXMgYSBzaG9ydGN1dCBmb3IgYHNldFN0YXRlKClgLlxuICAgKiBJdCBjYW4gYmUgdXNlZnVsIHdoZW4geW91IHdhbnQgdG8gcGFzcyB0aGUgd2hvbGUgc3RhdGUgb2JqZWN0IGluc3RlYWQgb2YgbWVyZ2luZyBhIHBhcnRpYWwgc3RhdGUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlKG5ld1N0YXRlKVxuICAgKi9cbiAgdXBkYXRlKG5ld1N0YXRlOiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKG5ld1N0YXRlOiAoc3RhdGU6IFJlYWRvbmx5PFM+KSA9PiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKGlkOiBJRCB8IElEW10gfCBudWxsLCBuZXdTdGF0ZTogUGFydGlhbDxTPik7XG4gIHVwZGF0ZShuZXdTdGF0ZU9ySWQ6IFBhcnRpYWw8Uz4gfCBJRCB8IElEW10gfCBudWxsIHwgKChzdGF0ZTogUmVhZG9ubHk8Uz4pID0+IFBhcnRpYWw8Uz4pLCBuZXdTdGF0ZT86IFBhcnRpYWw8Uz4pIHtcbiAgICBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdVcGRhdGUgU3RvcmUnIH0pO1xuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgbGV0IHZhbHVlID0gaXNGdW5jdGlvbihuZXdTdGF0ZU9ySWQpID8gbmV3U3RhdGVPcklkKHN0YXRlKSA6IG5ld1N0YXRlT3JJZDtcbiAgICAgIGxldCBtZXJnZWQgPSBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSwgdmFsdWUpO1xuICAgICAgcmV0dXJuIGlzUGxhaW5PYmplY3Qoc3RhdGUpID8gbWVyZ2VkIDogbmV3IChzdGF0ZSBhcyBhbnkpLmNvbnN0cnVjdG9yKG1lcmdlZCk7XG4gICAgfSk7XG4gICAgdGhpcy5zZXREaXJ0eSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIHN0b3JlIHRvIGEgcHJpc3RpbmUgc3RhdGUuXG4gICAqL1xuICBzZXRQcmlzdGluZSgpIHtcbiAgICB0aGlzLl9pc1ByaXN0aW5lID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBzdG9yZSB0byBhIGRpcnR5IHN0YXRlLCBpbmRpY2F0aW5nIHRoYXQgaXQgaXMgbm90IHByaXN0aW5lLlxuICAgKi9cbiAgc2V0RGlydHkoKSB7XG4gICAgdGhpcy5faXNQcmlzdGluZSA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNwYXRjaChzdGF0ZTogUywgX3Jvb3REaXNwYXRjaGVyID0gdHJ1ZSkge1xuICAgIHRoaXMuc3RvcmUubmV4dChzdGF0ZSk7XG4gICAgaWYgKF9yb290RGlzcGF0Y2hlcikge1xuICAgICAgcm9vdERpc3BhdGNoZXIubmV4dChuZXh0U3RhdGUodGhpcy5zdG9yZU5hbWUpKTtcbiAgICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnU2V0IFN0YXRlJyB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldCBzdG9yZSQoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICAvKipcbiAgICogV2hlbiB0aGUgdHJhbnNhY3Rpb24gZW5kcyBkaXNwYXRjaCB0aGUgZmluYWwgdmFsdWUgb25jZVxuICAgKi9cbiAgcHJpdmF0ZSB3YXRjaFRyYW5zYWN0aW9uKCkge1xuICAgIGNvbW1pdCgpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLmluVHJhbnNhY3Rpb24gPSBmYWxzZTtcbiAgICAgIGlmIChpc0RldigpICYmICFfX2dsb2JhbFN0YXRlLnNraXBUcmFuc2FjdGlvbk1zZykge1xuICAgICAgICBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdAVHJhbnNhY3Rpb24nIH0pO1xuICAgICAgfVxuICAgICAgdGhpcy5kaXNwYXRjaCh0aGlzLl92YWx1ZSgpKTtcbiAgICAgIF9fZ2xvYmFsU3RhdGUuY3VycmVudFQgPSBbXTtcbiAgICAgIF9fZ2xvYmFsU3RhdGUuc2tpcFRyYW5zYWN0aW9uTXNnID0gZmFsc2U7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdGVuIHRvIHRoZSB0cmFuc2FjdGlvbiBzdHJlYW1cbiAgICovXG4gIHByaXZhdGUgaGFuZGxlVHJhbnNhY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLmluVHJhbnNhY3Rpb24pIHtcbiAgICAgIHRoaXMud2F0Y2hUcmFuc2FjdGlvbigpO1xuICAgICAgdGhpcy5pblRyYW5zYWN0aW9uID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzID09PSBfX3N0b3Jlc19fW3RoaXMuc3RvcmVOYW1lXSkge1xuICAgICAgZGVsZXRlIF9fc3RvcmVzX19bdGhpcy5zdG9yZU5hbWVdO1xuICAgIH1cbiAgfVxufVxuIl19