/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { combineLatest } from 'rxjs';
import { auditTime, map, switchMap, withLatestFrom } from 'rxjs/operators';
import { compareValues } from '../internal/sort';
import { entityExists, isFunction, isUndefined, toBoolean } from '../internal/utils';
import { memoizeOne } from './memoize';
import { Query } from './query';
/**
 * @record
 * @template E
 */
export function SelectOptions() { }
function SelectOptions_tsickle_Closure_declarations() {
    /** @type {?|undefined} */
    SelectOptions.prototype.asObject;
    /** @type {?|undefined} */
    SelectOptions.prototype.filterBy;
    /** @type {?|undefined} */
    SelectOptions.prototype.limitTo;
}
// unsupported: template constraints.
/**
 *  An abstraction for querying the entities from the store
 * @template S, E
 */
export class QueryEntity extends Query {
    /**
     * @param {?} store
     */
    constructor(store) {
        super(store);
        this.__store__ = store;
    }
    /**
     * @param {?=} options
     * @return {?}
     */
    selectAll(options = {
        asObject: false
    }) {
        /** @type {?} */
        const selectState$ = this.select(state => state);
        /** @type {?} */
        const selectEntities$ = this.select(state => state.entities);
        options.sortBy = options.sortBy || (this.config && (/** @type {?} */ (this.config.sortBy)));
        options.sortByOrder = options.sortByOrder || (this.config && this.config.sortByOrder);
        return selectEntities$.pipe(withLatestFrom(selectState$, (entities, state) => {
            const { ids } = state;
            if (options.asObject) {
                return toMap(ids, entities, options);
            }
            else {
                if (!options.filterBy && !options.sortBy) {
                    if (!this.memoized) {
                        this.memoized = memoizeOne(toArray);
                    }
                    return this.memoized(state, options);
                }
                return toArray(state, options);
            }
        }));
    }
    /**
     * @param {?=} options
     * @return {?}
     */
    getAll(options = { asObject: false, filterBy: undefined, limitTo: undefined }) {
        /** @type {?} */
        const state = this.getSnapshot();
        if (options.asObject) {
            return toMap(state.ids, state.entities, options, true);
        }
        return toArray(state, options);
    }
    /**
     * Select multiple entities from the store.
     *
     * \@example
     * this.store.selectMany([1,2]);
     * @param {?} ids
     * @param {?=} options
     * @return {?}
     */
    selectMany(ids, options = {}) {
        /** @type {?} */
        const filterUndefined = isUndefined(options.filterUndefined) ? true : options.filterUndefined;
        /** @type {?} */
        const entities = ids.map(id => this.selectEntity(id));
        return combineLatest(entities).pipe(map(entities => {
            return filterUndefined ? entities.filter(val => !isUndefined(val)) : entities;
        }), auditTime(0));
    }
    /**
     * @template R
     * @param {?} id
     * @param {?=} project
     * @return {?}
     */
    selectEntity(id, project) {
        if (!project) {
            return this._byId(id);
        }
        return this.select(state => {
            if (this.hasEntity(id)) {
                return project(this.getEntity(id));
            }
            return undefined;
        });
    }
    /**
     * Get an entity by id
     *
     * \@example
     * this.store.getEntity(1);
     * @param {?} id
     * @return {?}
     */
    getEntity(id) {
        return this.getSnapshot().entities[id];
    }
    /**
     * Select the active entity's id.
     * @return {?}
     */
    selectActiveId() {
        return this.select(state => (/** @type {?} */ (state)).active);
    }
    /**
     * Get the active id
     * @return {?}
     */
    getActiveId() {
        return (/** @type {?} */ (this.getSnapshot())).active;
    }
    /**
     * @template R
     * @param {?=} project
     * @return {?}
     */
    selectActive(project) {
        return this.selectActiveId().pipe(switchMap(activeId => this.selectEntity(activeId, project)));
    }
    /**
     * Get the active entity.
     * @return {?}
     */
    getActive() {
        /** @type {?} */
        const activeId = this.getActiveId();
        return toBoolean(activeId) ? this.getEntity(activeId) : undefined;
    }
    /**
     * Select the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    selectCount(predicate) {
        if (isFunction(predicate)) {
            return this.selectAll({
                filterBy: predicate
            }).pipe(map(entities => entities.length));
        }
        return this.select(store => store.ids.length);
    }
    /**
     * Get the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    getCount(predicate) {
        if (isFunction(predicate)) {
            return this.getAll().filter(predicate).length;
        }
        return this.getSnapshot().ids.length;
    }
    /**
     * @param {?} projectOrId
     * @return {?}
     */
    hasEntity(projectOrId) {
        if (isFunction(projectOrId)) {
            return this.getAll().some(projectOrId);
        }
        return projectOrId in this.store.entities;
    }
    /**
     * @return {?}
     */
    isEmpty() {
        return this.getSnapshot().ids.length === 0;
    }
    /**
     * @param {?} id
     * @return {?}
     */
    _byId(id) {
        return this.select(state => this.getEntity(id));
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.memoized = null;
    }
}
function QueryEntity_tsickle_Closure_declarations() {
    /** @type {?} */
    QueryEntity.prototype.store;
    /** @type {?} */
    QueryEntity.prototype.memoized;
    /**
     * Use only for internal plugins like Pagination - don't use this property *
     * @type {?}
     */
    QueryEntity.prototype.__store__;
}
/**
 * @template E, S
 * @param {?} state
 * @param {?} options
 * @return {?}
 */
function toArray(state, options) {
    /** @type {?} */
    let arr = [];
    const { ids, entities } = state;
    const { filterBy, limitTo, sortBy, sortByOrder } = options;
    for (let i = 0; i < ids.length; i++) {
        /** @type {?} */
        const id = ids[i];
        if (!entityExists(id, entities)) {
            continue;
        }
        if (!filterBy) {
            arr.push(entities[id]);
            continue;
        }
        if (filterBy(entities[id])) {
            arr.push(entities[id]);
        }
    }
    if (sortBy) {
        /** @type {?} */
        let _sortBy = isFunction(sortBy) ? sortBy : compareValues(sortBy, sortByOrder);
        arr = arr.sort((a, b) => _sortBy(a, b, state));
    }
    /** @type {?} */
    const length = Math.min(limitTo || arr.length, arr.length);
    return length === arr.length ? arr : arr.slice(0, length);
}
/**
 * @template E
 * @param {?} ids
 * @param {?} entities
 * @param {?} options
 * @param {?=} get
 * @return {?}
 */
function toMap(ids, entities, options, get = false) {
    /** @type {?} */
    const map = {};
    const { filterBy, limitTo } = options;
    if (get && !filterBy && !limitTo) {
        return entities;
    }
    /** @type {?} */
    const length = Math.min(limitTo || ids.length, ids.length);
    if (filterBy && isUndefined(limitTo) === false) {
        /** @type {?} */
        let count = 0;
        for (let i = 0, length = ids.length; i < length; i++) {
            if (count === limitTo)
                break;
            /** @type {?} */
            const id = ids[i];
            if (!entityExists(id, entities)) {
                continue;
            }
            if (filterBy(entities[id])) {
                map[id] = entities[id];
                count++;
            }
        }
    }
    else {
        for (let i = 0; i < length; i++) {
            /** @type {?} */
            const id = ids[i];
            if (!entityExists(id, entities)) {
                continue;
            }
            if (!filterBy) {
                map[id] = entities[id];
                continue;
            }
            if (toBoolean(filterBy(entities[id]))) {
                map[id] = entities[id];
            }
        }
    }
    return map;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktZW50aXR5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL2FwaS9xdWVyeS1lbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxhQUFhLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNFLE9BQU8sRUFBRSxhQUFhLEVBQVMsTUFBTSxrQkFBa0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFckYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN2QyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBYWhDLE1BQU0sa0JBQTZDLFNBQVEsS0FBUTs7OztJQU9qRSxZQUFZLEtBQXdCO1FBQ2xDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNiLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO0tBQ3hCOzs7OztJQWNELFNBQVMsQ0FDUCxVQUE0QjtRQUMxQixRQUFRLEVBQUUsS0FBSztLQUNoQjs7UUFFRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7O1FBQ2pELE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFN0QsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxtQkFBQyxJQUFJLENBQUMsTUFBTSxDQUFD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QUNWO1lBRUQsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDYixHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN2QixTQUFTO2FBQ1Y7WUFFRCxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDckMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUN4QjtTQUNGO0tBQ0Y7SUFFRCxPQUFPLEdBQUcsQ0FBQztDQUNaIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgYXVkaXRUaW1lLCBtYXAsIHN3aXRjaE1hcCwgd2l0aExhdGVzdEZyb20gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IGNvbXBhcmVWYWx1ZXMsIE9yZGVyIH0gZnJvbSAnLi4vaW50ZXJuYWwvc29ydCc7XG5pbXBvcnQgeyBlbnRpdHlFeGlzdHMsIGlzRnVuY3Rpb24sIGlzVW5kZWZpbmVkLCB0b0Jvb2xlYW4gfSBmcm9tICcuLi9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQgeyBFbnRpdHlTdG9yZSB9IGZyb20gJy4vZW50aXR5LXN0b3JlJztcbmltcG9ydCB7IG1lbW9pemVPbmUgfSBmcm9tICcuL21lbW9pemUnO1xuaW1wb3J0IHsgUXVlcnkgfSBmcm9tICcuL3F1ZXJ5JztcbmltcG9ydCB7IFNvcnRCeSwgU29ydEJ5T3B0aW9ucyB9IGZyb20gJy4vcXVlcnktY29uZmlnJztcbmltcG9ydCB7IEFjdGl2ZVN0YXRlLCBFbnRpdHlTdGF0ZSwgSGFzaE1hcCwgSUQgfSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGludGVyZmFjZSBTZWxlY3RPcHRpb25zPEU+IGV4dGVuZHMgU29ydEJ5T3B0aW9uczxFPiB7XG4gIGFzT2JqZWN0PzogYm9vbGVhbjtcbiAgZmlsdGVyQnk/OiAoKGVudGl0eTogRSkgPT4gYm9vbGVhbikgfCB1bmRlZmluZWQ7XG4gIGxpbWl0VG8/OiBudW1iZXI7XG59XG5cbi8qKlxuICogIEFuIGFic3RyYWN0aW9uIGZvciBxdWVyeWluZyB0aGUgZW50aXRpZXMgZnJvbSB0aGUgc3RvcmVcbiAqL1xuZXhwb3J0IGNsYXNzIFF1ZXJ5RW50aXR5PFMgZXh0ZW5kcyBFbnRpdHlTdGF0ZSwgRT4gZXh0ZW5kcyBRdWVyeTxTPiB7XG4gIHByb3RlY3RlZCBzdG9yZTogRW50aXR5U3RvcmU8UywgRT47XG4gIHByaXZhdGUgbWVtb2l6ZWQ7XG5cbiAgLyoqIFVzZSBvbmx5IGZvciBpbnRlcm5hbCBwbHVnaW5zIGxpa2UgUGFnaW5hdGlvbiAtIGRvbid0IHVzZSB0aGlzIHByb3BlcnR5ICoqL1xuICBfX3N0b3JlX187XG5cbiAgY29uc3RydWN0b3Ioc3RvcmU6IEVudGl0eVN0b3JlPFMsIEU+KSB7XG4gICAgc3VwZXIoc3RvcmUpO1xuICAgIHRoaXMuX19zdG9yZV9fID0gc3RvcmU7XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IHRoZSBlbnRpcmUgc3RvcmUncyBlbnRpdHkgY29sbGVjdGlvbi5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5zZWxlY3RBbGwoKTtcbiAgICovXG4gIHNlbGVjdEFsbChvcHRpb25zOiB7IGFzT2JqZWN0OiB0cnVlOyBmaWx0ZXJCeT86IFNlbGVjdE9wdGlvbnM8RT5bJ2ZpbHRlckJ5J107IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IHVuZGVmaW5lZDsgc29ydEJ5T3JkZXI/OiB1bmRlZmluZWQgfSk6IE9ic2VydmFibGU8SGFzaE1hcDxFPj47XG4gIHNlbGVjdEFsbChvcHRpb25zOiB7IGZpbHRlckJ5OiBTZWxlY3RPcHRpb25zPEU+WydmaWx0ZXJCeSddOyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiBTb3J0Qnk8RT47IHNvcnRCeU9yZGVyPzogT3JkZXIgfSk6IE9ic2VydmFibGU8RVtdPjtcbiAgc2VsZWN0QWxsKG9wdGlvbnM6IHsgYXNPYmplY3Q6IHRydWU7IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IHVuZGVmaW5lZDsgc29ydEJ5T3JkZXI/OiB1bmRlZmluZWQgfSk6IE9ic2VydmFibGU8SGFzaE1hcDxFPj47XG4gIHNlbGVjdEFsbChvcHRpb25zOiB7IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IFNvcnRCeTxFPjsgc29ydEJ5T3JkZXI/OiBPcmRlciB9KTogT2JzZXJ2YWJsZTxFW10+O1xuICBzZWxlY3RBbGwob3B0aW9uczogeyBhc09iamVjdDogZmFsc2U7IGZpbHRlckJ5PzogU2VsZWN0T3B0aW9uczxFPlsnZmlsdGVyQnknXTsgbGltaXRUbz86IG51bWJlcjsgc29ydEJ5PzogU29ydEJ5PEU+OyBzb3J0QnlPcmRlcj86IE9yZGVyIH0pOiBPYnNlcnZhYmxlPEVbXT47XG4gIHNlbGVjdEFsbCgpOiBPYnNlcnZhYmxlPEVbXT47XG4gIHNlbGVjdEFsbChcbiAgICBvcHRpb25zOiBTZWxlY3RPcHRpb25zPEU+ID0ge1xuICAgICAgYXNPYmplY3Q6IGZhbHNlXG4gICAgfVxuICApOiBPYnNlcnZhYmxlPEVbXSB8IEhhc2hNYXA8RT4+IHtcbiAgICBjb25zdCBzZWxlY3RTdGF0ZSQgPSB0aGlzLnNlbGVjdChzdGF0ZSA9PiBzdGF0ZSk7XG4gICAgY29uc3Qgc2VsZWN0RW50aXRpZXMkID0gdGhpcy5zZWxlY3Qoc3RhdGUgPT4gc3RhdGUuZW50aXRpZXMpO1xuXG4gICAgb3B0aW9ucy5zb3J0QnkgPSBvcHRpb25zLnNvcnRCeSB8fCAodGhpcy5jb25maWcgJiYgKHRoaXMuY29uZmlnLnNvcnRCeSBhcyBTb3J0Qnk8RT4pKTtcbiAgICBvcHRpb25zLnNvcnRCeU9yZGVyID0gb3B0aW9ucy5zb3J0QnlPcmRlciB8fCAodGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcuc29ydEJ5T3JkZXIpO1xuXG4gICAgcmV0dXJuIHNlbGVjdEVudGl0aWVzJC5waXBlKFxuICAgICAgd2l0aExhdGVzdEZyb20oc2VsZWN0U3RhdGUkLCAoZW50aXRpZXM6IEhhc2hNYXA8RT4sIHN0YXRlOiBTKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgaWRzIH0gPSBzdGF0ZTtcbiAgICAgICAgaWYgKG9wdGlvbnMuYXNPYmplY3QpIHtcbiAgICAgICAgICByZXR1cm4gdG9NYXAoaWRzLCBlbnRpdGllcywgb3B0aW9ucyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKCFvcHRpb25zLmZpbHRlckJ5ICYmICFvcHRpb25zLnNvcnRCeSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLm1lbW9pemVkKSB7XG4gICAgICAgICAgICAgIHRoaXMubWVtb2l6ZWQgPSBtZW1vaXplT25lKHRvQXJyYXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWVtb2l6ZWQoc3RhdGUsIG9wdGlvbnMpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB0b0FycmF5KHN0YXRlLCBvcHRpb25zKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgZW50aXJlIHN0b3JlJ3MgZW50aXR5IGNvbGxlY3Rpb24uXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuZ2V0QWxsKCk7XG4gICAqL1xuICBnZXRBbGwob3B0aW9uczogeyBhc09iamVjdDogdHJ1ZTsgZmlsdGVyQnk/OiBTZWxlY3RPcHRpb25zPEU+WydmaWx0ZXJCeSddOyBsaW1pdFRvPzogbnVtYmVyIH0pOiBIYXNoTWFwPEU+O1xuICBnZXRBbGwob3B0aW9uczogeyBmaWx0ZXJCeTogU2VsZWN0T3B0aW9uczxFPlsnZmlsdGVyQnknXTsgbGltaXRUbz86IG51bWJlciB9KTogRVtdO1xuICBnZXRBbGwob3B0aW9uczogeyBhc09iamVjdDogdHJ1ZTsgbGltaXRUbz86IG51bWJlciB9KTogSGFzaE1hcDxFPjtcbiAgZ2V0QWxsKG9wdGlvbnM6IHsgbGltaXRUbz86IG51bWJlciB9KTogRVtdO1xuICBnZXRBbGwob3B0aW9uczogeyBhc09iamVjdDogZmFsc2U7IGZpbHRlckJ5PzogU2VsZWN0T3B0aW9uczxFPlsnZmlsdGVyQnknXTsgbGltaXRUbz86IG51bWJlciB9KTogRVtdO1xuICBnZXRBbGwoKTogRVtdO1xuICBnZXRBbGwob3B0aW9uczogU2VsZWN0T3B0aW9uczxFPiA9IHsgYXNPYmplY3Q6IGZhbHNlLCBmaWx0ZXJCeTogdW5kZWZpbmVkLCBsaW1pdFRvOiB1bmRlZmluZWQgfSk6IEVbXSB8IEhhc2hNYXA8RT4ge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5nZXRTbmFwc2hvdCgpO1xuXG4gICAgaWYgKG9wdGlvbnMuYXNPYmplY3QpIHtcbiAgICAgIHJldHVybiB0b01hcChzdGF0ZS5pZHMsIHN0YXRlLmVudGl0aWVzLCBvcHRpb25zLCB0cnVlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdG9BcnJheShzdGF0ZSwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IG11bHRpcGxlIGVudGl0aWVzIGZyb20gdGhlIHN0b3JlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnNlbGVjdE1hbnkoWzEsMl0pO1xuICAgKi9cbiAgc2VsZWN0TWFueShpZHM6IElEW10sIG9wdGlvbnM6IHsgZmlsdGVyVW5kZWZpbmVkPzogYm9vbGVhbiB9ID0ge30pOiBPYnNlcnZhYmxlPEVbXT4ge1xuICAgIGNvbnN0IGZpbHRlclVuZGVmaW5lZCA9IGlzVW5kZWZpbmVkKG9wdGlvbnMuZmlsdGVyVW5kZWZpbmVkKSA/IHRydWUgOiBvcHRpb25zLmZpbHRlclVuZGVmaW5lZDtcbiAgICBjb25zdCBlbnRpdGllcyA9IGlkcy5tYXAoaWQgPT4gdGhpcy5zZWxlY3RFbnRpdHkoaWQpKTtcblxuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KGVudGl0aWVzKS5waXBlKFxuICAgICAgbWFwKGVudGl0aWVzID0+IHtcbiAgICAgICAgcmV0dXJuIGZpbHRlclVuZGVmaW5lZCA/IGVudGl0aWVzLmZpbHRlcih2YWwgPT4gIWlzVW5kZWZpbmVkKHZhbCkpIDogZW50aXRpZXM7XG4gICAgICB9KSxcbiAgICAgIGF1ZGl0VGltZSgwKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IGFuIGVudGl0eSBvciBhIHNsaWNlIG9mIGFuIGVudGl0eS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5wYWdlc1N0b3JlLnNlbGVjdEVudGl0eSgxKVxuICAgKiB0aGlzLnBhZ2VzU3RvcmUuc2VsZWN0RW50aXR5KDEsIGVudGl0eSA9PiBlbnRpdHkuY29uZmlnLmRhdGUpXG4gICAqXG4gICAqL1xuICBzZWxlY3RFbnRpdHk8Uj4oaWQ6IElEKTogT2JzZXJ2YWJsZTxFPjtcbiAgc2VsZWN0RW50aXR5PFI+KGlkOiBJRCwgcHJvamVjdDogKGVudGl0eTogRSkgPT4gUik6IE9ic2VydmFibGU8Uj47XG4gIHNlbGVjdEVudGl0eTxSPihpZDogSUQsIHByb2plY3Q/OiAoZW50aXR5OiBFKSA9PiBSKTogT2JzZXJ2YWJsZTxSIHwgRT4ge1xuICAgIGlmICghcHJvamVjdCkge1xuICAgICAgcmV0dXJuIHRoaXMuX2J5SWQoaWQpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnNlbGVjdChzdGF0ZSA9PiB7XG4gICAgICBpZiAodGhpcy5oYXNFbnRpdHkoaWQpKSB7XG4gICAgICAgIHJldHVybiBwcm9qZWN0KHRoaXMuZ2V0RW50aXR5KGlkKSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFuIGVudGl0eSBieSBpZFxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLmdldEVudGl0eSgxKTtcbiAgICovXG4gIGdldEVudGl0eShpZDogSUQpOiBFIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTbmFwc2hvdCgpLmVudGl0aWVzW2lkXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWxlY3QgdGhlIGFjdGl2ZSBlbnRpdHkncyBpZC5cbiAgICovXG4gIHNlbGVjdEFjdGl2ZUlkKCk6IE9ic2VydmFibGU8SUQ+IHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3Qoc3RhdGUgPT4gKHN0YXRlIGFzIFMgJiBBY3RpdmVTdGF0ZSkuYWN0aXZlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGFjdGl2ZSBpZFxuICAgKi9cbiAgZ2V0QWN0aXZlSWQoKTogSUQge1xuICAgIHJldHVybiAodGhpcy5nZXRTbmFwc2hvdCgpIGFzIFMgJiBBY3RpdmVTdGF0ZSkuYWN0aXZlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCB0aGUgYWN0aXZlIGVudGl0eS5cbiAgICovXG4gIHNlbGVjdEFjdGl2ZTxSPigpOiBPYnNlcnZhYmxlPEU+O1xuICBzZWxlY3RBY3RpdmU8Uj4ocHJvamVjdDogKGVudGl0eTogRSkgPT4gUik6IE9ic2VydmFibGU8Uj47XG4gIHNlbGVjdEFjdGl2ZTxSPihwcm9qZWN0PzogKGVudGl0eTogRSkgPT4gUik6IE9ic2VydmFibGU8UiB8IEU+IHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3RBY3RpdmVJZCgpLnBpcGUoc3dpdGNoTWFwKGFjdGl2ZUlkID0+IHRoaXMuc2VsZWN0RW50aXR5KGFjdGl2ZUlkLCBwcm9qZWN0KSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgYWN0aXZlIGVudGl0eS5cbiAgICovXG4gIGdldEFjdGl2ZSgpOiBFIHtcbiAgICBjb25zdCBhY3RpdmVJZDogSUQgPSB0aGlzLmdldEFjdGl2ZUlkKCk7XG4gICAgcmV0dXJuIHRvQm9vbGVhbihhY3RpdmVJZCkgPyB0aGlzLmdldEVudGl0eShhY3RpdmVJZCkgOiB1bmRlZmluZWQ7XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IHRoZSBzdG9yZSdzIGVudGl0eSBjb2xsZWN0aW9uIGxlbmd0aC5cbiAgICovXG4gIHNlbGVjdENvdW50KHByZWRpY2F0ZT86IChlbnRpdHk6IEUpID0+IGJvb2xlYW4pOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIGlmIChpc0Z1bmN0aW9uKHByZWRpY2F0ZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnNlbGVjdEFsbCh7XG4gICAgICAgIGZpbHRlckJ5OiBwcmVkaWNhdGVcbiAgICAgIH0pLnBpcGUobWFwKGVudGl0aWVzID0+IGVudGl0aWVzLmxlbmd0aCkpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnNlbGVjdChzdG9yZSA9PiBzdG9yZS5pZHMubGVuZ3RoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIHN0b3JlJ3MgZW50aXR5IGNvbGxlY3Rpb24gbGVuZ3RoLlxuICAgKi9cbiAgZ2V0Q291bnQocHJlZGljYXRlPzogKGVudGl0eTogRSkgPT4gYm9vbGVhbik6IG51bWJlciB7XG4gICAgaWYgKGlzRnVuY3Rpb24ocHJlZGljYXRlKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0QWxsKCkuZmlsdGVyKHByZWRpY2F0ZSkubGVuZ3RoO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5nZXRTbmFwc2hvdCgpLmlkcy5sZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB3aGV0aGVyIGVudGl0eSBleGlzdHMuXG4gICAqL1xuICBoYXNFbnRpdHkoaWQ6IElEKTogYm9vbGVhbjtcbiAgaGFzRW50aXR5KHByb2plY3Q6IChlbnRpdHk6IEUpID0+IGJvb2xlYW4pOiBib29sZWFuO1xuICBoYXNFbnRpdHkocHJvamVjdE9ySWQ6IGFueSk6IGJvb2xlYW4ge1xuICAgIGlmIChpc0Z1bmN0aW9uKHByb2plY3RPcklkKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0QWxsKCkuc29tZShwcm9qZWN0T3JJZCk7XG4gICAgfVxuICAgIHJldHVybiBwcm9qZWN0T3JJZCBpbiB0aGlzLnN0b3JlLmVudGl0aWVzO1xuICB9XG5cbiAgaXNFbXB0eSgpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTbmFwc2hvdCgpLmlkcy5sZW5ndGggPT09IDA7XG4gIH1cblxuICBwcml2YXRlIF9ieUlkKGlkOiBJRCk6IE9ic2VydmFibGU8RT4ge1xuICAgIHJldHVybiB0aGlzLnNlbGVjdChzdGF0ZSA9PiB0aGlzLmdldEVudGl0eShpZCkpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5tZW1vaXplZCA9IG51bGw7XG4gIH1cbn1cblxuZnVuY3Rpb24gdG9BcnJheTxFLCBTIGV4dGVuZHMgRW50aXR5U3RhdGU+KHN0YXRlOiBTLCBvcHRpb25zOiBTZWxlY3RPcHRpb25zPEU+KTogRVtdIHtcbiAgbGV0IGFyciA9IFtdO1xuICBjb25zdCB7IGlkcywgZW50aXRpZXMgfSA9IHN0YXRlO1xuICBjb25zdCB7IGZpbHRlckJ5LCBsaW1pdFRvLCBzb3J0QnksIHNvcnRCeU9yZGVyIH0gPSBvcHRpb25zO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgaWQgPSBpZHNbaV07XG5cbiAgICBpZiAoIWVudGl0eUV4aXN0cyhpZCwgZW50aXRpZXMpKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoIWZpbHRlckJ5KSB7XG4gICAgICBhcnIucHVzaChlbnRpdGllc1tpZF0pO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKGZpbHRlckJ5KGVudGl0aWVzW2lkXSkpIHtcbiAgICAgIGFyci5wdXNoKGVudGl0aWVzW2lkXSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHNvcnRCeSkge1xuICAgIGxldCBfc29ydEJ5OiBhbnkgPSBpc0Z1bmN0aW9uKHNvcnRCeSkgPyBzb3J0QnkgOiBjb21wYXJlVmFsdWVzKHNvcnRCeSwgc29ydEJ5T3JkZXIpO1xuICAgIGFyciA9IGFyci5zb3J0KChhLCBiKSA9PiBfc29ydEJ5KGEsIGIsIHN0YXRlKSk7XG4gIH1cbiAgY29uc3QgbGVuZ3RoID0gTWF0aC5taW4obGltaXRUbyB8fCBhcnIubGVuZ3RoLCBhcnIubGVuZ3RoKTtcblxuICByZXR1cm4gbGVuZ3RoID09PSBhcnIubGVuZ3RoID8gYXJyIDogYXJyLnNsaWNlKDAsIGxlbmd0aCk7XG59XG5cbmZ1bmN0aW9uIHRvTWFwPEU+KGlkczogSURbXSwgZW50aXRpZXM6IEhhc2hNYXA8RT4sIG9wdGlvbnM6IFNlbGVjdE9wdGlvbnM8RT4sIGdldCA9IGZhbHNlKTogSGFzaE1hcDxFPiB7XG4gIGNvbnN0IG1hcCA9IHt9O1xuICBjb25zdCB7IGZpbHRlckJ5LCBsaW1pdFRvIH0gPSBvcHRpb25zO1xuXG4gIGlmIChnZXQgJiYgIWZpbHRlckJ5ICYmICFsaW1pdFRvKSB7XG4gICAgcmV0dXJuIGVudGl0aWVzO1xuICB9XG5cbiAgY29uc3QgbGVuZ3RoID0gTWF0aC5taW4obGltaXRUbyB8fCBpZHMubGVuZ3RoLCBpZHMubGVuZ3RoKTtcblxuICBpZiAoZmlsdGVyQnkgJiYgaXNVbmRlZmluZWQobGltaXRUbykgPT09IGZhbHNlKSB7XG4gICAgbGV0IGNvdW50ID0gMDtcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gaWRzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoY291bnQgPT09IGxpbWl0VG8pIGJyZWFrO1xuICAgICAgY29uc3QgaWQgPSBpZHNbaV07XG4gICAgICBpZiAoIWVudGl0eUV4aXN0cyhpZCwgZW50aXRpZXMpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKGZpbHRlckJ5KGVudGl0aWVzW2lkXSkpIHtcbiAgICAgICAgbWFwW2lkXSA9IGVudGl0aWVzW2lkXTtcbiAgICAgICAgY291bnQrKztcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaWQgPSBpZHNbaV07XG5cbiAgICAgIGlmICghZW50aXR5RXhpc3RzKGlkLCBlbnRpdGllcykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmICghZmlsdGVyQnkpIHtcbiAgICAgICAgbWFwW2lkXSA9IGVudGl0aWVzW2lkXTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmICh0b0Jvb2xlYW4oZmlsdGVyQnkoZW50aXRpZXNbaWRdKSkpIHtcbiAgICAgICAgbWFwW2lkXSA9IGVudGl0aWVzW2lkXTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gbWFwO1xufVxuIl19