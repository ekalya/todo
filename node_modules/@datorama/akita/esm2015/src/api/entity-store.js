/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { _crud } from '../internal/crud';
import { AkitaImmutabilityError, assertActive } from '../internal/error';
import { __globalState } from '../internal/global-state';
import { coerceArray, entityExists, isFunction, toBoolean } from '../internal/utils';
import { isDev, Store } from './store';
// unsupported: template constraints.
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S, E
 */
export class EntityStore extends Store {
    /**
     *
     * Initiate the store with the state
     * @param {?=} initialState
     * @param {?=} options
     */
    constructor(initialState = {}, options = {}) {
        super(Object.assign({}, getInitialEntitiesState(), initialState));
        this.options = options;
    }
    /**
     * @return {?}
     */
    get entities() {
        return this._value().entities;
    }
    /**
     * @return {?}
     */
    get idKey() {
        /** *
         * backward compatibility
          @type {?} */
        const newIdKey = this.config && this.config.idKey;
        if (!newIdKey) {
            return this.options.idKey || 'id';
        }
        return newIdKey;
    }
    /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     * this.store.set([Entity, Entity]);
     * this.store.set({1: Entity, 2: Entity});
     * this.store.set([{id: 1}, {id: 2}], { entityClass: Product });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    set(entities, options = {}) {
        isDev() && __globalState.setAction({ type: 'Set Entities' });
        this.setState(state => _crud._set(state, entities, options.entityClass, this.idKey));
        this.setDirty();
    }
    /**
     * Create or replace an entity in the store.
     *
     * \@example
     * this.store.createOrReplace(3, Entity);
     *
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    createOrReplace(id, entity) {
        if (!entityExists(id, this._value().entities)) {
            if (!entity[this.idKey]) {
                entity[this.idKey] = id;
            }
            return this.add(entity);
        }
        isDev() && __globalState.setAction({ type: 'Upsert Entity', entityId: [id] });
        this.setState(state => _crud._replaceEntity(state, id, entity));
    }
    /**
     * Add an entity or entities to the store.
     *
     * \@example
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity);
     * @param {?} entities
     * @return {?}
     */
    add(entities) {
        /** @type {?} */
        const toArray = coerceArray(entities);
        if (toArray.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Add Entity' });
        this.setState(state => _crud._add(state, toArray, this.idKey));
    }
    /**
     * @param {?} idsOrFn
     * @param {?=} newStateOrFn
     * @return {?}
     */
    update(idsOrFn, newStateOrFn) {
        /** @type {?} */
        let ids = [];
        /** @type {?} */
        const storeIds = this._value().ids;
        if (isFunction(idsOrFn)) {
            for (let i = 0, len = storeIds.length; i < len; i++) {
                /** @type {?} */
                const id = storeIds[i];
                /** @type {?} */
                const entity = this._value().entities[id];
                if (entity && (/** @type {?} */ (idsOrFn))(entity)) {
                    ids.push(id);
                }
            }
        }
        else {
            ids = toBoolean(idsOrFn) ? coerceArray(idsOrFn) : storeIds;
        }
        if (ids.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Update Entity', entityId: ids });
        this.setState(state => {
            return _crud._update(state, ids, newStateOrFn, this.idKey);
        });
    }
    /**
     * An alias to update all.
     * @param {?} state
     * @return {?}
     */
    updateAll(state) {
        if (this._value().ids.length === 0)
            return;
        this.update(null, state);
    }
    /**
     * Update the root state (data which is external to the entities).
     *
     * \@example
     * this.store.updateRoot({
     *   metadata: 'new metadata
     * });
     *
     *  this.store.updateRoot(state => {
     *    return {
     *      metadata: {
     *        ...state.metadata,
     *        key: 'new value'
     *      }
     *    }
     *  });
     * @param {?} newStateFn
     * @param {?=} action
     * @return {?}
     */
    updateRoot(newStateFn, action) {
        /** @type {?} */
        const newState = isFunction(newStateFn) ? newStateFn(this._value()) : newStateFn;
        if (newState === this._value()) {
            throw new AkitaImmutabilityError(this.storeName);
        }
        isDev() && __globalState.setAction(action || { type: 'Update Root' });
        this.setState(state => {
            return Object.assign({}, (/** @type {?} */ (state)), (/** @type {?} */ (newState)));
        });
    }
    /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    remove(idsOrFn) {
        /** @type {?} */
        const storeIds = this._value().ids;
        if (storeIds.length === 0)
            return;
        /** @type {?} */
        const idPassed = toBoolean(idsOrFn);
        if (!idPassed)
            this.setPristine();
        /** @type {?} */
        let ids = [];
        if (isFunction(idsOrFn)) {
            for (let i = 0, len = storeIds.length; i < len; i++) {
                /** @type {?} */
                const id = storeIds[i];
                /** @type {?} */
                const entity = this._value().entities[id];
                if (entity && idsOrFn(entity)) {
                    ids.push(id);
                }
            }
        }
        else {
            ids = idPassed ? coerceArray(idsOrFn) : null;
        }
        if (ids && ids.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Remove Entity', entityId: ids });
        this.setState(state => {
            return _crud._remove(state, ids);
        });
    }
    /**
     *
     * Update the active entity.
     *
     * \@example
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateFn
     * @return {?}
     */
    updateActive(newStateFn) {
        assertActive(this._value());
        isDev() && __globalState.setAction({ type: 'Update Active Entity', entityId: this._value()["active"] });
        this.setState(state => {
            /** @type {?} */
            const activeId = state["active"];
            /** @type {?} */
            const newState = isFunction(newStateFn) ? newStateFn(state.entities[activeId]) : newStateFn;
            if (newState === state) {
                throw new AkitaImmutabilityError(this.storeName);
            }
            return _crud._update(state, [activeId], newState, this.idKey);
        });
    }
    /**
     * Set the given entity as active.
     * @param {?} id
     * @return {?}
     */
    setActive(id) {
        if (id === this._value()["active"])
            return;
        isDev() && __globalState.setAction({ type: 'Set Active Entity', entityId: id });
        this.setState(state => {
            return Object.assign({}, (/** @type {?} */ (state)), { active: id });
        });
    }
}
function EntityStore_tsickle_Closure_declarations() {
    /** @type {?} */
    EntityStore.prototype.options;
}
/** @type {?} */
export const getInitialEntitiesState = () => (/** @type {?} */ ({
    entities: {},
    ids: [],
    loading: true,
    error: null
}));
/** @type {?} */
export const getInitialActiveState = () => (/** @type {?} */ ({
    active: null
}));

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LXN0b3JlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL2FwaS9lbnRpdHktc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN6QyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDekUsT0FBTyxFQUFVLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRixPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQzs7Ozs7OztBQU92QyxNQUFNLGtCQUFnRCxTQUFRLEtBQVE7Ozs7Ozs7SUFLcEUsWUFBWSxZQUFZLEdBQUcsRUFBRSxFQUFVLFVBQThCLEVBQUU7UUFDckUsS0FBSyxtQkFBTSx1QkFBdUIsRUFBRSxFQUFLLFlBQVksRUFBRyxDQUFDO1FBRHBCLFlBQU8sR0FBUCxPQUFPLENBQXlCO0tBRXRFOzs7O0lBRUQsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDO0tBQy9COzs7O0lBRUQsSUFBSSxLQUFLOzs7O1FBRVAsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNsRCxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUM7U0FDbkM7UUFDRCxPQUFPLFFBQVEsQ0FBQztLQUNqQjs7Ozs7Ozs7Ozs7Ozs7SUFZRCxHQUFHLENBQUMsUUFBd0MsRUFBRSxVQUF3QyxFQUFFO1FBQ3RGLEtBQUssRUFBRSxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDckYsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0tBQ2pCOzs7Ozs7Ozs7OztJQVNELGVBQWUsQ0FBQyxFQUFNLEVBQUUsTUFBUztRQUMvQixJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDN0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ3ZCLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO2FBQ3pCO1lBQ0QsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3pCO1FBQ0QsS0FBSyxFQUFFLElBQUksYUFBYSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlFLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztLQUNqRTs7Ozs7Ozs7OztJQVNELEdBQUcsQ0FBQyxRQUFpQjs7UUFDbkIsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTztRQUNqQyxLQUFLLEVBQUUsSUFBSSxhQUFhLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQU8sS0FBSyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztLQUN0RTs7Ozs7O0lBeUNELE1BQU0sQ0FDSixPQUFrSCxFQUNsSCxZQUE4RTs7UUFFOUUsSUFBSSxHQUFHLEdBQVMsRUFBRSxDQUFDOztRQUNuQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDO1FBRW5DLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3ZCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7O2dCQUNuRCxNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7O2dCQUN2QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUMxQyxJQUFJLE1BQU0sSUFBSSxtQkFBQyxPQUFtQixFQUFDLENBQUMsTUFBTSxDQUFDLEVBQUU7b0JBQzNDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ2Q7YUFDRjtTQUNGO2FBQU07WUFDTCxHQUFHLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztTQUM1RDtRQUVELElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTztRQUM3QixLQUFLLEVBQUUsSUFBSSxhQUFhLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUU3RSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3BCLE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDNUQsQ0FBQyxDQUFDO0tBQ0o7Ozs7OztJQUtELFNBQVMsQ0FBQyxLQUFpQjtRQUN6QixJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUM7WUFBRSxPQUFPO1FBQzNDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQzFCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFtQkQsVUFBVSxDQUFDLFVBQTZELEVBQUUsTUFBZTs7UUFDdkYsTUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztRQUVqRixJQUFJLFFBQVEsS0FBSyxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDOUIsTUFBTSxJQUFJLHNCQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNsRDtRQUVELEtBQUssRUFBRSxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsTUFBTSxJQUFJLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUM7UUFFdEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNwQix5QkFDSyxtQkFBQyxLQUFZLEVBQUMsRUFDZCxtQkFBQyxRQUFlLEVBQUMsRUFDcEI7U0FDSCxDQUFDLENBQUM7S0FDSjs7Ozs7SUFjRCxNQUFNLENBQUMsT0FBd0Q7O1FBQzdELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUM7UUFFbkMsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUM7WUFBRSxPQUFPOztRQUNsQyxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLFFBQVE7WUFBRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7O1FBRWxDLElBQUksR0FBRyxHQUFTLEVBQUUsQ0FBQztRQUNuQixJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUN2QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFOztnQkFDbkQsTUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDOztnQkFDdkIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDMUMsSUFBSSxNQUFNLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO29CQUM3QixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUNkO2FBQ0Y7U0FDRjthQUFNO1lBQ0wsR0FBRyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7U0FDOUM7UUFFRCxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUM7WUFBRSxPQUFPO1FBQ3BDLEtBQUssRUFBRSxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBRTdFLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDcEIsT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztTQUNsQyxDQUFDLENBQUM7S0FDSjs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFnQkQsWUFBWSxDQUFDLFVBQThEO1FBQ3pFLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUM1QixLQUFLLEVBQUUsSUFBSSxhQUFhLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLHNCQUFzQixFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLFVBQU8sRUFBRSxDQUFDLENBQUM7UUFDckcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTs7WUFDcEIsTUFBTSxRQUFRLEdBQUcsS0FBSyxXQUFROztZQUM5QixNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztZQUM1RixJQUFJLFFBQVEsS0FBSyxLQUFLLEVBQUU7Z0JBQ3RCLE1BQU0sSUFBSSxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDbEQ7WUFDRCxPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMvRCxDQUFDLENBQUM7S0FDSjs7Ozs7O0lBS0QsU0FBUyxDQUFDLEVBQU07UUFDZCxJQUFJLEVBQUUsS0FBSyxJQUFJLENBQUMsTUFBTSxFQUFFLFVBQU87WUFBRSxPQUFPO1FBQ3hDLEtBQUssRUFBRSxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsbUJBQW1CLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDaEYsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNwQix5QkFDSyxtQkFBQyxLQUFZLEVBQUMsSUFDakIsTUFBTSxFQUFFLEVBQUUsSUFDVjtTQUNILENBQUMsQ0FBQztLQUNKO0NBQ0Y7Ozs7OztBQUVELGFBQWEsdUJBQXVCLEdBQUcsR0FBRyxFQUFFLENBQzFDLG1CQUFDO0lBQ0MsUUFBUSxFQUFFLEVBQUU7SUFDWixHQUFHLEVBQUUsRUFBRTtJQUNQLE9BQU8sRUFBRSxJQUFJO0lBQ2IsS0FBSyxFQUFFLElBQUk7Q0FDRyxFQUFDLENBQUM7O0FBRXBCLGFBQWEscUJBQXFCLEdBQUcsR0FBRyxFQUFFLENBQ3hDLG1CQUFDO0lBQ0MsTUFBTSxFQUFFLElBQUk7Q0FDRSxFQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBfY3J1ZCB9IGZyb20gJy4uL2ludGVybmFsL2NydWQnO1xuaW1wb3J0IHsgQWtpdGFJbW11dGFiaWxpdHlFcnJvciwgYXNzZXJ0QWN0aXZlIH0gZnJvbSAnLi4vaW50ZXJuYWwvZXJyb3InO1xuaW1wb3J0IHsgQWN0aW9uLCBfX2dsb2JhbFN0YXRlIH0gZnJvbSAnLi4vaW50ZXJuYWwvZ2xvYmFsLXN0YXRlJztcbmltcG9ydCB7IGNvZXJjZUFycmF5LCBlbnRpdHlFeGlzdHMsIGlzRnVuY3Rpb24sIHRvQm9vbGVhbiB9IGZyb20gJy4uL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7IGlzRGV2LCBTdG9yZSB9IGZyb20gJy4vc3RvcmUnO1xuaW1wb3J0IHsgQWN0aXZlU3RhdGUsIEVudGl0aWVzLCBFbnRpdHlTdGF0ZSwgSGFzaE1hcCwgSUQsIE5ld2FibGUgfSBmcm9tICcuL3R5cGVzJztcblxuLyoqXG4gKiBUaGUgUm9vdCBTdG9yZSB0aGF0IGV2ZXJ5IHN1YiBzdG9yZSBuZWVkcyB0byBpbmhlcml0IGFuZFxuICogaW52b2tlIGBzdXBlcmAgd2l0aCB0aGUgaW5pdGlhbCBzdGF0ZS5cbiAqL1xuZXhwb3J0IGNsYXNzIEVudGl0eVN0b3JlPFMgZXh0ZW5kcyBFbnRpdHlTdGF0ZTxFPiwgRT4gZXh0ZW5kcyBTdG9yZTxTPiB7XG4gIC8qKlxuICAgKlxuICAgKiBJbml0aWF0ZSB0aGUgc3RvcmUgd2l0aCB0aGUgc3RhdGVcbiAgICovXG4gIGNvbnN0cnVjdG9yKGluaXRpYWxTdGF0ZSA9IHt9LCBwcml2YXRlIG9wdGlvbnM6IHsgaWRLZXk/OiBzdHJpbmcgfSA9IHt9KSB7XG4gICAgc3VwZXIoeyAuLi5nZXRJbml0aWFsRW50aXRpZXNTdGF0ZSgpLCAuLi5pbml0aWFsU3RhdGUgfSk7XG4gIH1cblxuICBnZXQgZW50aXRpZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlKCkuZW50aXRpZXM7XG4gIH1cblxuICBnZXQgaWRLZXkoKSB7XG4gICAgLyoqIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgKi9cbiAgICBjb25zdCBuZXdJZEtleSA9IHRoaXMuY29uZmlnICYmIHRoaXMuY29uZmlnLmlkS2V5O1xuICAgIGlmICghbmV3SWRLZXkpIHtcbiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaWRLZXkgfHwgJ2lkJztcbiAgICB9XG4gICAgcmV0dXJuIG5ld0lkS2V5O1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFJlcGxhY2UgY3VycmVudCBjb2xsZWN0aW9uIHdpdGggcHJvdmlkZWQgY29sbGVjdGlvblxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnNldChbRW50aXR5LCBFbnRpdHldKTtcbiAgICogdGhpcy5zdG9yZS5zZXQoezE6IEVudGl0eSwgMjogRW50aXR5fSk7XG4gICAqIHRoaXMuc3RvcmUuc2V0KFt7aWQ6IDF9LCB7aWQ6IDJ9XSwgeyBlbnRpdHlDbGFzczogUHJvZHVjdCB9KTtcbiAgICpcbiAgICovXG4gIHNldChlbnRpdGllczogRVtdIHwgSGFzaE1hcDxFPiB8IEVudGl0aWVzPEU+LCBvcHRpb25zOiB7IGVudGl0eUNsYXNzPzogTmV3YWJsZTxFPiB9ID0ge30pIHtcbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1NldCBFbnRpdGllcycgfSk7XG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiBfY3J1ZC5fc2V0KHN0YXRlLCBlbnRpdGllcywgb3B0aW9ucy5lbnRpdHlDbGFzcywgdGhpcy5pZEtleSkpO1xuICAgIHRoaXMuc2V0RGlydHkoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgb3IgcmVwbGFjZSBhbiBlbnRpdHkgaW4gdGhlIHN0b3JlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLmNyZWF0ZU9yUmVwbGFjZSgzLCBFbnRpdHkpO1xuICAgKlxuICAgKi9cbiAgY3JlYXRlT3JSZXBsYWNlKGlkOiBJRCwgZW50aXR5OiBFKSB7XG4gICAgaWYgKCFlbnRpdHlFeGlzdHMoaWQsIHRoaXMuX3ZhbHVlKCkuZW50aXRpZXMpKSB7XG4gICAgICBpZiAoIWVudGl0eVt0aGlzLmlkS2V5XSkge1xuICAgICAgICBlbnRpdHlbdGhpcy5pZEtleV0gPSBpZDtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLmFkZChlbnRpdHkpO1xuICAgIH1cbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1Vwc2VydCBFbnRpdHknLCBlbnRpdHlJZDogW2lkXSB9KTtcbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IF9jcnVkLl9yZXBsYWNlRW50aXR5KHN0YXRlLCBpZCwgZW50aXR5KSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGFuIGVudGl0eSBvciBlbnRpdGllcyB0byB0aGUgc3RvcmUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuYWRkKFtFbnRpdHksIEVudGl0eV0pO1xuICAgKiB0aGlzLnN0b3JlLmFkZChFbnRpdHkpO1xuICAgKi9cbiAgYWRkKGVudGl0aWVzOiBFW10gfCBFKSB7XG4gICAgY29uc3QgdG9BcnJheSA9IGNvZXJjZUFycmF5KGVudGl0aWVzKTtcbiAgICBpZiAodG9BcnJheS5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ0FkZCBFbnRpdHknIH0pO1xuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4gX2NydWQuX2FkZDxTLCBFPihzdGF0ZSwgdG9BcnJheSwgdGhpcy5pZEtleSkpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwZGF0ZSBhbiBlbnRpdHkgb3IgZW50aXRpZXMgaW4gdGhlIHN0b3JlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZSgzLCB7XG4gICAqICAgbmFtZTogJ05ldyBOYW1lJ1xuICAgKiB9KTtcbiAgICpcbiAgICogIHRoaXMuc3RvcmUudXBkYXRlKDMsIGVudGl0eSA9PiB7XG4gICAqICAgIHJldHVybiB7XG4gICAqICAgICAgY29uZmlnOiB7XG4gICAqICAgICAgICAuLi5lbnRpdHkuZmlsdGVyLFxuICAgKiAgICAgICAgZGF0ZVxuICAgKiAgICAgIH1cbiAgICogICAgfVxuICAgKiAgfSk7XG4gICAqXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlKFsxLDIsM10sIHtcbiAgICogICBuYW1lOiAnTmV3IE5hbWUnXG4gICAqIH0pO1xuICAgKlxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZShlID0+IGUubmFtZSA9PT0gJ3ZhbHVlJywge1xuICAgKiAgIG5hbWU6ICdOZXcgTmFtZSdcbiAgICogfSk7XG4gICAqXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlKG51bGwsIHtcbiAgICogICBuYW1lOiAnTmV3IE5hbWUnXG4gICAqIH0pO1xuICAgKlxuICAgKi9cbiAgdXBkYXRlKGlkOiBJRCB8IElEW10gfCBudWxsLCBuZXdTdGF0ZUZuOiAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IFBhcnRpYWw8RT4pKTtcbiAgdXBkYXRlKGlkOiBJRCB8IElEW10gfCBudWxsLCBuZXdTdGF0ZTogUGFydGlhbDxFPik7XG4gIHVwZGF0ZShpZDogSUQgfCBJRFtdIHwgbnVsbCwgbmV3U3RhdGU6IFBhcnRpYWw8Uz4pO1xuICB1cGRhdGUobmV3U3RhdGU6IChzdGF0ZTogUmVhZG9ubHk8Uz4pID0+IFBhcnRpYWw8Uz4pO1xuICB1cGRhdGUocHJlZGljYXRlOiAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IGJvb2xlYW4pLCBuZXdTdGF0ZUZuOiAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IFBhcnRpYWw8RT4pKTtcbiAgdXBkYXRlKHByZWRpY2F0ZTogKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBib29sZWFuKSwgbmV3U3RhdGU6IFBhcnRpYWw8RT4pO1xuICB1cGRhdGUocHJlZGljYXRlOiAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IGJvb2xlYW4pLCBuZXdTdGF0ZTogUGFydGlhbDxTPik7XG4gIHVwZGF0ZShuZXdTdGF0ZTogUGFydGlhbDxTPik7XG4gIHVwZGF0ZShcbiAgICBpZHNPckZuOiBJRCB8IElEW10gfCBudWxsIHwgUGFydGlhbDxTPiB8ICgoc3RhdGU6IFJlYWRvbmx5PFM+KSA9PiBQYXJ0aWFsPFM+KSB8ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gYm9vbGVhbiksXG4gICAgbmV3U3RhdGVPckZuPzogKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBQYXJ0aWFsPEU+KSB8IFBhcnRpYWw8RT4gfCBQYXJ0aWFsPFM+XG4gICkge1xuICAgIGxldCBpZHM6IElEW10gPSBbXTtcbiAgICBjb25zdCBzdG9yZUlkcyA9IHRoaXMuX3ZhbHVlKCkuaWRzO1xuXG4gICAgaWYgKGlzRnVuY3Rpb24oaWRzT3JGbikpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBzdG9yZUlkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICBjb25zdCBpZCA9IHN0b3JlSWRzW2ldO1xuICAgICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLl92YWx1ZSgpLmVudGl0aWVzW2lkXTtcbiAgICAgICAgaWYgKGVudGl0eSAmJiAoaWRzT3JGbiBhcyBGdW5jdGlvbikoZW50aXR5KSkge1xuICAgICAgICAgIGlkcy5wdXNoKGlkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZHMgPSB0b0Jvb2xlYW4oaWRzT3JGbikgPyBjb2VyY2VBcnJheShpZHNPckZuKSA6IHN0b3JlSWRzO1xuICAgIH1cblxuICAgIGlmIChpZHMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdVcGRhdGUgRW50aXR5JywgZW50aXR5SWQ6IGlkcyB9KTtcblxuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIF9jcnVkLl91cGRhdGUoc3RhdGUsIGlkcywgbmV3U3RhdGVPckZuLCB0aGlzLmlkS2V5KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbiBhbGlhcyB0byB1cGRhdGUgYWxsLlxuICAgKi9cbiAgdXBkYXRlQWxsKHN0YXRlOiBQYXJ0aWFsPEU+KSB7XG4gICAgaWYgKHRoaXMuX3ZhbHVlKCkuaWRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgIHRoaXMudXBkYXRlKG51bGwsIHN0YXRlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgdGhlIHJvb3Qgc3RhdGUgKGRhdGEgd2hpY2ggaXMgZXh0ZXJuYWwgdG8gdGhlIGVudGl0aWVzKS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS51cGRhdGVSb290KHtcbiAgICogICBtZXRhZGF0YTogJ25ldyBtZXRhZGF0YVxuICAgKiB9KTtcbiAgICpcbiAgICogIHRoaXMuc3RvcmUudXBkYXRlUm9vdChzdGF0ZSA9PiB7XG4gICAqICAgIHJldHVybiB7XG4gICAqICAgICAgbWV0YWRhdGE6IHtcbiAgICogICAgICAgIC4uLnN0YXRlLm1ldGFkYXRhLFxuICAgKiAgICAgICAga2V5OiAnbmV3IHZhbHVlJ1xuICAgKiAgICAgIH1cbiAgICogICAgfVxuICAgKiAgfSk7XG4gICAqL1xuICB1cGRhdGVSb290KG5ld1N0YXRlRm46ICgoc3RhdGU6IFJlYWRvbmx5PFM+KSA9PiBQYXJ0aWFsPFM+KSB8IFBhcnRpYWw8Uz4sIGFjdGlvbj86IEFjdGlvbikge1xuICAgIGNvbnN0IG5ld1N0YXRlID0gaXNGdW5jdGlvbihuZXdTdGF0ZUZuKSA/IG5ld1N0YXRlRm4odGhpcy5fdmFsdWUoKSkgOiBuZXdTdGF0ZUZuO1xuXG4gICAgaWYgKG5ld1N0YXRlID09PSB0aGlzLl92YWx1ZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgQWtpdGFJbW11dGFiaWxpdHlFcnJvcih0aGlzLnN0b3JlTmFtZSk7XG4gICAgfVxuXG4gICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbihhY3Rpb24gfHwgeyB0eXBlOiAnVXBkYXRlIFJvb3QnIH0pO1xuXG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi4oc3RhdGUgYXMgYW55KSxcbiAgICAgICAgLi4uKG5ld1N0YXRlIGFzIGFueSlcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogUmVtb3ZlIG9uZSBvciBtb3JlIGVudGl0aWVzIGZyb20gdGhlIHN0b3JlOlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnJlbW92ZSg1KTtcbiAgICogdGhpcy5zdG9yZS5yZW1vdmUoWzEsMiwzXSk7XG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKGVudGl0eSA9PiBlbnRpdHkuaWQgPT09IDEpO1xuICAgKiB0aGlzLnN0b3JlLnJlbW92ZSgpO1xuICAgKi9cbiAgcmVtb3ZlKGlkPzogSUQgfCBJRFtdKTtcbiAgcmVtb3ZlKHByZWRpY2F0ZTogKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IGJvb2xlYW4pO1xuICByZW1vdmUoaWRzT3JGbj86IElEIHwgSURbXSB8ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gYm9vbGVhbikpIHtcbiAgICBjb25zdCBzdG9yZUlkcyA9IHRoaXMuX3ZhbHVlKCkuaWRzO1xuXG4gICAgaWYgKHN0b3JlSWRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgIGNvbnN0IGlkUGFzc2VkID0gdG9Cb29sZWFuKGlkc09yRm4pO1xuICAgIGlmICghaWRQYXNzZWQpIHRoaXMuc2V0UHJpc3RpbmUoKTtcblxuICAgIGxldCBpZHM6IElEW10gPSBbXTtcbiAgICBpZiAoaXNGdW5jdGlvbihpZHNPckZuKSkge1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHN0b3JlSWRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGlkID0gc3RvcmVJZHNbaV07XG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuX3ZhbHVlKCkuZW50aXRpZXNbaWRdO1xuICAgICAgICBpZiAoZW50aXR5ICYmIGlkc09yRm4oZW50aXR5KSkge1xuICAgICAgICAgIGlkcy5wdXNoKGlkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZHMgPSBpZFBhc3NlZCA/IGNvZXJjZUFycmF5KGlkc09yRm4pIDogbnVsbDtcbiAgICB9XG5cbiAgICBpZiAoaWRzICYmIGlkcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1JlbW92ZSBFbnRpdHknLCBlbnRpdHlJZDogaWRzIH0pO1xuXG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICByZXR1cm4gX2NydWQuX3JlbW92ZShzdGF0ZSwgaWRzKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBVcGRhdGUgdGhlIGFjdGl2ZSBlbnRpdHkuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlQWN0aXZlKGFjdGl2ZSA9PiB7XG4gICAqICAgcmV0dXJuIHtcbiAgICogICAgIGNvbmZpZzoge1xuICAgKiAgICAgIC4uYWN0aXZlLmNvbmZpZyxcbiAgICogICAgICBkYXRlXG4gICAqICAgICB9XG4gICAqICAgfVxuICAgKiB9KVxuICAgKi9cbiAgdXBkYXRlQWN0aXZlKG5ld1N0YXRlRm46ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gUGFydGlhbDxFPikgfCBQYXJ0aWFsPEU+KSB7XG4gICAgYXNzZXJ0QWN0aXZlKHRoaXMuX3ZhbHVlKCkpO1xuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnVXBkYXRlIEFjdGl2ZSBFbnRpdHknLCBlbnRpdHlJZDogdGhpcy5fdmFsdWUoKS5hY3RpdmUgfSk7XG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICBjb25zdCBhY3RpdmVJZCA9IHN0YXRlLmFjdGl2ZTtcbiAgICAgIGNvbnN0IG5ld1N0YXRlID0gaXNGdW5jdGlvbihuZXdTdGF0ZUZuKSA/IG5ld1N0YXRlRm4oc3RhdGUuZW50aXRpZXNbYWN0aXZlSWRdKSA6IG5ld1N0YXRlRm47XG4gICAgICBpZiAobmV3U3RhdGUgPT09IHN0YXRlKSB7XG4gICAgICAgIHRocm93IG5ldyBBa2l0YUltbXV0YWJpbGl0eUVycm9yKHRoaXMuc3RvcmVOYW1lKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBfY3J1ZC5fdXBkYXRlKHN0YXRlLCBbYWN0aXZlSWRdLCBuZXdTdGF0ZSwgdGhpcy5pZEtleSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBnaXZlbiBlbnRpdHkgYXMgYWN0aXZlLlxuICAgKi9cbiAgc2V0QWN0aXZlKGlkOiBJRCkge1xuICAgIGlmIChpZCA9PT0gdGhpcy5fdmFsdWUoKS5hY3RpdmUpIHJldHVybjtcbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1NldCBBY3RpdmUgRW50aXR5JywgZW50aXR5SWQ6IGlkIH0pO1xuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uKHN0YXRlIGFzIGFueSksXG4gICAgICAgIGFjdGl2ZTogaWRcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGdldEluaXRpYWxFbnRpdGllc1N0YXRlID0gKCkgPT5cbiAgKHtcbiAgICBlbnRpdGllczoge30sXG4gICAgaWRzOiBbXSxcbiAgICBsb2FkaW5nOiB0cnVlLFxuICAgIGVycm9yOiBudWxsXG4gIH0gYXMgRW50aXR5U3RhdGUpO1xuXG5leHBvcnQgY29uc3QgZ2V0SW5pdGlhbEFjdGl2ZVN0YXRlID0gKCkgPT5cbiAgKHtcbiAgICBhY3RpdmU6IG51bGxcbiAgfSBhcyBBY3RpdmVTdGF0ZSk7XG4iXX0=